<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Student Document Portal for iLm Halal Student Halls. Access your documents and shared accommodation information securely.">
  <meta name="robots" content="noindex, nofollow">
  
  <title>Student Document Portal - iLm Halal Student Halls</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189942/web-app-manifest-192x192_wr5wdr.png">
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Fallback check for Supabase loading -->
  <script>
    // Check if Supabase loaded after a short delay
    setTimeout(function() {
      if (typeof window.supabase === 'undefined') {
        console.error('‚ùå Supabase failed to load from CDN');
        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
          loadingState.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #e74c3c;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">üåê</div>
              <h3>Connection Error</h3>
              <p>Unable to load required libraries. This might be due to:</p>
              <ul style="text-align: left; margin: 1rem 0; max-width: 400px; margin-left: auto; margin-right: auto;">
                <li>Internet connection issues</li>
                <li>Firewall or network restrictions</li>
                <li>CDN service interruption</li>
              </ul>
              <div style="margin-top: 2rem;">
                <button onclick="location.reload()" style="padding: 0.75rem 1.5rem; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 1rem;">
                  üîÑ Retry
                </button>
                <a href="index.html" style="padding: 0.75rem 1.5rem; background: #95a5a6; color: white; text-decoration: none; border-radius: 6px;">
                  ‚Üê Back to Home
                </a>
              </div>
              <div style="margin-top: 1rem; font-size: 0.9em; color: #666;">
                Please check your internet connection and try again.
              </div>
            </div>
          `;
        }
      }
    }, 2000); // Check after 2 seconds
  </script>
  
  <style>
    /* Student Portal Specific Styles */
    .portal-container {
      min-height: 100vh;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .portal-header {
      background: white;
      box-shadow: 0 2px 12px rgba(47,41,112,0.06);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(47,41,112,0.08);
    }

    .portal-header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.1rem 0;
      min-height: 78px;
    }

    .portal-logo {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-weight: 700;
      font-size: 1.5rem;
      color: var(--primary-dark);
      text-decoration: none;
    }

    .portal-logo img {
      height: 56px;
      width: 56px;
      border-radius: 50%;
      object-fit: cover;
    }

    .portal-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .student-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      color: var(--primary-dark);
      font-weight: 500;
    }

    .student-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
    }

    .logout-btn {
      background: var(--primary);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s ease;
    }

    .logout-btn:hover {
      background: var(--primary-dark);
    }

    /* Login Form Styles */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }

    .login-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 20px auto;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .login-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .login-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #2c3e50;
    }

    .login-subtitle {
      color: #7f8c8d;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 30px;
      border-radius: 8px;
      overflow: hidden;
      background: #f8f9fa;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      background: #f8f9fa;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .auth-tab.active {
      background: #3498db;
      color: white;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2c3e50;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .auth-btn {
      width: 100%;
      padding: 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-bottom: 20px;
    }

    .auth-btn:hover {
      background: #2980b9;
    }

    .auth-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    .magic-link-info {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 12px;
      text-align: left;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .success-message {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    /* Portal Content Styles */
    .portal-main {
      padding: 2rem 0;
    }

    .welcome-section {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 24px rgba(47,41,112,0.10);
    }

    .welcome-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 0.5rem;
    }

    .welcome-subtitle {
      color: var(--gray);
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    .room-info {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--primary-light);
      color: var(--primary);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
    }

    .documents-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .documents-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(47,41,112,0.10);
      overflow: hidden;
    }

    .section-header {
      background: var(--primary);
      color: white;
      padding: 1.5rem;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .documents-list {
      padding: 1.5rem;
    }

    .document-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .document-item:hover {
      background: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .document-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .document-icon {
      width: 40px;
      height: 40px;
      background: var(--primary-light);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--primary);
    }

    .document-title {
      font-weight: 600;
      color: var(--primary-dark);
      margin-bottom: 0.25rem;
    }

    .document-meta {
      font-size: 0.85rem;
      color: var(--gray);
    }

    .download-btn {
      background: var(--primary);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .download-btn:hover {
      background: var(--primary-dark);
    }

    .no-documents {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--gray);
    }

    .no-documents-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      color: var(--gray);
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile Responsive */
    @media (max-width: 900px) {
      .documents-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .portal-header-content {
        padding: 1rem 0;
      }

      .student-info span {
        display: none;
      }

      .welcome-title {
        font-size: 1.5rem;
      }
    }

    @media (max-width: 600px) {
      .portal-main {
        padding: 1rem 0;
      }

      .welcome-section,
      .documents-list {
        padding: 1rem;
      }

      .document-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .document-info {
        width: 100%;
      }

      .download-btn {
        align-self: flex-end;
      }

      .login-card {
        padding: 30px 20px;
      }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div id="loadingState" class="loading-state portal-container">
    <div class="loading-spinner"></div>
    <span>Loading Student Portal...</span>
  </div>

  <!-- Login Interface -->
  <div id="loginInterface" class="login-container hidden">
    <div class="login-card">
      <div class="login-logo">
        <img src="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189839/473148050_10160452160655951_3047339032063400229_n_gnkdpz.jpg" alt="iLm Halal Student Halls Logo">
      </div>
      
      <h1 class="login-title">Student Portal</h1>
      <p class="login-subtitle">Access your documents and accommodation information</p>

      <!-- Auth Tabs -->
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('email')">Email Login</button>
        <button class="auth-tab" onclick="switchAuthTab('magic')">Magic Link</button>
        <button class="auth-tab" onclick="switchAuthTab('reset')">Reset Password</button>
      </div>

      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>

      <!-- Email/Password Login -->
      <div id="emailLoginForm">
        <form id="loginForm">
          <div class="form-group">
            <label for="email">Student Email</label>
            <input type="email" id="email" name="email" required autocomplete="username" 
                   placeholder="Enter your student email address">
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required autocomplete="current-password"
                   placeholder="Enter your password">
          </div>

          <button type="submit" class="auth-btn" id="loginBtn">
            Sign In to Portal
          </button>
          
          <div style="text-align: center; margin-top: 15px;">
            <a href="#" onclick="switchAuthTab('reset')" style="color: #3498db; text-decoration: none; font-size: 14px;">Forgot Password?</a>
          </div>
        </form>
      </div>

      <!-- Magic Link Login -->
      <div id="magicLinkForm" class="hidden">
        <div class="magic-link-info">
          <strong>Magic Link Login</strong><br>
          Enter your student email address and we'll send you a secure link to access your portal without a password.
        </div>

        <form id="magicForm">
          <div class="form-group">
            <label for="magicEmail">Student Email</label>
            <input type="email" id="magicEmail" name="email" required autocomplete="username"
                   placeholder="Enter your student email address">
          </div>

          <button type="submit" class="auth-btn" id="magicBtn">
            Send Magic Link
          </button>
        </form>
      </div>

      <!-- Password Reset Form -->
      <div id="passwordResetForm" class="hidden">
        <div class="magic-link-info">
          <strong>Reset Your Password</strong><br>
          Enter your student email address and we'll send you a secure link to reset your password.
        </div>

        <form id="resetForm">
          <div class="form-group">
            <label for="resetEmail">Student Email</label>
            <input type="email" id="resetEmail" name="email" required autocomplete="username"
                   placeholder="Enter your student email address">
          </div>

          <button type="submit" class="auth-btn" id="resetBtn">
            Send Reset Link
          </button>
          
          <div style="text-align: center; margin-top: 15px;">
            <a href="#" onclick="switchAuthTab('email')" style="color: #7f8c8d; text-decoration: none; font-size: 14px;">‚Üê Back to Login</a>
          </div>
        </form>
      </div>

      <!-- Set New Password Form -->
      <div id="setNewPasswordForm" class="hidden">
        <div class="magic-link-info">
          <strong>Set New Password</strong><br>
          Enter your new password below to complete the reset process.
        </div>

        <form id="newPasswordForm">
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input type="password" id="newPassword" name="password" required autocomplete="new-password" 
                   minlength="6" placeholder="Enter your new password (min 6 characters)">
          </div>

          <div class="form-group">
            <label for="confirmNewPassword">Confirm New Password</label>
            <input type="password" id="confirmNewPassword" name="confirmPassword" required autocomplete="new-password" 
                   minlength="6" placeholder="Confirm your new password">
          </div>

          <button type="submit" class="auth-btn" id="setPasswordBtn">
            Set New Password
          </button>
          
          <div style="text-align: center; margin-top: 15px;">
            <a href="#" onclick="switchAuthTab('email')" style="color: #7f8c8d; text-decoration: none; font-size: 14px;">‚Üê Back to Login</a>
          </div>
        </form>
      </div>

      <div style="text-align: center; margin-top: 20px;">
        <a href="index.html" style="color: #7f8c8d; text-decoration: none; font-size: 14px;">‚Üê Back to Main Site</a>
      </div>
    </div>
  </div>

  <!-- Portal Interface -->
  <div id="portalInterface" class="portal-container hidden">
    <!-- Header -->
    <header class="portal-header">
      <div class="container portal-header-content">
        <a href="/" class="portal-logo">
          <img src="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189839/473148050_10160452160655951_3047339032063400229_n_gnkdpz.jpg" alt="iLm Logo">
          <span>Student Portal</span>
        </a>
        
        <div class="portal-nav">
          <div class="student-info">
            <div class="student-avatar" id="studentAvatar">S</div>
            <span id="studentName">Student</span>
          </div>
          <button class="logout-btn" onclick="handleLogout()" aria-label="Logout from Student Portal">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="portal-main">
      <div class="container">
        <!-- Welcome Section -->
        <section class="welcome-section">
          <h1 class="welcome-title">Welcome to Your Document Portal</h1>
          <p class="welcome-subtitle">Access your personal documents and shared accommodation information</p>
          <div class="room-info">
            <span>üìç</span>
            <span>Room: <span id="studentRoom">Loading...</span></span>
          </div>
        </section>

        <!-- Documents Grid -->
        <div class="documents-grid">
          <!-- My Documents -->
          <section class="documents-section">
            <div class="section-header">
              üìÑ My Documents
            </div>
            <div class="documents-list" id="myDocuments">
              <div class="loading-state">
                <div class="loading-spinner"></div>
                <span>Loading your documents...</span>
              </div>
            </div>
          </section>

          <!-- Shared Documents -->
          <section class="documents-section">
            <div class="section-header">
              üåê Shared Documents
            </div>
            <div class="documents-list" id="sharedDocuments">
              <div class="loading-state">
                <div class="loading-spinner"></div>
                <span>Loading shared documents...</span>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Add debug logging
    console.log('üîç Student Portal script starting...');
    
    // Check if Supabase is available
    if (typeof window.supabase === 'undefined') {
      console.error('‚ùå Supabase library not loaded');
      document.getElementById('loadingState').innerHTML = '<div style="text-align: center; padding: 3rem; color: #e74c3c;"><div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div><p>Failed to load required libraries. Please refresh the page.</p><button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Refresh Page</button></div>';
    }

    // Student Portal Implementation
    class StudentPortal {
      constructor() {
        try {
          console.log('üèóÔ∏è Constructing StudentPortal...');
          
          // Supabase Configuration
          this.SUPABASE_URL = 'https://nrnbfevlbakvdeaswbbd.supabase.co';
          this.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ybmJmZXZsYmFrdmRlYXN3YmJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MTIzODgsImV4cCI6MjA2NDM4ODM4OH0.3V7rTYNwxSsKA0etRgNgxvUgoULmqvppVtmSY9Hzr3M';
          
          // Initialize Supabase client
          if (typeof window.supabase === 'undefined') {
            throw new Error('Supabase library not available');
          }
          
          this.supabase = window.supabase.createClient(this.SUPABASE_URL, this.SUPABASE_ANON_KEY);
          console.log('‚úÖ Supabase client created');
          
          // State
          this.currentUser = null;
          this.studentData = null;
          this.currentAuthTab = 'email';
          this.isPasswordResetContext = false;
          
          this.init();
        } catch (error) {
          console.error('‚ùå Error in StudentPortal constructor:', error);
          this.showInitError('Failed to initialize Student Portal: ' + error.message);
        }
      }

      showInitError(message) {
        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
          loadingState.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #e74c3c;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
              <p>${message}</p>
              <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Refresh Page
              </button>
              <div style="margin-top: 1rem;">
                <a href="index.html" style="color: #3498db; text-decoration: none;">‚Üê Back to Main Site</a>
              </div>
            </div>
          `;
        }
      }

      async init() {
        try {
          console.log('üöÄ Initializing Student Portal...');
          
          // Set up event listeners
          this.setupEventListeners();
          
          // Check authentication status with timeout
          const authCheckPromise = this.checkAuthStatus();
          const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Authentication check timeout')), 10000)
          );
          
          await Promise.race([authCheckPromise, timeoutPromise]);
          
          console.log('‚úÖ Student Portal initialized');
        } catch (error) {
          console.error('‚ùå Error during initialization:', error);
          if (error.message.includes('timeout')) {
            this.showInitError('Connection timeout. Please check your internet connection and try again.');
          } else {
            this.showInitError('Initialization failed: ' + error.message);
          }
        }
      }

      setupEventListeners() {
        try {
          console.log('üì° Setting up event listeners...');
          
          // Check if elements exist
          const loginForm = document.getElementById('loginForm');
          const magicForm = document.getElementById('magicForm');
          const resetForm = document.getElementById('resetForm');
          const newPasswordForm = document.getElementById('newPasswordForm');
          
          if (!loginForm || !magicForm || !resetForm || !newPasswordForm) {
            throw new Error('Required form elements not found');
          }
          
          // Login form
          loginForm.addEventListener('submit', (e) => this.handleEmailLogin(e));
          
          // Magic link form
          magicForm.addEventListener('submit', (e) => this.handleMagicLink(e));
          
          // Password reset form
          resetForm.addEventListener('submit', (e) => this.handlePasswordReset(e));
          
          // Set new password form
          newPasswordForm.addEventListener('submit', (e) => this.handleSetNewPassword(e));
          
          // Auth state changes
          this.supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event, session?.user?.email, 'Reset context:', this.isPasswordResetContext);
            
            // Check if this is a recovery session (password reset)
            if (event === 'SIGNED_IN' && session?.user) {
              // Check if we're in a password reset context
              if (this.isPasswordResetContext) {
                console.log('üîë Recovery session detected, showing password reset form');
                // Don't call handleAuthSuccess, just ensure the form is shown
                this.showSetNewPasswordForm();
              } else if (window.location.hash.includes('recovery') || window.location.hash.includes('#reset')) {
                console.log('üîë Recovery context detected from URL, showing password reset form');
                this.isPasswordResetContext = true;
                this.showSetNewPasswordForm();
              } else {
                console.log('‚úÖ Normal sign-in, proceeding to portal');
                this.handleAuthSuccess(session.user);
              }
            } else if (event === 'SIGNED_OUT') {
              this.handleAuthSignOut();
              this.isPasswordResetContext = false;
            }
          });
          
          console.log('‚úÖ Event listeners set up');
        } catch (error) {
          console.error('‚ùå Error setting up event listeners:', error);
          throw error;
        }
      }

      async checkAuthStatus() {
        try {
          console.log('üîê Checking authentication status...');
          
          // Check for password reset token first
          const handledResetToken = await this.checkPasswordResetToken();
          
          // If we handled a reset token, don't proceed with normal auth check
          if (handledResetToken) {
            console.log('üîë Reset token handled, skipping normal auth check');
            return;
          }
          
          const { data: { user }, error } = await this.supabase.auth.getUser();
          
          if (error) {
            console.error('Auth check error:', error);
            throw error;
          }
          
          if (user) {
            console.log('‚úÖ User already authenticated:', user.email);
            await this.handleAuthSuccess(user);
          } else {
            console.log('No active session, showing login');
            this.showLogin();
          }
        } catch (error) {
          console.error('‚ùå Error checking auth status:', error);
          this.showLogin();
        }
      }

      async checkPasswordResetToken() {
        // Check URL for reset token parameters
        const urlParams = new URLSearchParams(window.location.search);
        const fragment = window.location.hash;
        
        console.log('üîç Full URL:', window.location.href);
        console.log('üîç Hash fragment:', fragment);
        
        // Parse tokens using multiple methods
        let accessToken = urlParams.get('access_token') || this.getTokenFromHash('access_token');
        let refreshToken = urlParams.get('refresh_token') || this.getTokenFromHash('refresh_token');
        let type = urlParams.get('type') || this.getTokenFromHash('type');
        
        // Fallback: Parse directly from the full hash if standard methods fail
        if (!accessToken && fragment.includes('access_token=')) {
          const tokenMatch = fragment.match(/access_token=([^&]+)/);
          if (tokenMatch) accessToken = tokenMatch[1];
        }
        
        if (!refreshToken && fragment.includes('refresh_token=')) {
          const tokenMatch = fragment.match(/refresh_token=([^&]+)/);
          if (tokenMatch) refreshToken = tokenMatch[1];
        }
        
        if (!type && fragment.includes('type=')) {
          const typeMatch = fragment.match(/type=([^&]+)/);
          if (typeMatch) type = typeMatch[1];
        }
        
        console.log('üîç Checking for reset token...', { 
          accessToken: !!accessToken, 
          refreshToken: !!refreshToken, 
          type,
          accessTokenLength: accessToken ? accessToken.length : 0,
          fullHash: fragment 
        });
        
        if (accessToken && type === 'recovery') {
          try {
            console.log('üîë Password reset token found, setting session...');
            console.log('üîë Access token preview:', accessToken.substring(0, 50) + '...');
            
            // Set the password reset context flag BEFORE setting the session
            this.isPasswordResetContext = true;
            
            // Set the session with the tokens from the email link
            const { data, error } = await this.supabase.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken
            });
            
            if (error) throw error;
            
            if (data.user) {
              console.log('‚úÖ Reset session established for:', data.user.email);
              
              // Show the new password form
              this.showSetNewPasswordForm();
              
              // Clean up the URL
              window.history.replaceState({}, document.title, window.location.pathname);
              return true; // Indicate that we handled a reset token
            }
            
          } catch (error) {
            console.error('‚ùå Error setting reset session:', error);
            this.isPasswordResetContext = false;
            this.showError('Invalid or expired reset link. Please request a new password reset.');
            this.showLogin();
          }
        } else if (fragment.includes('access_token')) {
          // If we see an access token but type isn't recovery, log for debugging
          console.log('‚ö†Ô∏è Found access token but type is not recovery:', { type, fragment });
          
          // Try to force the type to recovery if we're clearly in a reset context
          if (fragment.includes('#reset') || fragment.includes('recovery')) {
            console.log('üîÑ Attempting to force recovery type...');
            type = 'recovery';
            
            if (accessToken) {
              try {
                // Set the password reset context flag BEFORE setting the session
                this.isPasswordResetContext = true;
                
                const { data, error } = await this.supabase.auth.setSession({
                  access_token: accessToken,
                  refresh_token: refreshToken
                });
                
                if (!error && data.user) {
                  console.log('‚úÖ Forced recovery session established for:', data.user.email);
                  this.showSetNewPasswordForm();
                  window.history.replaceState({}, document.title, window.location.pathname);
                  return true;
                }
              } catch (error) {
                console.error('‚ùå Forced recovery failed:', error);
                this.isPasswordResetContext = false;
              }
            }
          }
        }
        
        return false; // No reset token handled
      }

      getTokenFromHash(tokenName) {
        // Parse tokens from URL hash fragment
        let hash = window.location.hash.substring(1);
        
        // Handle case where there might be multiple # symbols (e.g., #reset#access_token=...)
        if (hash.includes('#')) {
          // Split by # and take the part that contains the tokens
          const hashParts = hash.split('#');
          for (const part of hashParts) {
            if (part.includes('access_token') || part.includes('refresh_token') || part.includes('type=')) {
              hash = part;
              break;
            }
          }
        }
        
        const params = new URLSearchParams(hash);
        return params.get(tokenName);
      }

      showSetNewPasswordForm() {
        // Show login interface first
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('loginInterface').classList.remove('hidden');
        document.getElementById('portalInterface').classList.add('hidden');
        
        // Hide all forms and show new password form
        document.getElementById('emailLoginForm').classList.add('hidden');
        document.getElementById('magicLinkForm').classList.add('hidden');
        document.getElementById('passwordResetForm').classList.add('hidden');
        document.getElementById('setNewPasswordForm').classList.remove('hidden');
        
        // Reset tab buttons
        document.querySelectorAll('.auth-tab').forEach(btn => btn.classList.remove('active'));
        
        // Focus password field
        setTimeout(() => document.getElementById('newPassword').focus(), 100);
        
        // Clear messages and show info
        this.hideMessages();
        this.showSuccess('Please enter your new password to complete the reset process.');
      }

      showLogin() {
        try {
          console.log('üîë Showing login interface...');
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('loginInterface').classList.remove('hidden');
          document.getElementById('portalInterface').classList.add('hidden');
          
          // Focus on email field
          setTimeout(() => {
            const emailField = document.getElementById('email');
            if (emailField) emailField.focus();
          }, 100);
        } catch (error) {
          console.error('‚ùå Error showing login:', error);
        }
      }

      showPortal() {
        try {
          console.log('üè† Showing portal interface...');
          document.getElementById('loadingState').classList.add('hidden');
          document.getElementById('loginInterface').classList.add('hidden');
          document.getElementById('portalInterface').classList.remove('hidden');
        } catch (error) {
          console.error('‚ùå Error showing portal:', error);
        }
      }

      async handleEmailLogin(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        
        if (!this.isValidEmail(email)) {
          this.showError('Please enter a valid email address.');
          return;
        }

        const loginBtn = document.getElementById('loginBtn');
        const originalText = loginBtn.textContent;
        loginBtn.textContent = 'Signing In...';
        loginBtn.disabled = true;
        
        this.hideMessages();

        try {
          console.log('üîê Attempting email login for:', email);
          
          const { data, error } = await this.supabase.auth.signInWithPassword({
            email: email,
            password: password
          });

          if (error) throw error;

          if (data.user) {
            console.log('‚úÖ Email login successful:', data.user.email);
            this.showSuccess('Login successful! Loading your portal...');
          }
          
        } catch (error) {
          console.error('‚ùå Email login error:', error);
          
          if (error.message.includes('Invalid login credentials')) {
            this.showError('Invalid email or password. Please check your credentials and try again.');
          } else if (error.message.includes('Email not confirmed')) {
            this.showError('Please check your email and click the confirmation link before signing in.');
          } else {
            this.showError('Login failed: ' + error.message);
          }
        }
        
        // Reset button
        loginBtn.textContent = originalText;
        loginBtn.disabled = false;
      }

      async handleMagicLink(e) {
        e.preventDefault();
        
        const email = document.getElementById('magicEmail').value.trim();
        
        if (!this.isValidEmail(email)) {
          this.showError('Please enter a valid email address.');
          return;
        }

        const magicBtn = document.getElementById('magicBtn');
        const originalText = magicBtn.textContent;
        magicBtn.textContent = 'Sending...';
        magicBtn.disabled = true;
        
        this.hideMessages();

        try {
          console.log('üîó Sending magic link to:', email);
          
          const { data, error } = await this.supabase.auth.signInWithOtp({
            email: email,
            options: {
              emailRedirectTo: window.location.origin + '/student-portal.html'
            }
          });

          if (error) throw error;

          console.log('‚úÖ Magic link sent successfully');
          this.showSuccess('Magic link sent to ' + email + '! Please check your email and click the link to access your portal.');
          
          // Clear the email field
          document.getElementById('magicEmail').value = '';
          
        } catch (error) {
          console.error('‚ùå Magic link error:', error);
          this.showError('Failed to send magic link: ' + error.message);
        }
        
        // Reset button
        magicBtn.textContent = originalText;
        magicBtn.disabled = false;
      }

      async handlePasswordReset(e) {
        e.preventDefault();
        
        const email = document.getElementById('resetEmail').value.trim();
        
        if (!this.isValidEmail(email)) {
          this.showError('Please enter a valid email address.');
          return;
        }

        const resetBtn = document.getElementById('resetBtn');
        const originalText = resetBtn.textContent;
        resetBtn.textContent = 'Sending...';
        resetBtn.disabled = true;
        
        this.hideMessages();

        try {
          console.log('üîë Sending password reset email to:', email);
          
          const { data, error } = await this.supabase.auth.resetPasswordForEmail(email, {
            redirectTo: `${window.location.origin}/student-portal.html`
          });

          if (error) throw error;

          console.log('‚úÖ Password reset email sent successfully');
          this.showSuccess(`Password reset link sent to ${email}. Please check your email and follow the instructions.`);
          
          // Clear the email field
          document.getElementById('resetEmail').value = '';
          
          // Auto switch back to login after 5 seconds
          setTimeout(() => {
            this.switchAuthTab('email');
            this.showSuccess('You can sign in with your new password once you\'ve reset it.');
          }, 5000);
          
        } catch (error) {
          console.error('‚ùå Password reset error:', error);
          
          if (error.message.includes('User not found')) {
            this.showError('No student account found with this email address.');
          } else {
            this.showError('Password reset failed: ' + error.message);
          }
        }
        
        // Reset button
        resetBtn.textContent = originalText;
        resetBtn.disabled = false;
      }

      async handleSetNewPassword(e) {
        e.preventDefault();
        
        const newPassword = document.getElementById('newPassword').value.trim();
        const confirmPassword = document.getElementById('confirmNewPassword').value.trim();
        
        // Validate password match
        if (newPassword !== confirmPassword) {
          this.showError('Passwords do not match.');
          return;
        }
        
        // Validate password strength
        if (newPassword.length < 6) {
          this.showError('Password must be at least 6 characters long.');
          return;
        }
        
        const setPasswordBtn = document.getElementById('setPasswordBtn');
        const originalText = setPasswordBtn.textContent;
        setPasswordBtn.textContent = 'Setting Password...';
        setPasswordBtn.disabled = true;
        
        this.hideMessages();

        try {
          console.log('üîÑ Setting new password...');
          
          // Update the user's password
          const { data, error } = await this.supabase.auth.updateUser({
            password: newPassword
          });

          if (error) throw error;
          
          if (data.user) {
            console.log('‚úÖ Password updated successfully for:', data.user.email);
            this.showSuccess('Password updated successfully! You can now sign in with your new password.');
            
            // Clear password fields
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            
            // Sign out the user to clear the recovery session
            await this.supabase.auth.signOut();
            
            // Switch back to login after delay
            setTimeout(() => {
              this.isPasswordResetContext = false;
              this.switchAuthTab('email');
              // Pre-fill the email if we know it
              if (data.user.email) {
                document.getElementById('email').value = data.user.email;
              }
              this.showSuccess('Please sign in with your new password.');
            }, 3000);
          }
          
        } catch (error) {
          console.error('‚ùå Password update error:', error);
          this.showError(`Failed to update password: ${error.message}`);
        }
        
        // Reset button
        setPasswordBtn.textContent = originalText;
        setPasswordBtn.disabled = false;
      }

      async handleAuthSuccess(user) {
        this.currentUser = user;
        
        try {
          // Get student data
          console.log('üìä Fetching student data for:', user.email);
          await this.loadStudentData();
          
          // Show portal
          this.showPortal();
          
          // Update UI with student info
          this.updateStudentUI();
          
          // Load documents
          await this.loadDocuments();
          
        } catch (error) {
          console.error('‚ùå Error loading student data:', error);
          if (error.message.includes('Student record not found')) {
            this.showError('Student record not found. Please contact administration to set up your account.');
          } else {
            this.showError('Error loading your portal: ' + error.message);
          }
          
          // Show login with error
          this.showLogin();
        }
      }

      handleAuthSignOut() {
        console.log('üö™ User signed out');
        this.currentUser = null;
        this.studentData = null;
        this.showLogin();
      }

      async loadStudentData() {
        try {
          const { data: student, error } = await this.supabase
            .from('students')
            .select('*')
            .eq('email', this.currentUser.email)
            .single();

          if (error) {
            if (error.code === 'PGRST116') {
              // Student not found in database
              console.log('üìù Student not found in database');
              throw new Error('Student record not found. Please contact administration to set up your account.');
            }
            throw error;
          }

          this.studentData = student;
          console.log('‚úÖ Student data loaded:', student.room_number);
          
        } catch (error) {
          console.error('‚ùå Error loading student data:', error);
          throw error;
        }
      }

      updateStudentUI() {
        if (!this.studentData) return;
        
        try {
          // Update student name and avatar
          const name = this.studentData.name || this.currentUser.email.split('@')[0];
          const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
          
          const studentNameEl = document.getElementById('studentName');
          const studentAvatarEl = document.getElementById('studentAvatar');
          const studentRoomEl = document.getElementById('studentRoom');
          
          if (studentNameEl) studentNameEl.textContent = name;
          if (studentAvatarEl) studentAvatarEl.textContent = initials;
          if (studentRoomEl) studentRoomEl.textContent = this.studentData.room_number;
          
          console.log('‚úÖ Student UI updated');
        } catch (error) {
          console.error('‚ùå Error updating student UI:', error);
        }
      }

      async loadDocuments() {
        try {
          console.log('üìÑ Loading documents for room:', this.studentData.room_number);
          
          // Fetch documents (both personal and shared)
          const { data: documents, error } = await this.supabase
            .from('documents')
            .select('*')
            .or('is_global.eq.true,room_number.eq.' + this.studentData.room_number)
            .order('created_at', { ascending: false });

          if (error) throw error;

          console.log('‚úÖ Documents loaded:', documents.length);
          
          // Separate personal and shared documents
          const myDocuments = documents.filter(doc => 
            !doc.is_global && doc.room_number === this.studentData.room_number
          );
          const sharedDocuments = documents.filter(doc => doc.is_global);
          
          // Render documents
          this.renderDocuments('myDocuments', myDocuments, 'No personal documents available.');
          this.renderDocuments('sharedDocuments', sharedDocuments, 'No shared documents available.');
          
        } catch (error) {
          console.error('‚ùå Error loading documents:', error);
          this.showDocumentError('myDocuments');
          this.showDocumentError('sharedDocuments');
        }
      }

      showDocumentError(containerId) {
        document.getElementById(containerId).innerHTML = '<div class="no-documents"><div class="no-documents-icon">‚ö†Ô∏è</div><p>Error loading documents. Please refresh the page.</p></div>';
      }

      renderDocuments(containerId, documents, emptyMessage) {
        const container = document.getElementById(containerId);
        
        if (documents.length === 0) {
          container.innerHTML = '<div class="no-documents"><div class="no-documents-icon">üìÑ</div><p>' + emptyMessage + '</p></div>';
          return;
        }

        let documentsHTML = '';
        documents.forEach(doc => {
          documentsHTML += '<div class="document-item">';
          documentsHTML += '<div class="document-info">';
          documentsHTML += '<div class="document-icon">' + this.getDocumentIcon(doc.file_url) + '</div>';
          documentsHTML += '<div>';
          documentsHTML += '<div class="document-title">' + this.escapeHtml(doc.title) + '</div>';
          documentsHTML += '<div class="document-meta">';
          documentsHTML += (doc.is_global ? 'Shared Document' : 'Personal Document') + ' ‚Ä¢ ';
          documentsHTML += new Date(doc.created_at).toLocaleDateString();
          documentsHTML += '</div>';
          documentsHTML += '</div>';
          documentsHTML += '</div>';
          documentsHTML += '<button class="download-btn" onclick="studentPortal.downloadDocument(\'' + doc.id + '\', \'' + this.escapeHtml(doc.title) + '\')" aria-label="Download ' + this.escapeHtml(doc.title) + '">';
          documentsHTML += '<span>‚¨áÔ∏è</span>';
          documentsHTML += '<span>Download</span>';
          documentsHTML += '</button>';
          documentsHTML += '</div>';
        });

        container.innerHTML = documentsHTML;
      }

      getDocumentIcon(fileUrl) {
        const extension = fileUrl.split('.').pop().toLowerCase();
        const iconMap = {
          'pdf': 'üìÑ',
          'doc': 'üìù',
          'docx': 'üìù',
          'txt': 'üìÉ',
          'xls': 'üìä',
          'xlsx': 'üìä',
          'ppt': 'üì∫',
          'pptx': 'üì∫',
          'jpg': 'üñºÔ∏è',
          'jpeg': 'üñºÔ∏è',
          'png': 'üñºÔ∏è',
          'gif': 'üñºÔ∏è',
          'zip': 'üì¶',
          'rar': 'üì¶'
        };
        return iconMap[extension] || 'üìÑ';
      }

      async downloadDocument(documentId, documentTitle) {
        try {
          console.log('üì• Downloading document:', documentTitle);
          
          // Find the document to get the file path
          const { data: document, error: docError } = await this.supabase
            .from('documents')
            .select('file_url')
            .eq('id', documentId)
            .single();
            
          if (docError) throw docError;
          
          // Extract filename from the stored URL
          const urlParts = document.file_url.split('/');
          const fileName = urlParts[urlParts.length - 1];
          
          // Create a signed URL for secure download
          const { data: signedUrl, error: urlError } = await this.supabase.storage
            .from('documents')
            .createSignedUrl(fileName, 300); // 5 minute expiry
            
          if (urlError) throw urlError;
          
          // Open the signed URL in a new tab for download
          window.open(signedUrl.signedUrl, '_blank');
          
          console.log('‚úÖ Document download initiated');
          
        } catch (error) {
          console.error('‚ùå Error downloading document:', error);
          alert('Error downloading document: ' + error.message);
        }
      }

      async handleLogout() {
        try {
          console.log('üö™ Logging out...');
          await this.supabase.auth.signOut();
        } catch (error) {
          console.error('‚ùå Logout error:', error);
          this.handleAuthSignOut();
        }
      }

      switchAuthTab(tab) {
        this.currentAuthTab = tab;
        
        // Update tab buttons
        document.querySelectorAll('.auth-tab').forEach(btn => btn.classList.remove('active'));
        if (event && event.target) {
          event.target.classList.add('active');
        } else {
          // Handle programmatic calls
          const tabButtons = document.querySelectorAll('.auth-tab');
          if (tab === 'email') tabButtons[0].classList.add('active');
          else if (tab === 'magic') tabButtons[1].classList.add('active');
          else if (tab === 'reset') tabButtons[2].classList.add('active');
        }
        
        // Hide all forms first
        document.getElementById('emailLoginForm').classList.add('hidden');
        document.getElementById('magicLinkForm').classList.add('hidden');
        document.getElementById('passwordResetForm').classList.add('hidden');
        document.getElementById('setNewPasswordForm').classList.add('hidden');
        
        // Show the appropriate form
        if (tab === 'email') {
          document.getElementById('emailLoginForm').classList.remove('hidden');
          setTimeout(() => document.getElementById('email').focus(), 100);
        } else if (tab === 'magic') {
          document.getElementById('magicLinkForm').classList.remove('hidden');
          setTimeout(() => document.getElementById('magicEmail').focus(), 100);
        } else if (tab === 'reset') {
          document.getElementById('passwordResetForm').classList.remove('hidden');
          setTimeout(() => document.getElementById('resetEmail').focus(), 100);
        }
        
        // Clear messages
        this.hideMessages();
      }

      isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      showError(message) {
        this.hideMessages();
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }

      showSuccess(message) {
        this.hideMessages();
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
      }

      hideMessages() {
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';
      }
    }

    // Global functions for inline event handlers
    let studentPortal;

    function switchAuthTab(tab) {
      studentPortal.switchAuthTab(tab);
    }

    function handleLogout() {
      studentPortal.handleLogout();
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      try {
        console.log('üìÑ DOM Content Loaded - Initializing Student Portal...');
        
        // Add a small delay to ensure all external scripts are loaded
        setTimeout(() => {
          try {
            studentPortal = new StudentPortal();
          } catch (error) {
            console.error('‚ùå Error creating StudentPortal instance:', error);
            
            // Show fallback error message
            const loadingState = document.getElementById('loadingState');
            if (loadingState) {
              loadingState.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #e74c3c;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                  <h3>Student Portal Error</h3>
                  <p>Failed to initialize the student portal. This might be due to:</p>
                  <ul style="text-align: left; margin: 1rem 0; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <li>Internet connection issues</li>
                    <li>Browser compatibility problems</li>
                    <li>Missing JavaScript libraries</li>
                  </ul>
                  <div style="margin-top: 2rem;">
                    <button onclick="location.reload()" style="padding: 0.75rem 1.5rem; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 1rem;">
                      üîÑ Retry
                    </button>
                    <a href="index.html" style="padding: 0.75rem 1.5rem; background: #95a5a6; color: white; text-decoration: none; border-radius: 6px;">
                      ‚Üê Back to Home
                    </a>
                  </div>
                  <div style="margin-top: 1rem; font-size: 0.9em; color: #666;">
                    Error: ${error.message}
                  </div>
                </div>
              `;
            }
          }
        }, 500); // 500ms delay to ensure libraries are loaded
        
      } catch (error) {
        console.error('‚ùå Critical error in DOMContentLoaded:', error);
      }
    });

    // Handle Enter key navigation
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const activeElement = document.activeElement;
        if (activeElement && activeElement.form) {
          const submitButton = activeElement.form.querySelector('button[type="submit"]');
          if (submitButton && !submitButton.disabled) {
            submitButton.click();
          }
        }
      }
    });

    // Security: Clear sensitive data on page unload
    window.addEventListener('beforeunload', function() {
      if (document.getElementById('password')) {
        document.getElementById('password').value = '';
      }
    });
  </script>
</body>
</html> 