<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Administrative dashboard for managing iLm Halal Student Halls applications and bookings. Staff access only.">
  <meta name="robots" content="noindex, nofollow">
  
  <title>Admin Dashboard - iLm Halal Student Halls</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189942/web-app-manifest-192x192_wr5wdr.png">
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- PDF Generation Library with fallbacks -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js" 
          integrity="sha512-nVrqJe4vvBkEHo/4qTI2fOqgFIvFyLJMvIhJ6Dq0PgNz+3Ep5g8k0UgE1kUJ3N5uHx8Jl/3DGKuP5B7LN6vHw==" 
          crossorigin="anonymous" 
          referrerpolicy="no-referrer"
          onerror="loadJsPDFFallback()"></script>
  
  <script>
    // Fallback loading for jsPDF
    function loadJsPDFFallback() {
      console.log('Primary jsPDF CDN failed, trying fallback...');
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/jspdf@2.5.2/dist/jspdf.umd.min.js';
      script.onerror = function() {
        console.log('Fallback CDN failed, trying jsdelivr...');
        const script2 = document.createElement('script');
        script2.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js';
        script2.onerror = function() {
          console.error('All jsPDF CDNs failed to load');
          window.jsPDFLoadError = true;
        };
        document.head.appendChild(script2);
      };
      document.head.appendChild(script);
    }
    
    // Check if jsPDF loaded successfully
    window.addEventListener('load', function() {
      setTimeout(() => {
        if (!window.jspdf && !window.jsPDFLoadError) {
          console.log('jsPDF not detected, attempting manual load...');
          loadJsPDFFallback();
        } else if (window.jspdf) {
          console.log('✅ jsPDF loaded successfully');
        }
      }, 1000);
    });
  </script>
  
  <style>
    /* Admin Dashboard Specific Styles */
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .admin-header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .admin-title {
      font-size: 28px;
      font-weight: bold;
      margin: 0;
    }

    .admin-stats {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: rgba(255,255,255,0.1);
      padding: 15px 20px;
      border-radius: 8px;
      text-align: center;
      min-width: 100px;
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      display: block;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.9;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 30px;
      margin-bottom: 30px;
    }

    .main-panel {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .side-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel-header {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
    }

    .search-filter-bar {
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .filter-select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      min-width: 150px;
    }

    .applications-table {
      width: 100%;
      border-collapse: collapse;
    }

    .applications-table th {
      background: #f8f9fa;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #dee2e6;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .applications-table td {
      padding: 15px;
      border-bottom: 1px solid #dee2e6;
      vertical-align: middle;
    }

    .applications-table tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .status-new { background: #e3f2fd; color: #1976d2; }
    .status-review { background: #fff3e0; color: #f57c00; }
    .status-approved { background: #e8f5e8; color: #388e3c; }
    .status-rejected { background: #ffebee; color: #d32f2f; }
    .status-archived { background: #f5f5f5; color: #757575; }

    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-view { background: #e3f2fd; color: #1976d2; }
    .btn-edit { background: #fff3e0; color: #f57c00; }
    .btn-delete { background: #ffebee; color: #d32f2f; }
    .btn-archive { background: #f5f5f5; color: #757575; }
    .btn-pdf { background: #e8f5e8; color: #388e3c; }

    .btn-small:hover {
      opacity: 0.8;
      transform: translateY(-1px);
    }

    .quick-actions {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 20px;
    }

    .quick-action-btn {
      width: 100%;
      padding: 15px;
      margin-bottom: 10px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }

    .quick-action-btn:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .quick-action-btn.secondary {
      background: #95a5a6;
    }

    .recent-activity {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 20px;
    }

    .activity-item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: white;
    }

    .activity-new { background: #3498db; }
    .activity-update { background: #f39c12; }
    .activity-approve { background: #27ae60; }

    .activity-text {
      flex: 1;
      font-size: 14px;
    }

    .activity-time {
      font-size: 12px;
      color: #888;
    }

    .pagination {
      padding: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
    }

    .pagination button.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Dashboard Navigation Tabs */
    .dashboard-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .dashboard-tab {
      padding: 12px 24px;
      border: none;
      background: #f8f9fa;
      color: #495057;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dashboard-tab.active {
      background: #2F2970;
      color: white;
    }

    .dashboard-tab:hover:not(.active) {
      background: #e9ecef;
    }

    .section-content {
      width: 100%;
    }

    /* Document Management Styles */
    .document-upload-section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 25px;
      margin-bottom: 30px;
    }

    .document-upload-section h3 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 20px;
    }

    .document-upload-form .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .document-upload-form .form-group {
      display: flex;
      flex-direction: column;
    }

    .document-upload-form .form-group label {
      margin-bottom: 8px;
      font-weight: 500;
      color: #2c3e50;
    }

    .document-upload-form input[type="text"],
    .document-upload-form input[type="file"] {
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .document-upload-form input[type="text"]:focus,
    .document-upload-form input[type="file"]:focus {
      outline: none;
      border-color: #2F2970;
      box-shadow: 0 0 0 3px rgba(47, 41, 112, 0.1);
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 14px;
      color: #2c3e50;
    }

    .checkbox-label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* Enhanced Documents Section Styles */
    .documents-list-section {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 25px;
    }

    .documents-list-section h3 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 20px;
    }

    .documents-table-container {
      overflow-x: auto;
    }

    /* Header Actions */
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* Statistics Cards */
    .stats-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .stat-card-mini {
      background: white;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }

    .stat-card-mini:hover {
      transform: translateY(-2px);
    }

    .stat-icon {
      font-size: 24px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .stat-content {
      flex: 1;
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      color: #7f8c8d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Section Headers */
    .section-header-with-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-header-with-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .toggle-btn {
      background: none;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .toggle-btn:hover {
      background: #f8f9fa;
    }

    /* Upload Form Enhancements */
    .upload-form-container {
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .file-input-wrapper {
      position: relative;
    }

    .file-input-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 14px;
    }

    .document-type-selection {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .radio-label:hover {
      background: #f8f9fa;
    }

    .radio-custom {
      width: 16px;
      height: 16px;
      border: 2px solid #ddd;
      border-radius: 50%;
      position: relative;
    }

    .radio-label input[type="radio"] {
      display: none;
    }

    .radio-label input[type="radio"]:checked + .radio-custom {
      border-color: #3498db;
    }

    .radio-label input[type="radio"]:checked + .radio-custom::after {
      content: '';
      width: 8px;
      height: 8px;
      background: #3498db;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .form-help {
      display: block;
      margin-top: 5px;
      font-size: 12px;
      color: #6c757d;
    }

    /* View Options */
    .view-options {
      display: flex;
      gap: 5px;
      background: #f8f9fa;
      border-radius: 5px;
      padding: 2px;
    }

    .view-btn {
      padding: 8px 15px;
      border: none;
      background: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .view-btn.active {
      background: #3498db;
      color: white;
    }

    /* Enhanced Search and Filter */
    .search-filter-bar.enhanced {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 15px;
      align-items: center;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .search-group {
      display: flex;
      gap: 10px;
    }

    .search-input-wrapper {
      position: relative;
      flex: 1;
    }

    .search-clear-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #999;
      font-size: 14px;
    }

    .filter-group {
      display: flex;
      gap: 10px;
    }

    .action-group {
      display: flex;
      gap: 10px;
    }

    /* Enhanced Table */
    .enhanced-table th {
      background: linear-gradient(135deg, #34495e, #2c3e50);
      color: white;
      font-weight: 600;
      text-align: left;
    }

    .enhanced-table td {
      vertical-align: middle;
    }

    .enhanced-table .document-title {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .enhanced-table .document-description {
      font-size: 12px;
      color: #7f8c8d;
      line-height: 1.3;
    }

    .enhanced-table .document-category {
      display: inline-block;
      padding: 2px 8px;
      background: #ecf0f1;
      border-radius: 12px;
      font-size: 11px;
      color: #34495e;
      margin-top: 4px;
    }

    .enhanced-table .file-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .enhanced-table .file-size {
      font-size: 12px;
      color: #7f8c8d;
    }

    .enhanced-table .file-type {
      font-size: 10px;
      text-transform: uppercase;
      color: #95a5a6;
    }

    /* Grid View */
    .documents-grid-container {
      margin-top: 20px;
    }

    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .document-grid-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .document-grid-item:hover {
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .document-grid-item.selected {
      border-color: #3498db;
      background: #f8f9fa;
    }

    .grid-item-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }

    .grid-item-icon {
      font-size: 24px;
      width: 40px;
      height: 40px;
      background: #f8f9fa;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .grid-item-title {
      font-weight: 600;
      color: #2c3e50;
      font-size: 16px;
      line-height: 1.3;
    }

    .grid-item-meta {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
    }

    .grid-item-description {
      font-size: 13px;
      color: #7f8c8d;
      line-height: 1.4;
      margin-bottom: 10px;
    }

    .grid-item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid #ecf0f1;
    }

    /* Bulk Actions */
    .bulk-actions-bar {
      position: sticky;
      bottom: 0;
      background: #2c3e50;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .bulk-actions-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .bulk-actions-buttons {
      display: flex;
      gap: 10px;
    }

    /* Button Enhancements */
    .btn .btn-loading {
      display: none;
    }

    .btn.loading .btn-text {
      display: none;
    }

    .btn.loading .btn-loading {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .loading-spinner-small {
      width: 12px;
      height: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .search-filter-bar.enhanced {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .filter-group {
        flex-wrap: wrap;
      }
    }

    @media (max-width: 768px) {
      .stats-cards-container {
        grid-template-columns: repeat(2, 1fr);
      }

      .documents-grid {
        grid-template-columns: 1fr;
      }

      .header-actions {
        flex-direction: column;
        gap: 8px;
      }

      .section-header-with-actions {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .bulk-actions-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .bulk-actions-buttons {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .dashboard-nav {
        flex-direction: column;
        padding: 15px;
      }
      
      .dashboard-tab {
        justify-content: center;
      }
      
      .document-upload-form .form-row {
        grid-template-columns: 1fr;
      }
      
      .admin-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }
      
      .search-filter-bar {
        flex-direction: column;
      }
      
      .search-box, .filter-select {
        width: 100%;
      }
      
      .applications-table {
        font-size: 12px;
      }
      
      .applications-table th,
      .applications-table td {
        padding: 8px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .modal-content {
      background: white;
      margin: 2% auto;
      padding: 30px;
      border-radius: 10px;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #888;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .form-group textarea {
      height: 80px;
      resize: vertical;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-grid-full {
      grid-column: 1 / -1;
    }

    .form-section {
      margin-bottom: 30px;
    }

    .form-section h4 {
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
      margin-bottom: 20px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary { background: #3498db; color: white; }
    .btn-success { background: #27ae60; color: white; }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-secondary { background: #95a5a6; color: white; }
    .btn-info { background: #17a2b8; color: white; }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 1001;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success { background: #27ae60; }
    .notification.error { background: #e74c3c; }
    .notification.info { background: #3498db; }

    /* Bulk Actions Styles */
    .bulk-actions-bar {
      padding: 15px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      display: none;
      align-items: center;
      gap: 15px;
    }

    .bulk-actions-bar.show {
      display: flex;
    }

    .checkbox-column {
      width: 40px;
      text-align: center;
    }

    .checkbox-column input[type="checkbox"] {
      transform: scale(1.2);
    }

    /* Settings Styles */
    .settings-section {
      margin-bottom: 25px;
    }

    .settings-section h4 {
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-label {
      font-weight: 500;
    }

    .setting-description {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: #ccc;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: #3498db;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active::after {
      transform: translateX(26px);
    }

    /* Analytics Panel Styles */
    .analytics-panel {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 0;
      overflow: hidden;
    }

    .analytics-tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }

    .analytics-tab {
      flex: 1;
      padding: 15px 20px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6c757d;
      transition: all 0.3s ease;
    }

    .analytics-tab:hover {
      color: #495057;
      background: rgba(52, 144, 220, 0.05);
    }

    .analytics-tab.active {
      color: #3498db;
      border-bottom-color: #3498db;
      background: white;
    }

    .analytics-content {
      padding: 20px;
    }

    .analytics-tab-content {
      display: none;
    }

    .analytics-tab-content.active {
      display: block;
    }

    .analytics-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .analytics-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }

    .analytics-card:hover {
      transform: translateY(-2px);
    }

    .analytics-card:nth-child(2) {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .analytics-card:nth-child(3) {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .analytics-card:nth-child(4) {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .card-icon {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .card-number {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .card-label {
      font-size: 12px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .popular-features h4 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .feature-list {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
    }

    .feature-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .feature-item:last-child {
      border-bottom: none;
    }

    .feature-name {
      font-weight: 500;
      color: #495057;
    }

    .feature-usage {
      background: #3498db;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .vitals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .vital-card {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .vital-label {
      font-size: 12px;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .vital-value {
      font-size: 20px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .vital-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .vital-status:contains("Good") {
      background: #d4edda;
      color: #155724;
    }

    .vital-status:contains("Needs") {
      background: #fff3cd;
      color: #856404;
    }

    .vital-status:contains("Poor") {
      background: #f8d7da;
      color: #721c24;
    }

    .performance-issues h4,
    .journey-flow h4,
    .accessibility-insights h4 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .issues-list {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
    }

    .issue-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .issue-item:last-child {
      border-bottom: none;
    }

    .issue-type {
      font-weight: 500;
      color: #495057;
    }

    .issue-count {
      background: #e74c3c;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .journey-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .journey-step {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      min-width: 120px;
      transition: all 0.3s ease;
    }

    .journey-step:hover {
      border-color: #3498db;
      transform: translateY(-2px);
    }

    .step-number {
      width: 30px;
      height: 30px;
      background: #3498db;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
    }

    .step-name {
      font-weight: 500;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .step-percentage {
      font-size: 18px;
      font-weight: bold;
      color: #3498db;
    }

    .journey-arrow {
      font-size: 24px;
      color: #6c757d;
      margin: 0 10px;
    }

    .goal-completion {
      margin-top: 30px;
    }

    .goals-list {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
    }

    .goal-item {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .goal-item:last-child {
      margin-bottom: 0;
    }

    .goal-icon {
      font-size: 20px;
      width: 30px;
      text-align: center;
    }

    .goal-name {
      flex: 1;
      font-weight: 500;
      color: #495057;
    }

    .goal-bar {
      flex: 2;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }

    .goal-progress {
      height: 100%;
      background: linear-gradient(90deg, #3498db, #2ecc71);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .goal-percentage {
      font-weight: bold;
      color: #3498db;
      min-width: 40px;
      text-align: right;
    }

    .a11y-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .a11y-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
    }

    .a11y-icon {
      font-size: 20px;
    }

    .a11y-label {
      flex: 1;
      font-weight: 500;
      color: #495057;
    }

    .a11y-percentage {
      font-weight: bold;
      color: #3498db;
    }

    .form-analytics {
      margin-top: 30px;
    }

    .form-stats {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
    }

    .form-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .form-stat:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-weight: 500;
      color: #495057;
    }

    .stat-value {
      font-weight: bold;
      color: #3498db;
    }

    .analytics-footer {
      background: #f8f9fa;
      padding: 15px 20px;
      border-top: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .analytics-footer small {
      color: #6c757d;
      font-style: italic;
    }

    /* Mobile responsiveness for analytics */
    @media (max-width: 768px) {
      .analytics-tabs {
        flex-wrap: wrap;
      }
      
      .analytics-tab {
        flex: 1 1 50%;
      }
      
      .analytics-cards {
        grid-template-columns: 1fr;
      }
      
      .vitals-grid {
        grid-template-columns: 1fr;
      }
      
      .journey-steps {
        flex-direction: column;
        align-items: stretch;
      }
      
      .journey-arrow {
        transform: rotate(90deg);
        margin: 10px 0;
      }
      
      .a11y-stats {
        grid-template-columns: 1fr;
      }
      
      .analytics-footer {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>

  <style>
    /* Gallery Management Styles */
    .gallery-header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .gallery-management-container {
      padding: 20px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .gallery-management-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .gallery-image-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .gallery-image-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .gallery-image-card.selected {
      border-color: #3498db;
      box-shadow: 0 4px 16px rgba(52, 144, 220, 0.2);
    }

    .gallery-card-header {
      position: relative;
      height: 200px;
      background: #f8f9fa;
      overflow: hidden;
    }

    .gallery-card-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .gallery-image-card:hover .gallery-card-image {
      transform: scale(1.05);
    }

    .gallery-card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .gallery-image-card:hover .gallery-card-overlay {
      opacity: 1;
    }

    .gallery-card-action {
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 6px;
      padding: 10px 14px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(255,255,255,0.8);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .gallery-card-action:hover {
      background: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      border-color: currentColor;
    }

    .gallery-card-action.edit { 
      color: #e65100; 
      background: rgba(255, 243, 224, 0.95);
    }
    .gallery-card-action.delete { 
      color: #b71c1c; 
      background: rgba(255, 235, 238, 0.95);
    }
    .gallery-card-action.view { 
      color: #0d47a1; 
      background: rgba(227, 242, 253, 0.95);
    }

    .gallery-card-action.edit:hover {
      background: #fff3e0;
      color: #d84315;
    }

    .gallery-card-action.delete:hover {
      background: #ffebee;
      color: #c62828;
    }

    .gallery-card-action.view:hover {
      background: #e3f2fd;
      color: #1565c0;
    }

    .gallery-card-status {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 5px;
    }

    .gallery-status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .gallery-status-visible {
      background: rgba(76, 175, 80, 0.9);
      color: white;
    }

    .gallery-status-hidden {
      background: rgba(158, 158, 158, 0.9);
      color: white;
    }

    .gallery-status-featured {
      background: rgba(255, 193, 7, 0.9);
      color: #333;
    }

    .gallery-card-checkbox {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .gallery-card-body {
      padding: 15px;
    }

    .gallery-card-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 5px;
      color: #2c3e50;
      line-height: 1.3;
    }

    .gallery-card-category {
      font-size: 12px;
      color: #6c757d;
      margin-bottom: 8px;
      text-transform: capitalize;
    }

    .gallery-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #9aa0a6;
    }

    .gallery-card-order {
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }

    .gallery-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      color: #6c757d;
      font-style: italic;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #2c3e50;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 144, 220, 0.1);
    }

    .form-group small {
      display: block;
      margin-top: 5px;
      color: #6c757d;
      font-size: 12px;
    }

    .category-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s ease;
    }

    .category-item:hover {
      background: #f8f9fa;
    }

    .category-item:last-child {
      border-bottom: none;
    }

    .category-info {
      flex: 1;
    }

    .category-name {
      font-weight: 500;
      color: #2c3e50;
      margin-bottom: 3px;
    }

    .category-description {
      font-size: 12px;
      color: #6c757d;
    }

    .category-stats {
      font-size: 11px;
      color: #9aa0a6;
      margin-right: 15px;
    }

    .category-actions {
      display: flex;
      gap: 5px;
    }

    /* URL Preview */
    .url-preview {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #3498db;
    }

    .url-preview-label {
      font-size: 12px;
      color: #6c757d;
      margin-bottom: 5px;
    }

    .url-preview-text {
      font-family: monospace;
      font-size: 11px;
      color: #495057;
      word-break: break-all;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .gallery-management-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .gallery-header-actions {
        flex-direction: column;
        gap: 5px;
      }
      
      .search-filter-bar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-filter-bar > * {
        min-width: auto;
      }
      
      .gallery-card-overlay {
        opacity: 1;
        background: rgba(0,0,0,0.5);
      }
      
      .gallery-card-action {
        padding: 6px 10px;
        font-size: 11px;
      }
    }

    @media (max-width: 480px) {
      .gallery-management-container {
        padding: 10px;
      }
      
      .gallery-card-body {
        padding: 12px;
      }
      
      .gallery-card-title {
        font-size: 13px;
      }
    }

    /* Pagination Styles */
    .pagination-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      gap: 10px;
      background: #f8f9fa;
      border-top: 1px solid #dee2e6;
    }

    .pagination-btn {
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 15px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pagination-btn:hover {
      background: #2980b9;
      transform: translateY(-1px);
    }

    .pagination-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
    }

    .pagination-btn.active {
      background: #2c3e50;
      font-weight: 600;
    }

    .pagination-info {
      background: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      color: #2c3e50;
      font-weight: 500;
      border: 1px solid #dee2e6;
    }

    /* Category Management Styles */
    .reorder-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(52, 144, 220, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      pointer-events: none;
      z-index: 10;
    }

    .gallery-image-card[draggable="true"] {
      transition: transform 0.2s ease;
    }

    .gallery-image-card[draggable="true"]:hover {
      transform: scale(1.02);
    }

    .gallery-image-card.drag-over {
      border: 2px dashed #3498db;
      background: rgba(52, 144, 220, 0.1);
    }

    /* Category Management Styles */
    .category-section {
      margin-bottom: 30px;
    }

    .category-section h4 {
      margin: 0 0 15px 0;
      color: #2c3e50;
      font-size: 16px;
      font-weight: 600;
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
    }

    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.2s ease;
    }

    .category-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }

    .category-info {
      flex: 1;
    }

    .category-names {
      margin-bottom: 5px;
    }

    .category-names strong {
      color: #2c3e50;
      font-size: 16px;
    }

    .category-internal-name {
      color: #6c757d;
      font-size: 14px;
      font-style: italic;
      margin-left: 8px;
    }

    .category-meta {
      font-size: 12px;
      color: #9aa0a6;
    }

    .category-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    /* Deposit Receipt Modal Styles */
    #depositReceiptModal .modal-content {
      max-height: 90vh;
      overflow-y: auto;
    }

    #depositReceiptModal label {
      font-weight: 600;
      color: #2c3e50;
      font-size: 14px;
      margin-bottom: 5px;
      display: block;
    }

    #depositReceiptModal input,
    #depositReceiptModal select,
    #depositReceiptModal textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    #depositReceiptModal input:focus,
    #depositReceiptModal select:focus,
    #depositReceiptModal textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 144, 220, 0.2);
    }

    #depositReceiptModal input:required:invalid {
      border-color: #e74c3c;
    }

    #depositReceiptModal input:required:valid {
      border-color: #27ae60;
    }

    /* Signature Canvas Styling */
    #signatureCanvas {
      border: 2px solid #3498db !important;
      border-radius: 8px !important;
      background: white !important;
      cursor: crosshair !important;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: border-color 0.3s ease;
    }

    #signatureCanvas:hover {
      border-color: #2980b9 !important;
    }

    #eSignatureSection {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
      border: 1px solid #3498db !important;
    }

    #eSignatureSection h4 {
      color: #2c3e50 !important;
      margin-bottom: 15px !important;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container header-flex">
      <a href="index.html" class="logo">
        <span class="logo-icon">
          <img src="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189839/473148050_10160452160655951_3047339032063400229_n_gnkdpz.jpg" alt="iLm Halal Student Halls Logo">
        </span>
        <span class="logo-text">iLm Halal Student Halls</span>
      </a>
      <nav class="desktop-nav">
        <a href="index.html">Public Site</a>
        <a href="booking.html">Booking Form</a>
        <a href="#" onclick="logout()" class="btn btn-outline">Logout</a>
      </nav>
    </div>
  </header>

  <!-- Admin Dashboard -->
  <div class="admin-container">
    <!-- Dashboard Header -->
    <div class="admin-header">
      <div>
        <h1 class="admin-title">Admin Dashboard</h1>
        <p style="margin: 5px 0 0 0; opacity: 0.9;">Manage student accommodation applications</p>
      </div>
      <div class="admin-stats">
        <div class="stat-card">
          <span class="stat-number" id="totalApplications">0</span>
          <span class="stat-label">Total Applications</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="newApplications">0</span>
          <span class="stat-label">New Today</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="pendingApplications">0</span>
          <span class="stat-label">Pending Review</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="approvedApplications">0</span>
          <span class="stat-label">Approved</span>
        </div>
      </div>
    </div>

    <!-- Dashboard Navigation Tabs -->
    <div class="dashboard-nav">
      <button class="dashboard-tab active" onclick="showSection('applications')">
        📋 Applications
      </button>
      <button class="dashboard-tab" onclick="showSection('documents')">
        📄 Document Management
      </button>
      <button class="dashboard-tab" onclick="showSection('students')">
        👥 Student Management
      </button>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Applications Section -->
      <div id="applicationsSection" class="section-content">
      <!-- Main Panel -->
      <div class="main-panel">
        <!-- Panel Header -->
        <div class="panel-header">
          <h2 class="panel-title">Applications</h2>
          <button class="btn btn-primary" onclick="refreshApplications()">
            🔄 Refresh
          </button>
        </div>

        <!-- Search and Filter Bar -->
        <div class="search-filter-bar">
          <input type="text" class="search-box" placeholder="Search by name, email, or application ID..." 
                 id="searchInput" onkeyup="filterApplications()">
          <select class="filter-select" id="statusFilter" onchange="filterApplications()">
            <option value="">All Statuses</option>
            <option value="new">New</option>
            <option value="review">Under Review</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
            <option value="archived">Archived</option>
          </select>
          <select class="filter-select" id="universityFilter" onchange="filterApplications()">
            <option value="">All Universities</option>
            <option value="abertay">Abertay University</option>
            <option value="dundee">University of Dundee</option>
            <option value="al-makhtoum">Al Makhtoum Institute</option>
            <option value="st-andrews">St Andrews University</option>
            <option value="dundee-angus-college">Dundee & Angus College</option>
            <option value="other">Other</option>
          </select>
        </div>

        <!-- Bulk Actions Bar -->
        <div class="bulk-actions-bar" id="bulkActionsBar">
          <span id="selectedCount">0 selected</span>
          <button class="btn btn-success" onclick="bulkApprove()">✅ Approve Selected</button>
          <button class="btn btn-danger" onclick="bulkReject()">❌ Reject Selected</button>
          <button class="btn btn-secondary" onclick="bulkArchive()">📦 Archive Selected</button>
          <button class="btn btn-danger" onclick="bulkDelete()">🗑️ Delete Selected</button>
          <button class="btn btn-info" onclick="bulkExport()">📊 Export Selected</button>
        </div>

        <!-- Applications Table -->
        <div style="overflow-x: auto;">
          <table class="applications-table">
            <thead>
              <tr>
                <th class="checkbox-column">
                  <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                </th>
                <th>Application ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>University</th>
                <th>Room Type</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="applicationsTableBody">
              <tr>
                <td colspan="9" class="loading">
                  Loading applications...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination">
          <!-- Pagination buttons will be generated here -->
        </div>
        </div>
      </div>

      <!-- Document Management Section -->
      <div id="documentsSection" class="section-content" style="display: none;">
        <!-- Main Panel -->
        <div class="main-panel">
          <!-- Panel Header -->
          <div class="panel-header">
            <h2 class="panel-title">📄 Document Management</h2>
            <div class="header-actions">
              <button class="btn btn-outline" onclick="showDocumentStats()">
                📊 Statistics
              </button>
              <button class="btn btn-secondary" onclick="showBulkDocumentActions()">
                📋 Bulk Actions
              </button>
              <button class="btn btn-primary" onclick="refreshDocuments()">
                🔄 Refresh
              </button>
            </div>
          </div>

          <!-- Document Statistics Cards -->
          <div id="documentStatsCards" class="stats-cards-container" style="display: none;">
            <div class="stat-card-mini">
              <div class="stat-icon">📄</div>
              <div class="stat-content">
                <div class="stat-number" id="totalDocumentsCount">0</div>
                <div class="stat-label">Total Documents</div>
              </div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-icon">🌐</div>
              <div class="stat-content">
                <div class="stat-number" id="sharedDocumentsCount">0</div>
                <div class="stat-label">Shared Documents</div>
              </div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-icon">👤</div>
              <div class="stat-content">
                <div class="stat-number" id="personalDocumentsCount">0</div>
                <div class="stat-label">Personal Documents</div>
              </div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-icon">💾</div>
              <div class="stat-content">
                <div class="stat-number" id="totalStorageUsed">0 MB</div>
                <div class="stat-label">Storage Used</div>
              </div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-icon">🏠</div>
              <div class="stat-content">
                <div class="stat-number" id="roomsWithDocuments">0</div>
                <div class="stat-label">Rooms with Documents</div>
              </div>
            </div>
          </div>

          <!-- Document Upload Form -->
          <div class="document-upload-section">
            <div class="section-header-with-toggle">
              <h3>📤 Upload New Document</h3>
              <button class="toggle-btn" onclick="toggleUploadForm()">
                <span id="uploadToggleIcon">▼</span>
              </button>
            </div>
            <div id="uploadFormContainer" class="upload-form-container">
              <form id="documentUploadForm" class="document-upload-form">
                <div class="form-row">
                  <div class="form-group">
                    <label for="documentTitle">📝 Document Title *</label>
                    <input type="text" id="documentTitle" name="title" required 
                           placeholder="Enter descriptive document title">
                  </div>
                  <div class="form-group">
                    <label for="documentFile">📁 Select File *</label>
                    <div class="file-input-wrapper">
                      <input type="file" id="documentFile" name="file" required 
                             accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.xls,.xlsx,.ppt,.pptx,.zip,.rar"
                             onchange="handleFileSelect(this)">
                      <div class="file-input-display">
                        <span id="fileNameDisplay">No file selected</span>
                        <span id="fileSizeDisplay"></span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="documentDescription">📋 Description (Optional)</label>
                    <textarea id="documentDescription" name="description" 
                              placeholder="Add a brief description of this document" rows="3"></textarea>
                  </div>
                  <div class="form-group">
                    <label for="documentCategory">🏷️ Category</label>
                    <select id="documentCategory" name="category">
                      <option value="">Select Category</option>
                      <option value="contracts">📄 Contracts & Agreements</option>
                      <option value="policies">📋 Policies & Rules</option>
                      <option value="forms">📝 Forms & Applications</option>
                      <option value="notices">📢 Notices & Announcements</option>
                      <option value="receipts">🧾 Receipts & Invoices</option>
                      <option value="maintenance">🔧 Maintenance & Repairs</option>
                      <option value="other">📂 Other</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <div class="document-type-selection">
                      <label class="radio-label">
                        <input type="radio" name="documentType" value="shared" id="sharedDocumentRadio" checked>
                        <span class="radio-custom"></span>
                        <span class="radio-text">🌐 Shared Document (visible to all students)</span>
                      </label>
                      <label class="radio-label">
                        <input type="radio" name="documentType" value="personal" id="personalDocumentRadio">
                        <span class="radio-custom"></span>
                        <span class="radio-text">👤 Personal Document (specific student only)</span>
                      </label>
                    </div>
                  </div>
                  <div class="form-group" id="roomNumberGroup" style="display: none;">
                    <label for="roomNumber">🏠 Room Number *</label>
                    <select id="roomNumber" name="roomNumber" required>
                      <option value="">Select Room Number</option>
                      <!-- Room options will be populated by JavaScript -->
                    </select>
                    <small class="form-help">Required for personal documents</small>
                  </div>
                </div>
                <div class="form-submit">
                  <button type="submit" class="btn btn-primary" id="uploadDocumentBtn">
                    <span class="btn-icon">📤</span>
                    <span class="btn-text">Upload Document</span>
                    <span class="btn-loading" style="display: none;">
                      <span class="loading-spinner-small"></span>
                      Uploading...
                    </span>
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="clearUploadForm()">
                    🗑️ Clear Form
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Documents List -->
          <div class="documents-list-section">
            <div class="section-header-with-actions">
              <h3>📂 Document Library</h3>
              <div class="view-options">
                <button class="view-btn active" onclick="setDocumentView('table')" data-view="table">
                  📋 Table
                </button>
                <button class="view-btn" onclick="setDocumentView('grid')" data-view="grid">
                  🔲 Grid
                </button>
              </div>
            </div>
            
            <!-- Enhanced Search and Filter Bar -->
            <div class="search-filter-bar enhanced">
              <div class="search-group">
                <div class="search-input-wrapper">
                  <input type="text" class="search-box" placeholder="Search documents by title, room, or description..." 
                         id="documentSearchInput" onkeyup="filterDocuments()">
                  <button class="search-clear-btn" onclick="clearDocumentSearch()" style="display: none;">✕</button>
                </div>
              </div>
              <div class="filter-group">
                <select class="filter-select" id="documentTypeFilter" onchange="filterDocuments()">
                  <option value="">📄 All Types</option>
                  <option value="shared">🌐 Shared Documents</option>
                  <option value="personal">👤 Personal Documents</option>
                </select>
                <select class="filter-select" id="documentCategoryFilter" onchange="filterDocuments()">
                  <option value="">🏷️ All Categories</option>
                  <option value="contracts">📄 Contracts</option>
                  <option value="policies">📋 Policies</option>
                  <option value="forms">📝 Forms</option>
                  <option value="notices">📢 Notices</option>
                  <option value="receipts">🧾 Receipts</option>
                  <option value="maintenance">🔧 Maintenance</option>
                  <option value="other">📂 Other</option>
                </select>
                <select class="filter-select" id="documentRoomFilter" onchange="filterDocuments()">
                  <option value="">🏠 All Rooms</option>
                  <!-- Room filter options will be populated by JavaScript -->
                </select>
                <select class="filter-select" id="documentSortFilter" onchange="filterDocuments()">
                  <option value="newest">📅 Newest First</option>
                  <option value="oldest">📅 Oldest First</option>
                  <option value="title">🔤 Title A-Z</option>
                  <option value="size">💾 File Size</option>
                </select>
              </div>
              <div class="action-group">
                <button class="btn btn-outline" onclick="exportDocumentsList()">
                  📊 Export List
                </button>
                <button class="btn btn-outline" onclick="toggleDocumentSelection()">
                  ☑️ Select All
                </button>
              </div>
            </div>
            
            <!-- Document View Container -->
            <div id="documentViewContainer">
              <!-- Table View -->
              <div id="documentTableView" class="documents-table-container">
                <table class="applications-table enhanced-table">
                  <thead>
                    <tr>
                      <th width="30">
                        <input type="checkbox" id="selectAllDocuments" onchange="toggleAllDocumentSelection()">
                      </th>
                      <th width="40">📄</th>
                      <th>Title & Description</th>
                      <th>Type & Category</th>
                      <th>Room</th>
                      <th>File Info</th>
                      <th>Upload Date</th>
                      <th width="120">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="documentsTableBody">
                    <tr>
                      <td colspan="8" class="loading">
                        <div class="loading-spinner"></div>
                        <span>Loading documents...</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Grid View -->
              <div id="documentGridView" class="documents-grid-container" style="display: none;">
                <div id="documentsGridBody" class="documents-grid">
                  <!-- Grid items will be populated here -->
                </div>
              </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
              <div class="bulk-actions-content">
                <span id="selectedDocumentsCount">0 documents selected</span>
                <div class="bulk-actions-buttons">
                  <button class="btn btn-secondary" onclick="downloadSelectedDocuments()">
                    📥 Download Selected
                  </button>
                  <button class="btn btn-info" onclick="moveSelectedDocuments()">
                    📁 Move/Copy
                  </button>
                  <button class="btn btn-danger" onclick="deleteSelectedDocuments()">
                    🗑️ Delete Selected
                  </button>
                  <button class="btn btn-outline" onclick="clearDocumentSelection()">
                    ✕ Clear Selection
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Student Management Section -->
      <div id="studentsSection" class="section-content" style="display: none;">
        <!-- Main Panel -->
        <div class="main-panel">
          <!-- Panel Header -->
          <div class="panel-header">
            <h2 class="panel-title">Student Management</h2>
            <button class="btn btn-primary" onclick="refreshStudents()">
              🔄 Refresh
            </button>
          </div>

          <!-- Student Registration Form -->
          <div class="student-registration-section">
            <h3>Register New Student</h3>
            <form id="studentRegistrationForm" class="student-registration-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="studentName">Full Name</label>
                  <input type="text" id="studentName" name="name" required 
                         placeholder="Enter student's full name">
                </div>
                <div class="form-group">
                  <label for="studentEmail">Student Email</label>
                  <input type="email" id="studentEmail" name="email" required 
                         placeholder="Enter student's email address">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="studentRoom">🏠 Room Number</label>
                  <select id="studentRoom" name="roomNumber" required>
                    <option value="">Select Room Number</option>
                    <!-- Room options will be populated by JavaScript -->
                  </select>
                </div>
                <div class="form-group">
                  <label for="tempPassword">Temporary Password</label>
                  <input type="password" id="tempPassword" name="password" required 
                         placeholder="Set temporary password (min 6 characters)">
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" id="registerStudentBtn" class="btn btn-primary">
                  👤 Register Student
                </button>
                <button type="button" onclick="generateRandomPassword()" class="btn btn-outline">
                  🎲 Generate Random Password
                </button>
              </div>
            </form>
          </div>

          <!-- Students List -->
          <div class="students-list-section">
            <h3>Registered Students <span id="studentCountBadge" class="count-badge" style="display: none;"></span></h3>
            <div class="filter-controls" style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
              <input type="text" id="studentSearchInput" placeholder="🔍 Search students by name or email..." 
                     oninput="filterStudents()" 
                     style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
              <select id="roomFilter" onchange="filterStudents()" 
                      style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 120px;">
                <option value="">All Rooms</option>
              </select>
              <button type="button" onclick="clearStudentFilters()" class="btn btn-outline btn-small" 
                      style="padding: 8px 12px; white-space: nowrap;">
                🔄 Clear Filters
              </button>
            </div>
            <div id="studentsTableContainer">
              <div class="loading-spinner"></div>
              <p>Loading students...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Side Panel -->
      <div class="side-panel">
        <!-- Quick Actions -->
        <div class="quick-actions">
          <h3 style="margin-top: 0;">Quick Actions</h3>
          <button class="quick-action-btn" onclick="exportApplications()">
            📊 Export All Data
          </button>
          <button class="quick-action-btn" onclick="showBulkActions()">
            📋 Bulk Actions
          </button>
          <button class="quick-action-btn secondary" onclick="showSettings()">
            ⚙️ Settings
          </button>
          <button class="quick-action-btn secondary" onclick="openBookingForm()">
            📝 Manual Entry
          </button>
          <button class="quick-action-btn" onclick="openDepositReceiptModal()">
            🧾 Generate Deposit Receipt
          </button>
          <button class="quick-action-btn secondary" onclick="openLogoUploadModal()">
            🖼️ Update Company Logo
          </button>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity">
          <h3 style="margin-top: 0;">Recent Activity</h3>
          <div id="recentActivityList">
            <div class="activity-item">
              <div class="activity-icon activity-new">📝</div>
              <div class="activity-text">New application from John Smith</div>
              <div class="activity-time">2h ago</div>
            </div>
            <div class="activity-item">
              <div class="activity-icon activity-update">✏️</div>
              <div class="activity-text">Updated Sarah Jones status</div>
              <div class="activity-time">4h ago</div>
            </div>
            <div class="activity-item">
              <div class="activity-icon activity-approve">✅</div>
              <div class="activity-text">Approved Mike Wilson application</div>
              <div class="activity-time">6h ago</div>
            </div>
          </div>
        </div>

        <!-- Privacy-Compliant Analytics -->
        <div class="analytics-panel">
          <h3 style="margin-top: 0;">Site Analytics (Privacy-Compliant)</h3>
          <div class="analytics-tabs">
            <button class="analytics-tab active" onclick="showAnalyticsTab('overview')">Overview</button>
            <button class="analytics-tab" onclick="showAnalyticsTab('performance')">Performance</button>
            <button class="analytics-tab" onclick="showAnalyticsTab('user-journey')">User Journey</button>
            <button class="analytics-tab" onclick="showAnalyticsTab('accessibility')">Accessibility</button>
      </div>
          
          <div class="analytics-content">
            <!-- Overview Tab -->
            <div id="analytics-overview" class="analytics-tab-content active">
              <div class="analytics-cards">
                <div class="analytics-card">
                  <div class="card-icon">👥</div>
                  <div class="card-number" id="activeVisitors">--</div>
                  <div class="card-label">Active Sessions (24h)</div>
                </div>
                <div class="analytics-card">
                  <div class="card-icon">📊</div>
                  <div class="card-number" id="avgPageTime">--</div>
                  <div class="card-label">Avg. Page Time</div>
                </div>
                <div class="analytics-card">
                  <div class="card-icon">🎯</div>
                  <div class="card-number" id="conversionRate">--</div>
                  <div class="card-label">Booking Conversion</div>
                </div>
                <div class="analytics-card">
                  <div class="card-icon">🔒</div>
                  <div class="card-number" id="privacyConsent">--</div>
                  <div class="card-label">Privacy Consent Rate</div>
                </div>
              </div>
              
              <div class="popular-features">
                <h4>Most Used Features</h4>
                <div class="feature-list" id="popularFeatures">
                  <div class="feature-item">
                    <span class="feature-name">Loading...</span>
                    <span class="feature-usage">--</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Performance Tab -->
            <div id="analytics-performance" class="analytics-tab-content">
              <div class="performance-metrics">
                <h4>Web Vitals</h4>
                <div class="vitals-grid">
                  <div class="vital-card">
                    <div class="vital-label">First Paint</div>
                    <div class="vital-value" id="firstPaint">--ms</div>
                    <div class="vital-status" id="firstPaintStatus">Good</div>
                  </div>
                  <div class="vital-card">
                    <div class="vital-label">LCP</div>
                    <div class="vital-value" id="largestContentfulPaint">--ms</div>
                    <div class="vital-status" id="lcpStatus">Good</div>
                  </div>
                  <div class="vital-card">
                    <div class="vital-label">CLS</div>
                    <div class="vital-value" id="cumulativeLayoutShift">--</div>
                    <div class="vital-status" id="clsStatus">Good</div>
                  </div>
                </div>
                
                <div class="performance-issues">
                  <h4>Performance Issues</h4>
                  <div class="issues-list" id="performanceIssues">
                    <div class="issue-item">
                      <span class="issue-type">No issues detected</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- User Journey Tab -->
            <div id="analytics-user-journey" class="analytics-tab-content">
              <div class="journey-flow">
                <h4>User Journey Flow</h4>
                <div class="journey-steps" id="journeySteps">
                  <div class="journey-step">
                    <div class="step-number">1</div>
                    <div class="step-name">Home Page</div>
                    <div class="step-percentage">100%</div>
                  </div>
                  <div class="journey-arrow">→</div>
                  <div class="journey-step">
                    <div class="step-number">2</div>
                    <div class="step-name">Gallery</div>
                    <div class="step-percentage">Loading...</div>
                  </div>
                  <div class="journey-arrow">→</div>
                  <div class="journey-step">
                    <div class="step-number">3</div>
                    <div class="step-name">Booking</div>
                    <div class="step-percentage">Loading...</div>
                  </div>
                </div>
                
                <div class="goal-completion">
                  <h4>Goal Completion Rates</h4>
                  <div class="goals-list" id="goalsList">
                    <div class="goal-item">
                      <span class="goal-name">Gallery Viewed</span>
                      <div class="goal-bar">
                        <div class="goal-progress" style="width: 0%"></div>
                      </div>
                      <span class="goal-percentage">0%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Accessibility Tab -->
            <div id="analytics-accessibility" class="analytics-tab-content">
              <div class="accessibility-insights">
                <h4>Accessibility Usage</h4>
                <div class="a11y-stats" id="accessibilityStats">
                  <div class="a11y-item">
                    <span class="a11y-icon">⌨️</span>
                    <span class="a11y-label">Keyboard Navigation</span>
                    <span class="a11y-percentage">--</span>
                  </div>
                  <div class="a11y-item">
                    <span class="a11y-icon">🔊</span>
                    <span class="a11y-label">Screen Reader Usage</span>
                    <span class="a11y-percentage">--</span>
                  </div>
                  <div class="a11y-item">
                    <span class="a11y-icon">🎨</span>
                    <span class="a11y-label">High Contrast</span>
                    <span class="a11y-percentage">--</span>
                  </div>
                  <div class="a11y-item">
                    <span class="a11y-icon">🎭</span>
                    <span class="a11y-label">Reduced Motion</span>
                    <span class="a11y-percentage">--</span>
                  </div>
                </div>
                
                <div class="form-analytics">
                  <h4>Form Completion Analysis</h4>
                  <div class="form-stats" id="formStats">
                    <div class="form-stat">
                      <span class="stat-label">Average Completion Time</span>
                      <span class="stat-value">--</span>
                    </div>
                    <div class="form-stat">
                      <span class="stat-label">Abandonment Rate</span>
                      <span class="stat-value">--</span>
                    </div>
                    <div class="form-stat">
                      <span class="stat-label">Most Common Errors</span>
                      <span class="stat-value">Loading...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="analytics-footer">
            <small>📊 All analytics are anonymized and privacy-compliant. Data is only collected with user consent.</small>
            <button class="btn btn-secondary" onclick="exportAnalytics()">📄 Export Analytics Report</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- View/Edit Application Modal -->
  <div id="applicationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Application Details</h3>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody">
        <!-- Application details will be loaded here -->
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        <button class="btn btn-info" onclick="downloadPDF()" id="pdfBtn">📄 Download PDF</button>
        <button class="btn btn-primary" onclick="saveApplication()" id="saveBtn">Save Changes</button>
        <button class="btn btn-success" onclick="approveApplication()" id="approveBtn">Approve</button>
        <button class="btn btn-danger" onclick="rejectApplication()" id="rejectBtn">Reject</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>System Settings</h3>
        <button class="close-modal" onclick="closeSettingsModal()">&times;</button>
      </div>
      <div id="settingsBody">
        <div class="settings-section">
          <h4>Notifications</h4>
          <div class="setting-item">
            <div>
              <div class="setting-label">Email Notifications</div>
              <div class="setting-description">Receive email notifications for new applications</div>
            </div>
            <div class="toggle-switch active" onclick="toggleSetting(this, 'emailNotifications')"></div>
          </div>
          <div class="setting-item">
            <div>
              <div class="setting-label">Browser Notifications</div>
              <div class="setting-description">Show browser notifications for real-time updates</div>
            </div>
            <div class="toggle-switch" onclick="toggleSetting(this, 'browserNotifications')"></div>
          </div>
        </div>
        
        <div class="settings-section">
          <h4>Display</h4>
          <div class="setting-item">
            <div>
              <div class="setting-label">Items per Page</div>
              <div class="setting-description">Number of applications to show per page</div>
            </div>
            <select id="itemsPerPageSetting" onchange="updateItemsPerPage()">
              <option value="10">10 items</option>
              <option value="20">20 items</option>
              <option value="50">50 items</option>
              <option value="100">100 items</option>
            </select>
          </div>
          <div class="setting-item">
            <div>
              <div class="setting-label">Auto Refresh</div>
              <div class="setting-description">Automatically refresh data every 30 seconds</div>
            </div>
            <div class="toggle-switch" onclick="toggleSetting(this, 'autoRefresh')"></div>
          </div>
        </div>
        
        <div class="settings-section">
          <h4>Data Management</h4>
          <div class="setting-item">
            <div>
              <div class="setting-label">Export Format</div>
              <div class="setting-description">Default format for data exports</div>
            </div>
            <select id="exportFormatSetting">
              <option value="csv">CSV Format</option>
              <option value="excel">Excel Format</option>
              <option value="json">JSON Format</option>
            </select>
          </div>
          <div class="setting-item">
            <div>
              <div class="setting-label">Show Test Data Button</div>
              <div class="setting-description">Display test data fill button on booking form for testing purposes</div>
            </div>
            <div class="toggle-switch" onclick="toggleSetting(this, 'showTestDataButton')"></div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Bulk Actions Modal -->
  <div id="bulkModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Bulk Actions</h3>
        <button class="close-modal" onclick="closeBulkModal()">&times;</button>
      </div>
      <div id="bulkBody">
        <p>Select multiple applications using the checkboxes, then choose an action:</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
          <button class="btn btn-success" onclick="bulkApprove()">✅ Approve Selected</button>
          <button class="btn btn-danger" onclick="bulkReject()">❌ Reject Selected</button>
          <button class="btn btn-secondary" onclick="bulkArchive()">📦 Archive Selected</button>
          <button class="btn btn-info" onclick="bulkExport()">📊 Export Selected</button>
          <button class="btn btn-primary" onclick="bulkChangeStatus()">🔄 Change Status</button>
          <button class="btn btn-danger" onclick="bulkDelete()">🗑️ Delete Selected</button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeBulkModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notification" class="notification"></div>

  <!-- Gallery Management Section -->
  <div class="admin-container" style="margin-top: 50px;">
    <div class="admin-header">
      <div>
        <h1 class="admin-title">Gallery Management</h1>
        <p style="margin: 5px 0 0 0; opacity: 0.9;">Manage photo gallery images and categories</p>
      </div>
      <div class="admin-stats">
        <div class="stat-card">
          <span class="stat-number" id="totalGalleryImages">0</span>
          <span class="stat-label">Total Images</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="visibleGalleryImages">0</span>
          <span class="stat-label">Visible Images</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="featuredGalleryImages">0</span>
          <span class="stat-label">Featured Images</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="totalGalleryCategories">0</span>
          <span class="stat-label">Categories</span>
        </div>
      </div>
    </div>

    <!-- Gallery Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Main Gallery Panel -->
      <div class="main-panel">
        <!-- Panel Header -->
        <div class="panel-header">
          <h2 class="panel-title">Gallery Images</h2>
          <div class="gallery-header-actions">
            <button class="btn btn-primary" onclick="openAddImageModal()">+ Add Image</button>
            <button class="btn btn-secondary" onclick="refreshGallery()">🔄 Refresh</button>
            <button class="btn btn-info" onclick="openDebugModal()">🔍 Debug</button>
          </div>
        </div>

        <!-- Gallery Filter Bar -->
        <div class="search-filter-bar">
          <input type="text" class="search-box" placeholder="Search by title, alt text, or URL..." 
                 id="gallerySearchInput" onkeyup="filterGalleryImages()">
          <select class="filter-select" id="galleryStatusFilter" onchange="filterGalleryImages()">
            <option value="">All Statuses</option>
            <option value="visible">Visible</option>
            <option value="hidden">Hidden</option>
            <option value="featured">Featured</option>
          </select>
          <select class="filter-select" id="galleryCategoryFilter" onchange="filterGalleryImages()">
            <option value="">All Categories</option>
            <!-- Categories will be loaded dynamically -->
          </select>
          <button class="btn btn-info" onclick="openCategoryModal()">📁 Manage Categories</button>
        </div>

        <!-- Bulk Actions Bar -->
        <div class="bulk-actions-bar" id="galleryBulkActionsBar" style="display: none;">
          <span id="gallerySelectedCount">0 selected</span>
          <button class="btn btn-success" onclick="bulkToggleVisibility()">👁️ Toggle Visibility</button>
          <button class="btn btn-warning" onclick="bulkSetFeatured()">⭐ Set Featured</button>
          <button class="btn btn-danger" onclick="bulkDeleteImages()">🗑️ Delete Selected</button>
          <button class="btn btn-secondary" onclick="clearGallerySelection()">Clear Selection</button>
        </div>

        <!-- Gallery Grid -->
        <div class="gallery-management-container">
          <div class="gallery-management-grid" id="galleryManagementGrid">
            <div class="gallery-loading">
              Loading gallery images...
            </div>
          </div>
        </div>

        <!-- Gallery Pagination -->
        <div class="pagination-container" id="galleryPaginationContainer">
          <!-- Pagination will be added here -->
        </div>
      </div>

      <!-- Gallery Side Panel -->
      <div class="side-panel">
        <!-- Quick Gallery Actions -->
        <div class="quick-actions">
          <h3 style="margin-top: 0;">Quick Actions</h3>
          <button class="quick-action-btn" onclick="openAddImageModal()">
            📷 Add New Image
          </button>
          <button class="quick-action-btn" onclick="openCategoryModal()">
            📁 Manage Categories
          </button>
          <button class="quick-action-btn secondary" onclick="renumberGalleryImages()">
            🔢 Renumber Images
          </button>
          <button class="quick-action-btn secondary" onclick="reorderGallery()">
            🔄 Reorder Images
          </button>
          <button class="quick-action-btn secondary" onclick="exportGallery()">
            📊 Export Gallery Data
          </button>
        </div>

        <!-- Gallery Analytics -->
        <div class="recent-activity">
          <h3 style="margin-top: 0;">Gallery Statistics</h3>
          <div id="galleryStatsContent">
            <div class="activity-item">
              <div class="activity-icon activity-info">📊</div>
              <div class="activity-text">Images by Category</div>
            </div>
            <div id="categoryBreakdown" style="margin: 10px 0; font-size: 0.9em;">
              <!-- Category breakdown will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Image Modal -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="imageModalTitle">Add New Image</h3>
        <button class="close-modal" onclick="closeImageModal()">&times;</button>
      </div>
      <form id="imageForm" onsubmit="saveGalleryImage(event)">
        <div id="imageModalBody">
          <input type="hidden" id="imageId" name="imageId">
          
          <div class="form-group">
            <label for="imageUrl">Image URL *</label>
            <input type="url" id="imageUrl" name="imageUrl" required placeholder="https://res.cloudinary.com/...">
            <small>Paste your Cloudinary URL here</small>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label for="imageTitle">Title</label>
              <input type="text" id="imageTitle" name="imageTitle" placeholder="e.g., Modern Kitchen">
            </div>
            <div class="form-group">
              <label for="imageCategory">Category *</label>
              <select id="imageCategory" name="imageCategory" required>
                <!-- Options will be loaded dynamically -->
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="imageAltText">Alt Text</label>
            <input type="text" id="imageAltText" name="imageAltText" placeholder="Descriptive text for accessibility">
            <small>Important for SEO and accessibility</small>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
            <div class="form-group">
              <label for="displayOrder">Display Order</label>
              <input type="number" id="displayOrder" name="displayOrder" min="0" placeholder="0">
              <small>Lower numbers appear first</small>
            </div>
            <div class="form-group">
              <div style="display: flex; gap: 20px; align-items: center; margin-top: 25px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="isVisible" name="isVisible" checked>
                  Visible on website
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="isFeatured" name="isFeatured">
                  Featured image
                </label>
              </div>
            </div>
          </div>

          <div class="image-preview" id="imagePreview" style="display: none; margin-top: 15px; text-align: center;">
            <img id="previewImg" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" onclick="closeImageModal()" class="btn btn-secondary">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Image</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Category Management Modal -->
  <div id="categoryModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Manage Gallery Categories</h3>
        <button class="close-modal" onclick="closeCategoryModal()">&times;</button>
      </div>
      <div id="categoryModalBody">
        <!-- Add New Category -->
        <div class="category-section">
          <h4>Add New Category</h4>
          <form id="categoryForm" onsubmit="saveCategory(event)" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end; margin-bottom: 20px;">
            <input type="hidden" id="categoryId" name="categoryId">
            <div class="form-group" style="margin: 0;">
              <label for="categoryName">Category Name (internal)</label>
              <input type="text" id="categoryName" name="categoryName" required placeholder="e.g., bedrooms" style="width: 100%;">
            </div>
            <div class="form-group" style="margin: 0;">
              <label for="categoryDisplayName">Display Name</label>
              <input type="text" id="categoryDisplayName" name="categoryDisplayName" required placeholder="e.g., Bedrooms" style="width: 100%;">
            </div>
            <button type="submit" class="btn btn-primary" id="categorySaveBtn">Add Category</button>
          </form>
        </div>

        <!-- Existing Categories -->
        <div class="category-section">
          <h4>Existing Categories</h4>
          <div id="categoryList" style="max-height: 400px; overflow-y: auto;">
          <!-- Categories will be loaded here -->
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeCategoryModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Debug Modal -->
  <div id="debugModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Gallery Debug Tools</h3>
        <button class="close-modal" onclick="closeDebugModal()">&times;</button>
      </div>
      <div id="debugModalBody">
        <div class="form-group">
          <label for="debugSearchTerm">Search for Image:</label>
          <input type="text" id="debugSearchTerm" placeholder="Enter image title, number, or URL fragment" style="width: 100%; padding: 8px; margin-bottom: 10px;">
          <button class="btn btn-primary" onclick="searchDebugImage()">🔍 Search</button>
        </div>
        
        <div class="form-group">
          <button class="btn btn-info" onclick="listRecentImages()">📋 List Recent 20 Images</button>
          <button class="btn btn-secondary" onclick="checkHiddenImages()">👁️ Check Hidden Images</button>
          <button class="btn btn-warning" onclick="validateImageUrls()">🔗 Validate URLs</button>
          <button class="btn btn-info" onclick="checkDisplayOrder()">🔢 Check Display Order</button>
        </div>
        
        <div id="debugResults" style="margin-top: 20px; max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeDebugModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Deposit Receipt Modal -->
  <div id="depositReceiptModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Generate Tenant Deposit Receipt</h3>
        <button class="close-modal" onclick="closeDepositReceiptModal()">&times;</button>
      </div>
      <div id="depositReceiptModalBody">
        <form id="depositReceiptForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <label for="tenantName">Tenant Full Name *</label>
              <input type="text" id="tenantName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
            </div>
            <div>
              <label for="tenantEmail">Tenant Email</label>
              <input type="email" id="tenantEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <label for="depositAmount">Deposit Amount (£) *</label>
              <input type="number" id="depositAmount" required min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
            </div>
            <div>
              <label for="receiptDate">Receipt Date *</label>
              <input type="date" id="receiptDate" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <label for="propertyAddress">Property Address *</label>
              <textarea id="propertyAddress" required rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px; resize: vertical;"></textarea>
            </div>
            <div>
              <label for="roomNumber">Room Number</label>
              <input type="text" id="roomNumber" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
              <label for="paymentMethod">Payment Method</label>
              <select id="paymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
                <option value="">Select Payment Method</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Cash">Cash</option>
                <option value="Cheque">Cheque</option>
                <option value="Card Payment">Card Payment</option>
                <option value="Online Payment">Online Payment</option>
              </select>
            </div>
            <div>
              <label for="receiptNumber">Receipt Number</label>
              <input type="text" id="receiptNumber" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;" placeholder="Auto-generated if empty">
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label for="depositSchemeInfo">Deposit Protection Information</label>
            <textarea id="depositSchemeInfo" rows="5" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px; resize: vertical;">Your deposit will be securely lodged with a government-approved tenancy deposit scheme in Scotland. This is a legal requirement designed to protect your money throughout your tenancy.

At the end of your stay, following the successful completion of all final inspections and "leaver checks," your deposit will be returned to you promptly, in accordance with the scheme's regulations. The scheme also provides an independent resolution service should any disputes arise regarding the deposit's return.</textarea>
            <small style="color: #666; margin-top: 5px; display: block;">This information will be included in the receipt automatically. You can edit this text if needed.</small>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label for="additionalNotes">Additional Notes</label>
            <textarea id="additionalNotes" rows="3" placeholder="Any additional information about the deposit..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px; resize: vertical;"></textarea>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label for="landlordName">Landlord/Representative Name</label>
            <input type="text" id="landlordName" value="iLm Halal Student Halls Management" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="addSignatureFields" checked style="transform: scale(1.2);">
              <span>Add signature fields to PDF (recommended for legal compliance)</span>
            </label>
          </div>
          
          <!-- Landlord E-Signature Section -->
          <div id="eSignatureSection" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
            <h4 style="margin: 0 0 15px 0; color: #2c3e50;">Landlord Electronic Signature (Optional)</h4>
            <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">As the landlord/representative, you can add your signature to confirm receipt of deposit.</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
              <div>
                <label for="eSignatureName">Your Full Name for Signature</label>
                <input type="text" id="eSignatureName" placeholder="Enter your full name for e-signature" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
              </div>
              <div>
                <label for="signatureDate">Signature Date</label>
                <input type="date" id="signatureDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
              </div>
              <button type="button" onclick="clearSignature()" class="btn btn-secondary" style="height: 42px;">Clear</button>
              <button type="button" onclick="testSignature()" class="btn btn-info" style="height: 42px; margin-left: 5px;">Test</button>
              <button type="button" onclick="debugSignature()" class="btn btn-warning" style="height: 42px; margin-left: 5px; font-size: 12px;">Debug</button>
            </div>
                          <canvas id="signatureCanvas" width="400" height="150" style="border: 1px solid #ddd; border-radius: 5px; margin-top: 10px; cursor: crosshair; background: white; width: 100%; max-width: 400px; height: 150px;"></canvas>
              <div id="signatureStatus" style="margin-top: 5px; font-size: 12px; color: #666; font-style: italic;">
                Draw your signature above or enter your name
              </div>
            <small style="color: #666; margin-top: 5px; display: block;">Draw your signature above or type your name in the field. This will be included in the landlord confirmation section of the receipt.</small>
          </div>
        </form>
        
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #3498db;">
          <small style="color: #666;">
            <strong>Note:</strong> This receipt will be generated with iLm Halal Student Halls branding and company information. 
            The receipt will be formatted as a professional PDF document suitable for legal and administrative purposes.
          </small>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" onclick="closeDepositReceiptModal()" class="btn btn-secondary">Cancel</button>
        <button type="button" onclick="generateDepositReceipt()" class="btn btn-primary" id="generateReceiptBtn">Generate Receipt PDF</button>
      </div>
    </div>
  </div>

  <!-- Logo Upload Modal -->
  <div id="logoUploadModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Update Company Logo</h3>
        <button class="close-modal" onclick="closeLogoUploadModal()">&times;</button>
      </div>
      <div id="logoUploadModalBody">
        <div style="margin-bottom: 20px;">
          <p style="color: #666; margin-bottom: 15px;">Upload a new company logo for deposit receipts. Recommended size: 300x200 pixels or similar aspect ratio.</p>
          
          <div style="margin-bottom: 15px;">
            <label for="logoFileInput">Select Logo File (PNG, JPG, or SVG)</label>
            <input type="file" id="logoFileInput" accept="image/*" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
          </div>
          
          <div id="logoPreview" style="display: none; margin-bottom: 15px; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 5px;">
            <img id="logoPreviewImg" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 5px;">
            <p style="margin: 10px 0 0 0; color: #666; font-size: 14px;">Preview</p>
          </div>
          
          <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #2196f3;">
            <small style="color: #1976d2;">
              <strong>Note:</strong> The logo will be stored securely in Supabase and used in all future deposit receipts. 
              For best results, use a high-quality image with a transparent background.
            </small>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" onclick="closeLogoUploadModal()" class="btn btn-secondary">Cancel</button>
        <button type="button" onclick="uploadLogo()" class="btn btn-primary" id="uploadLogoBtn" disabled>Upload Logo</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase Configuration
    // NOTE: These keys are safe to expose in frontend code
    // The ANON key is designed to be public and security is enforced by Row Level Security (RLS)
    const SUPABASE_URL = 'https://nrnbfevlbakvdeaswbbd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ybmJmZXZsYmFrdmRlYXN3YmJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MTIzODgsImV4cCI6MjA2NDM4ODM4OH0.3V7rTYNwxSsKA0etRgNgxvUgoULmqvppVtmSY9Hzr3M';
    
    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Application state
    let applications = [];
    let filteredApplications = [];
    let currentPage = 1;
    let itemsPerPage = 10;
    let currentApplicationId = null;
    let realtimeSubscription = null;

    // Gallery state
    let galleryImages = [];
    let filteredGalleryImages = [];
    let galleryCategories = [];
    let selectedGalleryImages = [];
    let currentGalleryPage = 1;
    let galleryItemsPerPage = 12;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      // Clear any sample data from localStorage on startup
      const savedApps = localStorage.getItem('ilm_applications');
      if (savedApps) {
        try {
          const parsedApps = JSON.parse(savedApps);
          const isSampleData = parsedApps.some(app => 
            app.email && app.email.includes('example.com')
          );
          if (isSampleData) {
            console.log('🗑️ Clearing sample data on startup');
            localStorage.removeItem('ilm_applications');
          }
        } catch (e) {
          console.log('🗑️ Clearing invalid localStorage data');
          localStorage.removeItem('ilm_applications');
        }
      }
      
      initializeDashboard();
      initializeNotifications();
    });

    async function initializeDashboard() {
      try {
        // Check authentication with Supabase
        if (!await checkAuthentication()) {
          return;
        }
        
        // Test Supabase connection
        console.log('🔌 Testing Supabase connection...');
        const { data, error } = await supabase.from('applications').select('count', { count: 'exact', head: true });
        if (error && error.code === '42P01') {
          // Table doesn't exist, create it
          await createApplicationsTable();
        } else if (error) {
          console.error('❌ Supabase connection error:', error);
          showNotification('Database connection failed. Trying to load applications anyway...', 'warning');
          // Don't return here, try to load applications anyway
        }
        
        console.log('✅ Supabase connected successfully');
        
        // Load applications from Supabase
        await loadApplications();
        
        // Set up real-time updates (non-blocking)
        setTimeout(() => {
          try {
        setupRealTimeUpdates();
          } catch (error) {
            console.warn('⚠️ Real-time setup failed, continuing without it:', error);
          }
        }, 1000);
        
        console.log('✅ Admin dashboard initialized with Supabase');
        
      } catch (error) {
        console.error('❌ Dashboard initialization error:', error);
        showNotification('Failed to initialize dashboard. Trying alternative loading...', 'warning');
        
        // Try to load applications anyway, even if initialization failed
        try {
          await loadApplications();
        } catch (loadError) {
          console.error('❌ Failed to load applications, using fallback:', loadError);
        await loadApplicationsFromLocalStorage();
        }
      }
    }

    // Initialize gallery management
    async function initializeGallery() {
      try {
        console.log('🖼️ Initializing gallery management...');
        
        // Load gallery data
        await loadGalleryCategories();
        await loadGalleryImages();
        
        console.log('✅ Gallery management initialized');
        
      } catch (error) {
        console.error('❌ Gallery initialization error:', error);
        showNotification('Failed to initialize gallery. Please refresh the page.', 'error');
      }
    }

    // Gallery Categories Functions
    async function loadGalleryCategories() {
      try {
        console.log('📁 Loading gallery categories from Supabase...');
        
        const { data, error } = await supabase
          .from('gallery_categories')
          .select('*')
          .eq('is_active', true)
          .order('display_order');

        if (error) throw error;

        galleryCategories = data || [];
        updateCategoryDropdowns();
        updateCategoryStats();
        
        console.log(`📁 Loaded ${galleryCategories.length} categories`);
        
      } catch (error) {
        console.error('❌ Error loading categories:', error);
        showNotification(`Error loading categories: ${error.message}`, 'error');
      }
    }

    function updateCategoryDropdowns() {
      const selects = ['imageCategory', 'galleryCategoryFilter'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          // Clear existing options (except "All Categories" for filter)
          if (selectId === 'galleryCategoryFilter') {
            select.innerHTML = '<option value="">All Categories</option>';
          } else {
            select.innerHTML = '<option value="">Select Category</option>';
          }
          
          // Add category options
          galleryCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.name;
            option.textContent = category.display_name;
            select.appendChild(option);
          });
        }
      });
    }

    function updateCategoryStats() {
      // Update category statistics
      console.log('📊 Updating category statistics...');
      
      try {
        // Update the category count in the gallery stats
        const categoryCount = galleryCategories.length;
        const categoryStatsElement = document.getElementById('totalGalleryCategories');
        if (categoryStatsElement) {
          categoryStatsElement.textContent = categoryCount;
        }
        
        // Calculate images per category if we have gallery images loaded
        if (typeof galleryImages !== 'undefined' && galleryImages.length > 0) {
          updateCategoryBreakdown();
        }
        
        console.log(`✅ Updated category stats: ${categoryCount} categories`);
        
      } catch (error) {
        console.error('❌ Error updating category stats:', error);
      }
    }

    // Gallery Images Functions
    async function loadGalleryImages() {
      try {
        console.log('🖼️ Loading gallery images from Supabase...');
        
        const { data, error } = await supabase
          .from('gallery_images')
          .select('*')
          .order('display_order')
          .order('created_at', { ascending: false });

        if (error) throw error;

        galleryImages = data || [];
        filteredGalleryImages = [...galleryImages];
        renderGalleryGrid();
        updateGalleryStats();
        updateCategoryBreakdown();
        
        console.log(`🖼️ Loaded ${galleryImages.length} gallery images`);
        showNotification(`Loaded ${galleryImages.length} gallery images`, 'success');
        
      } catch (error) {
        console.error('❌ Error loading gallery images:', error);
        showNotification(`Error loading gallery images: ${error.message}`, 'error');
      }
    }

    function renderGalleryGrid() {
      const grid = document.getElementById('galleryManagementGrid');
      
      if (filteredGalleryImages.length === 0) {
        grid.innerHTML = `
          <div class="gallery-loading">
            No gallery images found. 
            <button onclick="openAddImageModal()" class="btn btn-primary" style="margin-left: 10px;">Add First Image</button>
          </div>
        `;
        return;
      }

      const startIndex = (currentGalleryPage - 1) * galleryItemsPerPage;
      const endIndex = startIndex + galleryItemsPerPage;
      const pageImages = filteredGalleryImages.slice(startIndex, endIndex);

      grid.innerHTML = pageImages.map(image => createGalleryImageCard(image)).join('');
      updateGalleryPagination();
    }

    function createGalleryImageCard(image) {
      const isSelected = selectedGalleryImages.includes(image.id);
      const statusBadges = [];
      
      if (image.is_visible) statusBadges.push('<span class="gallery-status-badge gallery-status-visible">Visible</span>');
      else statusBadges.push('<span class="gallery-status-badge gallery-status-hidden">Hidden</span>');
      
      if (image.featured) statusBadges.push('<span class="gallery-status-badge gallery-status-featured">Featured</span>');

      const category = galleryCategories.find(cat => cat.name === image.category);
      const categoryDisplay = category ? category.display_name : image.category;

      return `
        <div class="gallery-image-card ${isSelected ? 'selected' : ''}" data-image-id="${image.id}">
          <div class="gallery-card-header">
            <img src="${image.url}" alt="${image.alt_text || image.title || 'Gallery image'}" 
                 class="gallery-card-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik02MCA2MFYxNDBIMTQwVjYwSDYwWk03MCA3MEgxMzBWMTMwSDcwVjcwWiIgZmlsbD0iI0NDQ0NDQyIvPgo8L3N2Zz4K'">
            
            <div class="gallery-card-status">
              ${statusBadges.join('')}
            </div>
            
            <input type="checkbox" class="gallery-card-checkbox" 
                   ${isSelected ? 'checked' : ''} 
                   onchange="toggleGalleryImageSelection('${image.id}')">
            
            <div class="gallery-card-overlay">
              <button class="gallery-card-action view" onclick="viewGalleryImage('${image.id}')">View</button>
              <button class="gallery-card-action edit" onclick="editGalleryImage('${image.id}')">Edit</button>
              <button class="gallery-card-action delete" onclick="deleteGalleryImage('${image.id}')">Delete</button>
            </div>
          </div>
          
          <div class="gallery-card-body">
            <div class="gallery-card-title">${image.title || 'Untitled'}</div>
            <div class="gallery-card-category">${categoryDisplay}</div>
            <div class="gallery-card-meta">
              <span>Order: <span class="gallery-card-order">${image.display_order}</span></span>
              <span>${new Date(image.created_at).toLocaleDateString()}</span>
            </div>
          </div>
        </div>
      `;
    }

    function updateGalleryStats() {
      const total = galleryImages.length;
      const visible = galleryImages.filter(img => img.is_visible).length;
      const featured = galleryImages.filter(img => img.featured).length;
      const categories = galleryCategories.length;

      document.getElementById('totalGalleryImages').textContent = total;
      document.getElementById('visibleGalleryImages').textContent = visible;
      document.getElementById('featuredGalleryImages').textContent = featured;
      document.getElementById('totalGalleryCategories').textContent = categories;
    }

    function updateCategoryBreakdown() {
      const breakdown = {};
      galleryImages.forEach(image => {
        breakdown[image.category] = (breakdown[image.category] || 0) + 1;
      });

      const breakdownHTML = Object.entries(breakdown)
        .sort(([,a], [,b]) => b - a)
        .map(([category, count]) => {
          const categoryObj = galleryCategories.find(cat => cat.name === category);
          const displayName = categoryObj ? categoryObj.display_name : category;
          return `<div style="display: flex; justify-content: space-between; padding: 2px 0;"><span>${displayName}</span><span>${count}</span></div>`;
        })
        .join('');

      document.getElementById('categoryBreakdown').innerHTML = breakdownHTML;
    }

    // Gallery Modal Functions
    function openAddImageModal() {
      document.getElementById('imageModalTitle').textContent = 'Add New Image';
      document.getElementById('imageForm').reset();
      document.getElementById('imageId').value = '';
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('imageModal').style.display = 'flex';
      
      // Initialize with first category if available
      if (galleryCategories.length > 0) {
        document.getElementById('imageCategory').value = galleryCategories[0].name;
      }
    }

    function editGalleryImage(imageId) {
      const image = galleryImages.find(img => img.id === imageId);
      if (!image) return;

      document.getElementById('imageModalTitle').textContent = 'Edit Image';
      document.getElementById('imageId').value = image.id;
      document.getElementById('imageUrl').value = image.url;
      document.getElementById('imageTitle').value = image.title || '';
      document.getElementById('imageAltText').value = image.alt_text || '';
      document.getElementById('imageCategory').value = image.category;
      document.getElementById('displayOrder').value = image.display_order;
      document.getElementById('isVisible').checked = image.is_visible;
      document.getElementById('isFeatured').checked = image.featured;
      
      // Show preview
      const preview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('previewImg');
      previewImg.src = image.url;
      preview.style.display = 'block';
      
      document.getElementById('imageModal').style.display = 'flex';
    }

    function closeImageModal() {
      document.getElementById('imageModal').style.display = 'none';
    }

    async function saveGalleryImage(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const imageId = formData.get('imageId');
      const isEdit = !!imageId;
      
      let displayOrder = parseInt(formData.get('displayOrder')) || 0;
      
      // If this is a new image and no display order specified, use next available number
      if (!isEdit && displayOrder === 0) {
        try {
          const { data: maxOrderData, error: maxError } = await supabase
            .from('gallery_images')
            .select('display_order')
            .order('display_order', { ascending: false, nullsFirst: false })
            .limit(1);
            
          if (!maxError && maxOrderData && maxOrderData.length > 0) {
            displayOrder = (maxOrderData[0].display_order || 0) + 1;
            console.log(`🔢 Auto-assigned display_order: ${displayOrder}`);
          } else {
            displayOrder = 1; // First image
          }
        } catch (error) {
          console.warn('Could not determine next display order, using 1');
          displayOrder = 1;
        }
      }
      
      const imageData = {
        url: formData.get('imageUrl'),
        title: formData.get('imageTitle') || null,
        alt_text: formData.get('imageAltText') || null,
        category: formData.get('imageCategory'),
        display_order: displayOrder,
        is_visible: formData.has('isVisible'),
        featured: formData.has('isFeatured')
      };

      try {
        let result;
        
        if (isEdit) {
          result = await supabase
            .from('gallery_images')
            .update(imageData)
            .eq('id', imageId);
        } else {
          result = await supabase
            .from('gallery_images')
            .insert([imageData]);
        }

        if (result.error) throw result.error;

        showNotification(`Image ${isEdit ? 'updated' : 'added'} successfully!`, 'success');
        closeImageModal();
        await loadGalleryImages();
        
      } catch (error) {
        console.error('❌ Error saving image:', error);
        showNotification(`Error saving image: ${error.message}`, 'error');
      }
    }

    async function deleteGalleryImage(imageId) {
      if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
        return;
      }

      try {
        const { error } = await supabase
          .from('gallery_images')
          .delete()
          .eq('id', imageId);

        if (error) throw error;

        showNotification('Image deleted successfully!', 'success');
        
        // Auto-renumber after deletion to maintain sequential order
        await renumberGalleryImages();
        
      } catch (error) {
        console.error('❌ Error deleting image:', error);
        showNotification(`Error deleting image: ${error.message}`, 'error');
      }
    }

    function viewGalleryImage(imageId) {
      const image = galleryImages.find(img => img.id === imageId);
      if (!image) return;
      
      // Open image in new tab
      window.open(image.url, '_blank');
    }

    // Gallery Selection Functions
    function toggleGalleryImageSelection(imageId) {
      const index = selectedGalleryImages.indexOf(imageId);
      if (index > -1) {
        selectedGalleryImages.splice(index, 1);
      } else {
        selectedGalleryImages.push(imageId);
      }
      
      updateGallerySelectionUI();
      renderGalleryGrid(); // Re-render to update selection state
    }

    function clearGallerySelection() {
      selectedGalleryImages = [];
      updateGallerySelectionUI();
      renderGalleryGrid();
    }

    function updateGallerySelectionUI() {
      const count = selectedGalleryImages.length;
      const bulkBar = document.getElementById('galleryBulkActionsBar');
      const countElement = document.getElementById('gallerySelectedCount');
      
      if (count > 0) {
        bulkBar.style.display = 'flex';
        countElement.textContent = `${count} selected`;
      } else {
        bulkBar.style.display = 'none';
      }
    }

    // Bulk Gallery Operations
    async function bulkToggleVisibility() {
      if (selectedGalleryImages.length === 0) return;
      
      try {
        // Toggle visibility for selected images
        const updates = selectedGalleryImages.map(async (imageId) => {
          const image = galleryImages.find(img => img.id === imageId);
          return supabase
            .from('gallery_images')
            .update({ is_visible: !image.is_visible })
            .eq('id', imageId);
        });
        
        await Promise.all(updates);
        
        showNotification(`Visibility toggled for ${selectedGalleryImages.length} images`, 'success');
        clearGallerySelection();
        await loadGalleryImages();
        
      } catch (error) {
        console.error('❌ Error in bulk toggle visibility:', error);
        showNotification(`Error updating visibility: ${error.message}`, 'error');
      }
    }

    async function bulkSetFeatured() {
      if (selectedGalleryImages.length === 0) return;
      
      try {
        const updates = selectedGalleryImages.map(imageId => 
          supabase
            .from('gallery_images')
            .update({ featured: true })
            .eq('id', imageId)
        );
        
        await Promise.all(updates);
        
        showNotification(`Set ${selectedGalleryImages.length} images as featured`, 'success');
        clearGallerySelection();
        await loadGalleryImages();
        
      } catch (error) {
        console.error('❌ Error in bulk set featured:', error);
        showNotification(`Error setting featured: ${error.message}`, 'error');
      }
    }

    async function bulkDeleteImages() {
      if (selectedGalleryImages.length === 0) return;
      
      if (!confirm(`Are you sure you want to delete ${selectedGalleryImages.length} images? This action cannot be undone.`)) {
        return;
      }
      
      try {
        const { error } = await supabase
          .from('gallery_images')
          .delete()
          .in('id', selectedGalleryImages);

        if (error) throw error;
        
        showNotification(`Deleted ${selectedGalleryImages.length} images successfully`, 'success');
        clearGallerySelection();
        
        // Auto-renumber after bulk deletion
        await renumberGalleryImages();
        
      } catch (error) {
        console.error('❌ Error in bulk delete:', error);
        showNotification(`Error deleting images: ${error.message}`, 'error');
      }
    }

    // Gallery Filtering and Search
    function filterGalleryImages() {
      const searchTerm = document.getElementById('gallerySearchInput').value.toLowerCase();
      const statusFilter = document.getElementById('galleryStatusFilter').value;
      const categoryFilter = document.getElementById('galleryCategoryFilter').value;
      
      filteredGalleryImages = galleryImages.filter(image => {
        const matchesSearch = !searchTerm || 
          (image.title && image.title.toLowerCase().includes(searchTerm)) ||
          (image.alt_text && image.alt_text.toLowerCase().includes(searchTerm)) ||
          image.url.toLowerCase().includes(searchTerm);
        
        const matchesStatus = !statusFilter ||
          (statusFilter === 'visible' && image.is_visible) ||
          (statusFilter === 'hidden' && !image.is_visible) ||
          (statusFilter === 'featured' && image.featured);
        
        const matchesCategory = !categoryFilter || image.category === categoryFilter;
        
        return matchesSearch && matchesStatus && matchesCategory;
      });
      
      currentGalleryPage = 1;
      renderGalleryGrid();
    }

    function updateGalleryPagination() {
      const container = document.getElementById('galleryPaginationContainer');
      const totalPages = Math.ceil(filteredGalleryImages.length / galleryItemsPerPage);
      
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let paginationHTML = '<div class="pagination-container">';
      
      // Previous button
      if (currentGalleryPage > 1) {
        paginationHTML += `<button onclick="changeGalleryPage(${currentGalleryPage - 1})" class="pagination-btn">❮ Previous</button>`;
      } else {
        paginationHTML += `<button class="pagination-btn" disabled>❮ Previous</button>`;
      }
      
      // Page info
      paginationHTML += `<div class="pagination-info">Page ${currentGalleryPage} of ${totalPages}</div>`;
      
      // Page numbers (show 5 pages max)
      const startPage = Math.max(1, currentGalleryPage - 2);
      const endPage = Math.min(totalPages, currentGalleryPage + 2);
      
      for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentGalleryPage;
        paginationHTML += `<button onclick="changeGalleryPage(${i})" class="pagination-btn ${isActive ? 'active' : ''}">${i}</button>`;
      }
      
      // Next button
      if (currentGalleryPage < totalPages) {
        paginationHTML += `<button onclick="changeGalleryPage(${currentGalleryPage + 1})" class="pagination-btn">Next ❯</button>`;
      } else {
        paginationHTML += `<button class="pagination-btn" disabled>Next ❯</button>`;
      }
      
      paginationHTML += '</div>';
      container.innerHTML = paginationHTML;
    }

    function changeGalleryPage(page) {
      // Store reorder mode state
      const wasInReorderMode = isReorderMode;
      
      currentGalleryPage = page;
      renderGalleryGrid();
      
      // Restore reorder mode if it was active
      if (wasInReorderMode) {
        setTimeout(() => {
          isReorderMode = true;
          enableReorderMode();
        }, 100);
      }
    }

    // Gallery Utility Functions
    function refreshGallery() {
      showNotification('Refreshing gallery...', 'info');
      loadGalleryImages();
    }

    function openCategoryModal() {
      document.getElementById('categoryModal').style.display = 'flex';
      loadCategoryList();
    }

    function closeCategoryModal() {
      document.getElementById('categoryModal').style.display = 'none';
      document.getElementById('categoryForm').reset();
      document.getElementById('categoryId').value = '';
      document.getElementById('categorySaveBtn').textContent = 'Add Category';
    }

    async function loadCategoryList() {
      try {
        const { data, error } = await supabase
          .from('gallery_categories')
          .select('*')
          .order('display_order')
          .order('created_at');

        if (error) throw error;

        const listContainer = document.getElementById('categoryList');
        
        if (data.length === 0) {
          listContainer.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No categories found. Add your first category above.</p>';
        return;
      }
      
        const categoryHTML = data.map((category, index) => `
          <div class="category-item" data-category-id="${category.id}">
          <div class="category-info">
              <div class="category-names">
                <strong>${category.display_name}</strong>
                <span class="category-internal-name">(${category.name})</span>
          </div>
              <div class="category-meta">
                Order: ${category.display_order || 'N/A'} | 
                Status: ${category.is_active ? 'Active' : 'Inactive'} |
                Created: ${new Date(category.created_at).toLocaleDateString()}
              </div>
            </div>
          <div class="category-actions">
              <button class="btn-small btn-edit" onclick="editCategory('${category.id}')">Edit</button>
              <button class="btn-small ${category.is_active ? 'btn-archive' : 'btn-view'}" onclick="toggleCategoryStatus('${category.id}')">${category.is_active ? 'Deactivate' : 'Activate'}</button>
              <button class="btn-small btn-delete" onclick="deleteCategory('${category.id}')">Delete</button>
          </div>
        </div>
      `).join('');

        listContainer.innerHTML = categoryHTML;

      } catch (error) {
        console.error('Error loading categories:', error);
        showNotification(`Error loading categories: ${error.message}`, 'error');
      }
    }

    function filterByCategory(categoryName) {
      document.getElementById('galleryCategoryFilter').value = categoryName;
      filterGalleryImages();
      closeCategoryModal();
    }

    function exportGallery() {
      const data = galleryImages.map(image => ({
        title: image.title,
        url: image.url,
        category: image.category,
        alt_text: image.alt_text,
        display_order: image.display_order,
        is_visible: image.is_visible,
        featured: image.featured,
        created_at: image.created_at
      }));
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gallery-export-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      showNotification('Gallery data exported successfully!', 'success');
    }

    // Reorder Gallery Implementation
    function reorderGallery() {
      // Switch to reorder mode
      isReorderMode = !isReorderMode;
      
      if (isReorderMode) {
        showNotification('Reorder mode enabled - drag images to reorder or click to edit position', 'info');
        enableReorderMode();
      } else {
        showNotification('Reorder mode disabled', 'info');
        disableReorderMode();
      }
    }

    function enableReorderMode() {
      const cards = document.querySelectorAll('.gallery-image-card');
      cards.forEach(card => {
        card.style.cursor = 'move';
        card.draggable = true;
        
        // Remove any existing indicators first
        const existingIndicator = card.querySelector('.reorder-indicator');
        if (existingIndicator) existingIndicator.remove();
        
        // Add reorder indicator
        const indicator = document.createElement('div');
        indicator.className = 'reorder-indicator';
        indicator.innerHTML = '⠿ Drag to reorder or click to edit';
        card.appendChild(indicator);
        
        // Remove existing listeners to prevent duplicates
        card.removeEventListener('dragstart', handleDragStart);
        card.removeEventListener('dragover', handleDragOver);
        card.removeEventListener('drop', handleDrop);
        card.removeEventListener('dragend', handleDragEnd);
        card.removeEventListener('click', handlePositionEdit);
        
        // Add drag event listeners
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragend', handleDragEnd);
        
        // Add click to edit position
        card.addEventListener('click', handlePositionEdit);
      });
      
      // Update reorder button
      const reorderBtn = document.querySelector('[onclick="reorderGallery()"]');
      if (reorderBtn) {
        reorderBtn.textContent = '✅ Finish Reordering';
        reorderBtn.style.background = '#27ae60';
        reorderBtn.style.color = 'white';
      }
      
      // Show reorder instructions
      showNotification('Reorder mode active: Drag images to new positions or click to enter specific position. You can make multiple changes.', 'info');
    }

    function disableReorderMode() {
      const cards = document.querySelectorAll('.gallery-image-card');
      cards.forEach(card => {
        card.style.cursor = 'default';
        card.draggable = false;
        
        // Remove reorder indicator
        const indicator = card.querySelector('.reorder-indicator');
        if (indicator) indicator.remove();
        
        // Remove drag event listeners
        card.removeEventListener('dragstart', handleDragStart);
        card.removeEventListener('dragover', handleDragOver);
        card.removeEventListener('drop', handleDrop);
        card.removeEventListener('dragend', handleDragEnd);
        card.removeEventListener('click', handlePositionEdit);
      });
      
      // Update reorder button
      const reorderBtn = document.querySelector('[onclick="reorderGallery()"]');
      if (reorderBtn) {
        reorderBtn.textContent = '🔄 Reorder Images';
        reorderBtn.style.background = '';
      }
    }

    let draggedElement = null;
    let isReorderMode = false;

    function handleDragStart(e) {
      if (!isReorderMode) return;
      draggedElement = e.target.closest('.gallery-image-card');
      e.dataTransfer.effectAllowed = 'move';
      draggedElement.style.opacity = '0.5';
    }

    function handleDragOver(e) {
      if (!isReorderMode) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      // Add visual feedback for drop target
      const dropTarget = e.target.closest('.gallery-image-card');
      if (dropTarget && dropTarget !== draggedElement) {
        dropTarget.classList.add('drag-over');
      }
    }

    function handleDrop(e) {
      if (!isReorderMode) return;
      e.preventDefault();
      
      // Remove drag-over class from all cards
      document.querySelectorAll('.gallery-image-card').forEach(card => {
        card.classList.remove('drag-over');
      });
      
      const dropTarget = e.target.closest('.gallery-image-card');
      if (dropTarget && dropTarget !== draggedElement) {
        // Get positions
        const draggedId = draggedElement.getAttribute('data-image-id');
        const targetId = dropTarget.getAttribute('data-image-id');
        
        const draggedImage = galleryImages.find(img => img.id == draggedId);
        const targetImage = galleryImages.find(img => img.id == targetId);
        
        if (draggedImage && targetImage) {
          swapImagePositions(draggedImage, targetImage);
        }
      }
    }

    function handleDragEnd(e) {
      if (draggedElement) {
        draggedElement.style.opacity = '1';
        draggedElement = null;
      }
      
      // Remove drag-over class from all cards
      document.querySelectorAll('.gallery-image-card').forEach(card => {
        card.classList.remove('drag-over');
      });
    }

    function handlePositionEdit(e) {
      if (!isReorderMode) return;
      e.preventDefault();
      
      const card = e.target.closest('.gallery-image-card');
      const imageId = card.getAttribute('data-image-id');
      const image = galleryImages.find(img => img.id == imageId);
      
      if (image) {
        const newPosition = prompt(`Enter new position for "${image.title || 'Untitled'}" (current: ${image.display_order}):`);
        if (newPosition && !isNaN(newPosition)) {
          moveImageToPosition(image, parseInt(newPosition));
        }
      }
    }

    async function swapImagePositions(image1, image2) {
      try {
        const temp = image1.display_order;
        
        // Update in database
        await Promise.all([
          supabase.from('gallery_images').update({ display_order: image2.display_order }).eq('id', image1.id),
          supabase.from('gallery_images').update({ display_order: temp }).eq('id', image2.id)
        ]);
        
        // Update local data immediately for better UX
        image1.display_order = image2.display_order;
        image2.display_order = temp;
        
        showNotification(`Swapped positions of "${image1.title || 'Untitled'}" and "${image2.title || 'Untitled'}"`, 'success');
        
        // Refresh the display without exiting reorder mode
        await loadGalleryImages();
        
        // If still in reorder mode, re-enable it
        if (isReorderMode) {
          setTimeout(() => {
            enableReorderMode();
          }, 100);
        }
        
      } catch (error) {
        console.error('Error swapping positions:', error);
        showNotification(`Error swapping positions: ${error.message}`, 'error');
      }
    }

    async function moveImageToPosition(image, newPosition) {
      try {
        // Update the image's position
        await supabase
          .from('gallery_images')
          .update({ display_order: newPosition })
          .eq('id', image.id);
          
        showNotification(`Moved "${image.title || 'Untitled'}" to position ${newPosition}`, 'success');
        
        // Store reorder mode state
        const wasInReorderMode = isReorderMode;
        
        // Renumber to fix any conflicts
        await renumberGalleryImages();
        
        // Restore reorder mode if it was active
        if (wasInReorderMode) {
          setTimeout(() => {
            isReorderMode = true;
            enableReorderMode();
          }, 100);
        }
        
      } catch (error) {
        console.error('Error moving image:', error);
        showNotification(`Error moving image: ${error.message}`, 'error');
      }
    }

    // Initialize gallery when page loads
    window.addEventListener('load', function() {
      setTimeout(initializeGallery, 2000); // Initialize after main dashboard
    });

    // Image URL preview functionality
    document.addEventListener('DOMContentLoaded', function() {
      const imageUrlInput = document.getElementById('imageUrl');
      if (imageUrlInput) {
        imageUrlInput.addEventListener('input', function() {
          const url = this.value;
          const preview = document.getElementById('imagePreview');
          const previewImg = document.getElementById('previewImg');
          
          if (url && url.startsWith('http')) {
            previewImg.src = url;
            preview.style.display = 'block';
          } else {
            preview.style.display = 'none';
          }
        });
      }
    });

    async function createApplicationsTable() {
      console.log('📊 Creating applications table in Supabase...');
      
      // Note: Table creation should be done via Supabase SQL editor
      // This is just for error handling - table should exist
      showNotification('Database table not found. Please run the SQL setup script.', 'error');
      
      // For reference, the SQL to create the table:
      /*
      CREATE TABLE IF NOT EXISTS applications (
        id TEXT PRIMARY KEY,
        first_name TEXT,
        last_name TEXT,
        email TEXT,
        phone TEXT,
        date_of_birth DATE,
        gender TEXT,
        nationality TEXT,
        university TEXT,
        course_of_study TEXT,
        year_of_study TEXT,
        room_type TEXT,
        check_in_date DATE,
        contract_length TEXT,
        status TEXT DEFAULT 'new',
        submission_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        home_address TEXT,
        room_preferences TEXT,
        dietary_requirements TEXT,
        medical_conditions TEXT,
        reference_name TEXT,
        reference_email TEXT,
        reference_telephone TEXT,
        guarantor_name TEXT,
        guarantor_email TEXT,
        guarantor_telephone TEXT,
        emergency_name TEXT,
        emergency_phone TEXT,
        emergency_email TEXT,
        parking_required BOOLEAN DEFAULT FALSE,
        additional_info TEXT,
        notes TEXT,
        last_modified TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
      );
      
      -- Create indexes for better performance
      CREATE INDEX IF NOT EXISTS idx_applications_status ON applications(status);
      CREATE INDEX IF NOT EXISTS idx_applications_submission_date ON applications(submission_date);
      CREATE INDEX IF NOT EXISTS idx_applications_email ON applications(email);
      
      -- Enable Row Level Security (RLS)
      ALTER TABLE applications ENABLE ROW LEVEL SECURITY;
      
      -- Create policy to allow all operations for authenticated users
      CREATE POLICY "Enable all operations for authenticated users" ON applications
        FOR ALL USING (true);
      */
    }

    async function checkAuthentication() {
      try {
        // Check Supabase auth session
        const { data: { user }, error } = await supabase.auth.getUser();
        
        if (error) {
          console.error('❌ Auth check error:', error);
          redirectToLogin();
          return false;
        }
        
        if (!user) {
          console.log('No authenticated user found');
          redirectToLogin();
          return false;
        }
        
        // Check if user email is authorized (lowercase for case-insensitive comparison)
        const authorizedEmails = [
          'rosehouse.ilm@outlook.com',
          'ilmstudenthalls@gmail.com'
        ];
        
        if (!authorizedEmails.includes(user.email.toLowerCase())) {
          console.error('❌ Unauthorized email:', user.email);
          await supabase.auth.signOut();
          alert('Your email address is not authorized for admin access.');
          redirectToLogin();
          return false;
        }
        
        console.log('✅ Authenticated admin user:', user.email);
        
        // Update UI with user info
        updateUserInfo(user);
        
        // Set up auth state listener
        setupAuthListener();
        
        return true;
        
      } catch (error) {
        console.error('❌ Authentication check failed:', error);
        redirectToLogin();
        return false;
      }
    }

    function redirectToLogin() {
      console.log('🔐 Redirecting to login...');
      
      // Clear any stored auth data
      localStorage.removeItem('admin_authenticated');
      localStorage.removeItem('admin_email');
      
      // Redirect to login
      window.location.href = 'admin.html';
    }

    function updateUserInfo(user) {
      // Update any UI elements with user info
      const userEmail = user.email;
      console.log('📧 Logged in as:', userEmail);
      
      // You can update UI elements here if needed
      // For example, show user email in header
    }

    function setupAuthListener() {
      // Listen for auth state changes
      supabase.auth.onAuthStateChange(async (event, session) => {
        console.log('🔄 Auth state change:', event, session?.user?.email);
        
        if (event === 'SIGNED_OUT' || !session) {
          console.log('🚪 User signed out, redirecting...');
          redirectToLogin();
        } else if (event === 'SIGNED_IN') {
          console.log('🔑 User signed in:', session.user.email);
          updateUserInfo(session.user);
        }
      });
    }

    async function loadApplications() {
      try {
        showLoading();
        
        console.log('📊 Loading applications from Supabase...');
        
        // Fetch applications from Supabase
        const { data, error } = await supabase
          .from('applications')
          .select('*')
          .order('submission_date', { ascending: false });
        
        if (error) {
          throw error;
        }
        
        // Convert snake_case to camelCase for compatibility
        applications = data.map(app => ({
          id: app.id,
          firstName: app.first_name || '',
          lastName: app.last_name || '',
          email: app.email || '',
          phone: app.phone || '',
          dateOfBirth: app.date_of_birth || '',
          gender: app.gender || '',
          nationality: app.nationality || '',
          university: app.university || '',
          courseOfStudy: app.course_of_study || '',
          yearOfStudy: app.year_of_study || '',
          roomType: app.room_type || '',
          checkInDate: app.check_in_date || '',
          contractLength: app.contract_length || '',
          status: app.status || 'new',
          submissionDate: app.submission_date || app.created_at,
          homeAddress: app.home_address || '',
          roomPreferences: app.room_preferences || '',
          dietaryRequirements: app.dietary_requirements || '',
          medicalConditions: app.medical_conditions || '',
          referenceName: app.reference_name || '',
          referenceEmail: app.reference_email || '',
          referenceTelephone: app.reference_telephone || '',
          guarantorName: app.guarantor_name || '',
          guarantorEmail: app.guarantor_email || '',
          guarantorTelephone: app.guarantor_telephone || '',
          emergencyName: app.emergency_name || '',
          emergencyPhone: app.emergency_phone || '',
          emergencyEmail: app.emergency_email || '',
          parkingRequired: app.parking_required || false,
          additionalInfo: app.additional_info || '',
          notes: app.notes || '',
          lastModified: app.last_modified || app.created_at,
          createdAt: app.created_at
        }));
        
        filteredApplications = [...applications];
        updateStats();
        renderApplicationsTable();
        renderPagination();
        updateRecentActivity();
        
        console.log(`📊 Loaded ${applications.length} applications from Supabase`);
        if (applications.length === 0) {
          showNotification('No applications found in database', 'info');
        } else {
        showNotification(`Loaded ${applications.length} applications`, 'success');
        }
        
      } catch (error) {
        console.error('❌ Error loading applications:', error);
        
        // Handle different types of errors appropriately
        if (error.code === '42P01') {
          console.log('📋 Applications table not found, showing empty state');
          applications = [];
          filteredApplications = [];
          updateStats();
          renderApplicationsTable();
          renderPagination();
          updateRecentActivity();
          showNotification('Applications table not found. Please run the database setup.', 'warning');
        } else {
          console.log('📱 Loading from localStorage as fallback...');
          console.error('❌ Database error:', error);
          showNotification(`Database error: ${error.message}. Loading offline data.`, 'warning');
        await loadApplicationsFromLocalStorage();
        }
      }
    }

    async function loadApplicationsFromLocalStorage() {
      console.log('📱 Loading from localStorage as fallback...');
      const savedApplications = localStorage.getItem('ilm_applications');
      
      if (savedApplications) {
        const parsedApps = JSON.parse(savedApplications);
        
        // Check if this is sample data (contains example.com emails)
        const isSampleData = parsedApps.some(app => 
          app.email && app.email.includes('example.com')
        );
        
        if (isSampleData) {
          console.log('🗑️ Clearing sample data from localStorage');
          localStorage.removeItem('ilm_applications');
          
          // Show empty state instead of sample data
          applications = [];
          filteredApplications = [];
          updateStats();
          renderApplicationsTable();
          renderPagination();
          updateRecentActivity();
          showNotification('No applications found. Database connection required.', 'warning');
        } else {
          applications = parsedApps;
        filteredApplications = [...applications];
        updateStats();
        renderApplicationsTable();
        renderPagination();
        updateRecentActivity();
        showNotification('Loaded offline data', 'info');
        }
      } else {
        // Show empty state instead of generating sample data
        applications = [];
        filteredApplications = [];
        updateStats();
        renderApplicationsTable();
        renderPagination();
        updateRecentActivity();
        showNotification('No applications found. Please check database connection.', 'warning');
      }
    }

    async function saveApplicationsToLocalStorage() {
      localStorage.setItem('ilm_applications', JSON.stringify(applications));
    }

    function generateSampleData() {
      const sampleApplications = [
        {
          id: 'APP-2024-001',
          firstName: 'John',
          lastName: 'Smith',
          email: 'john.smith@example.com',
          phone: '07123456789',
          university: 'dundee',
          courseOfStudy: 'Computer Science',
          roomType: 'single-with-wc',
          status: 'new',
          submissionDate: new Date().toISOString(),
          checkInDate: '2024-09-15',
          notes: ''
        },
        {
          id: 'APP-2024-002',
          firstName: 'Sarah',
          lastName: 'Jones',
          email: 'sarah.jones@example.com',
          phone: '07987654321',
          university: 'abertay',
          courseOfStudy: 'Business Studies',
          roomType: 'single-en-suite',
          status: 'review',
          submissionDate: new Date(Date.now() - 86400000).toISOString(),
          checkInDate: '2024-09-10',
          notes: 'Documents pending'
        },
        {
          id: 'APP-2024-003',
          firstName: 'Mike',
          lastName: 'Wilson',
          email: 'mike.wilson@example.com',
          phone: '07555123456',
          university: 'st-andrews',
          courseOfStudy: 'Medicine',
          roomType: 'double-with-wc',
          status: 'approved',
          submissionDate: new Date(Date.now() - 172800000).toISOString(),
          checkInDate: '2024-09-01',
          notes: 'Approved - payment pending'
        }
      ];
      
      return sampleApplications;
    }

    function updateStats() {
      const total = applications.length;
      const newToday = applications.filter(app => {
        const today = new Date().toDateString();
        return new Date(app.submissionDate).toDateString() === today;
      }).length;
      const pending = applications.filter(app => app.status === 'new' || app.status === 'review').length;
      const approved = applications.filter(app => app.status === 'approved').length;

      document.getElementById('totalApplications').textContent = total;
      document.getElementById('newApplications').textContent = newToday;
      document.getElementById('pendingApplications').textContent = pending;
      document.getElementById('approvedApplications').textContent = approved;
    }

    function renderApplicationsTable() {
      const tbody = document.getElementById('applicationsTableBody');
      
      if (filteredApplications.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="empty-state">
              <div class="empty-state-icon">📋</div>
              <div>No applications found</div>
            </td>
          </tr>
        `;
        return;
      }

      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageApplications = filteredApplications.slice(startIndex, endIndex);

      tbody.innerHTML = pageApplications.map(app => `
        <tr>
          <td><input type="checkbox" class="select-checkbox" data-id="${app.id}" onchange="updateBulkActions()"></td>
          <td><strong>${app.id}</strong></td>
          <td>${app.firstName} ${app.lastName}</td>
          <td><a href="mailto:${app.email}">${app.email}</a></td>
          <td>${getUniversityName(app.university)}</td>
          <td>${getRoomTypeName(app.roomType)}</td>
          <td><span class="status-badge status-${app.status}">${getStatusName(app.status)}</span></td>
          <td>${formatDate(app.submissionDate)}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-small btn-view" onclick="viewApplication('${app.id}')">👁️ View</button>
              <button class="btn-small btn-edit" onclick="editApplication('${app.id}')">✏️ Edit</button>
              <button class="btn-small btn-pdf" onclick="downloadApplicationPDF('${app.id}')">📄 PDF</button>
              <button class="btn-small btn-delete" onclick="deleteApplication('${app.id}')">🗑️ Delete</button>
              <button class="btn-small btn-archive" onclick="archiveApplication('${app.id}')">📦 Archive</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function renderPagination() {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(filteredApplications.length / itemsPerPage);
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let paginationHTML = '';
      
      // Previous button
      if (currentPage > 1) {
        paginationHTML += `<button onclick="changePage(${currentPage - 1})">Previous</button>`;
      }
      
      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        paginationHTML += `<button class="${activeClass}" onclick="changePage(${i})">${i}</button>`;
      }
      
      // Next button
      if (currentPage < totalPages) {
        paginationHTML += `<button onclick="changePage(${currentPage + 1})">Next</button>`;
      }
      
      pagination.innerHTML = paginationHTML;
    }

    function changePage(page) {
      currentPage = page;
      renderApplicationsTable();
      renderPagination();
    }

    function filterApplications() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const universityFilter = document.getElementById('universityFilter').value;

      filteredApplications = applications.filter(app => {
        const matchesSearch = !searchTerm || 
          app.firstName.toLowerCase().includes(searchTerm) ||
          app.lastName.toLowerCase().includes(searchTerm) ||
          app.email.toLowerCase().includes(searchTerm) ||
          app.id.toLowerCase().includes(searchTerm);
        
        const matchesStatus = !statusFilter || app.status === statusFilter;
        const matchesUniversity = !universityFilter || app.university === universityFilter;

        return matchesSearch && matchesStatus && matchesUniversity;
      });

      currentPage = 1;
      renderApplicationsTable();
      renderPagination();
    }

    function refreshApplications() {
      showNotification('Refreshing applications...', 'info');
      loadApplications();
    }

    function viewApplication(applicationId) {
      const app = applications.find(a => a.id === applicationId);
      if (!app) return;

      currentApplicationId = applicationId;
      document.getElementById('modalTitle').textContent = `Application Details - ${app.id}`;
      
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <div class="form-grid">
          <!-- Personal Information Section -->
          <div class="form-section form-grid-full">
            <h4>Personal Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Application ID</label>
                <input type="text" value="${app.id}" readonly>
              </div>
              <div class="form-group">
                <label>Status</label>
                <select id="editStatus">
                  <option value="new" ${app.status === 'new' ? 'selected' : ''}>New</option>
                  <option value="review" ${app.status === 'review' ? 'selected' : ''}>Under Review</option>
                  <option value="approved" ${app.status === 'approved' ? 'selected' : ''}>Approved</option>
                  <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                  <option value="archived" ${app.status === 'archived' ? 'selected' : ''}>Archived</option>
                </select>
              </div>
              <div class="form-group">
                <label>First Name</label>
                <input type="text" id="editFirstName" value="${app.firstName || ''}">
              </div>
              <div class="form-group">
                <label>Middle Name</label>
                <input type="text" id="editMiddleName" value="${app.middleName || ''}">
              </div>
              <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="editLastName" value="${app.lastName || ''}">
              </div>
              <div class="form-group">
                <label>Date of Birth</label>
                <input type="date" id="editDateOfBirth" value="${app.dateOfBirth || ''}">
              </div>
              <div class="form-group">
                <label>Gender</label>
                <select id="editGender">
                  <option value="">Select Gender</option>
                  <option value="male" ${app.gender === 'male' ? 'selected' : ''}>Male</option>
                  <option value="female" ${app.gender === 'female' ? 'selected' : ''}>Female</option>
                </select>
              </div>
              <div class="form-group">
                <label>Nationality</label>
                <input type="text" id="editNationality" value="${app.nationality || ''}">
              </div>
              <div class="form-group">
                <label>Passport/ID Number</label>
                <input type="text" id="editPassportNumber" value="${app.passportNumber || ''}">
              </div>
            </div>
          </div>

          <!-- Contact Information Section -->
          <div class="form-section form-grid-full">
            <h4>Contact Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="editEmail" value="${app.email || ''}">
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="editPhone" value="${app.phone || ''}">
              </div>
              <div class="form-group form-grid-full">
                <label>Home Address</label>
                <textarea id="editHomeAddress">${app.homeAddress || ''}</textarea>
              </div>
            </div>
          </div>

          <!-- Academic Information Section -->
          <div class="form-section form-grid-full">
            <h4>Academic Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>University</label>
                <select id="editUniversity">
                  <option value="abertay" ${app.university === 'abertay' ? 'selected' : ''}>Abertay University</option>
                  <option value="dundee" ${app.university === 'dundee' ? 'selected' : ''}>University of Dundee</option>
                  <option value="al-makhtoum" ${app.university === 'al-makhtoum' ? 'selected' : ''}>Al Makhtoum Institute</option>
                  <option value="st-andrews" ${app.university === 'st-andrews' ? 'selected' : ''}>St Andrews University</option>
                  <option value="dundee-angus-college" ${app.university === 'dundee-angus-college' ? 'selected' : ''}>Dundee & Angus College</option>
                  <option value="other" ${app.university === 'other' ? 'selected' : ''}>Other</option>
                </select>
              </div>
              <div class="form-group">
                <label>Course of Study</label>
                <input type="text" id="editCourse" value="${app.courseOfStudy || ''}">
              </div>
              <div class="form-group">
                <label>Student ID</label>
                <input type="text" id="editStudentId" value="${app.studentId || ''}">
              </div>
              <div class="form-group">
                <label>Year of Study</label>
                <select id="editYearOfStudy">
                  <option value="">Select Year</option>
                  <option value="1" ${app.yearOfStudy === '1' ? 'selected' : ''}>1st Year</option>
                  <option value="2" ${app.yearOfStudy === '2' ? 'selected' : ''}>2nd Year</option>
                  <option value="3" ${app.yearOfStudy === '3' ? 'selected' : ''}>3rd Year</option>
                  <option value="4" ${app.yearOfStudy === '4' ? 'selected' : ''}>4th Year</option>
                  <option value="5" ${app.yearOfStudy === '5' ? 'selected' : ''}>5th Year</option>
                  <option value="postgraduate" ${app.yearOfStudy === 'postgraduate' ? 'selected' : ''}>Postgraduate</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Accommodation Information Section -->
          <div class="form-section form-grid-full">
            <h4>Accommodation Preferences</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Room Type</label>
                <select id="editRoomType">
                  <option value="single-no-wc" ${app.roomType === 'single-no-wc' ? 'selected' : ''}>Single Room – no WC (£160/week)</option>
                  <option value="single-with-wc" ${app.roomType === 'single-with-wc' ? 'selected' : ''}>Single Room – with WC (£165/week)</option>
                  <option value="single-en-suite" ${app.roomType === 'single-en-suite' ? 'selected' : ''}>Single Room – with en-suite (£190/week)</option>
                  <option value="double-with-wc" ${app.roomType === 'double-with-wc' ? 'selected' : ''}>Double Room – with WC (£190/week)</option>
                </select>
              </div>
              <div class="form-group">
                <label>Check-in Date</label>
                <input type="date" id="editCheckInDate" value="${app.checkInDate || ''}">
              </div>
              <div class="form-group">
                <label>Contract Length</label>
                <input type="text" id="editContractLength" value="${app.contractLength || ''}">
              </div>
              <div class="form-group">
                <label>Parking Required</label>
                <select id="editParkingRequired">
                  <option value="false" ${!app.parkingRequired ? 'selected' : ''}>No</option>
                  <option value="true" ${app.parkingRequired ? 'selected' : ''}>Yes (+£20/week)</option>
                </select>
              </div>
              <div class="form-group">
                <label>Bike Storage Required</label>
                <select id="editBikeStorage">
                  <option value="false" ${!app.bikeStorageRequired ? 'selected' : ''}>No</option>
                  <option value="true" ${app.bikeStorageRequired ? 'selected' : ''}>Yes</option>
                </select>
              </div>
              <div class="form-group form-grid-full">
                <label>Room Preferences</label>
                <textarea id="editRoomPreferences">${app.roomPreferences || ''}</textarea>
              </div>
            </div>
          </div>

          <!-- Lifestyle Information Section -->
          <div class="form-section form-grid-full">
            <h4>Lifestyle & Dietary Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Dietary Requirements</label>
                <input type="text" id="editDietaryRequirements" value="${app.dietaryRequirements || ''}">
              </div>
              <div class="form-group">
                <label>Medical Conditions</label>
                <input type="text" id="editMedicalConditions" value="${app.medicalConditions || ''}">
              </div>
              <div class="form-group form-grid-full">
                <label>Additional Information</label>
                <textarea id="editAdditionalInfo">${app.additionalInfo || ''}</textarea>
              </div>
            </div>
          </div>

          <!-- Reference Information Section -->
          <div class="form-section form-grid-full">
            <h4>Reference Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Reference Name</label>
                <input type="text" id="editReferenceName" value="${app.referenceName || ''}">
              </div>
              <div class="form-group">
                <label>Reference Relationship</label>
                <input type="text" id="editReferenceRelationship" value="${app.referenceRelationship || ''}">
              </div>
              <div class="form-group">
                <label>Reference Email</label>
                <input type="email" id="editReferenceEmail" value="${app.referenceEmail || ''}">
              </div>
              <div class="form-group">
                <label>Reference Phone</label>
                <input type="tel" id="editReferenceTelephone" value="${app.referenceTelephone || ''}">
              </div>
            </div>
          </div>

          <!-- Guarantor Information Section -->
          <div class="form-section form-grid-full">
            <h4>Guarantor Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Guarantor Name</label>
                <input type="text" id="editGuarantorName" value="${app.guarantorName || ''}">
              </div>
              <div class="form-group">
                <label>Guarantor Relationship</label>
                <input type="text" id="editGuarantorRelationship" value="${app.guarantorRelationship || ''}">
              </div>
              <div class="form-group">
                <label>Guarantor Email</label>
                <input type="email" id="editGuarantorEmail" value="${app.guarantorEmail || ''}">
              </div>
              <div class="form-group">
                <label>Guarantor Phone</label>
                <input type="tel" id="editGuarantorTelephone" value="${app.guarantorTelephone || ''}">
              </div>
              <div class="form-group form-grid-full">
                <label>Guarantor Address</label>
                <textarea id="editGuarantorAddress">${app.guarantorAddress || ''}</textarea>
              </div>
            </div>
          </div>

          <!-- Emergency Contact Section -->
          <div class="form-section form-grid-full">
            <h4>Emergency Contact</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Emergency Contact Name</label>
                <input type="text" id="editEmergencyName" value="${app.emergencyName || ''}">
              </div>
              <div class="form-group">
                <label>Emergency Relationship</label>
                <input type="text" id="editEmergencyRelation" value="${app.emergencyRelation || ''}">
              </div>
              <div class="form-group">
                <label>Emergency Phone</label>
                <input type="tel" id="editEmergencyPhone" value="${app.emergencyPhone || ''}">
              </div>
              <div class="form-group">
                <label>Emergency Email</label>
                <input type="email" id="editEmergencyEmail" value="${app.emergencyEmail || ''}">
              </div>
            </div>
          </div>

          <!-- Admin Notes Section -->
          <div class="form-section form-grid-full">
            <h4>Admin Notes</h4>
            <div class="form-group">
              <label>Notes</label>
              <textarea id="editNotes">${app.notes || ''}</textarea>
            </div>
          </div>
        </div>
      `;

      document.getElementById('applicationModal').style.display = 'block';
    }

    function editApplication(applicationId) {
      viewApplication(applicationId);
    }

    async function saveApplication() {
      if (!currentApplicationId) return;

      try {
        const updateData = {
          status: document.getElementById('editStatus').value,
          first_name: document.getElementById('editFirstName').value,
          middle_name: document.getElementById('editMiddleName').value,
          last_name: document.getElementById('editLastName').value,
          date_of_birth: document.getElementById('editDateOfBirth').value || null,
          gender: document.getElementById('editGender').value,
          nationality: document.getElementById('editNationality').value,
          passport_number: document.getElementById('editPassportNumber').value,
          email: document.getElementById('editEmail').value,
          phone: document.getElementById('editPhone').value,
          home_address: document.getElementById('editHomeAddress').value,
          university: document.getElementById('editUniversity').value,
          course_of_study: document.getElementById('editCourse').value,
          student_id: document.getElementById('editStudentId').value,
          year_of_study: document.getElementById('editYearOfStudy').value,
          room_type: document.getElementById('editRoomType').value,
          check_in_date: document.getElementById('editCheckInDate').value || null,
          contract_length: document.getElementById('editContractLength').value,
          parking_required: document.getElementById('editParkingRequired').value === 'true',
          bike_storage_required: document.getElementById('editBikeStorage').value === 'true',
          room_preferences: document.getElementById('editRoomPreferences').value,
          dietary_requirements: document.getElementById('editDietaryRequirements').value,
          medical_conditions: document.getElementById('editMedicalConditions').value,
          additional_info: document.getElementById('editAdditionalInfo').value,
          reference_name: document.getElementById('editReferenceName').value,
          reference_relationship: document.getElementById('editReferenceRelationship').value,
          reference_email: document.getElementById('editReferenceEmail').value,
          reference_telephone: document.getElementById('editReferenceTelephone').value,
          guarantor_name: document.getElementById('editGuarantorName').value,
          guarantor_relationship: document.getElementById('editGuarantorRelationship').value,
          guarantor_email: document.getElementById('editGuarantorEmail').value,
          guarantor_telephone: document.getElementById('editGuarantorTelephone').value,
          guarantor_address: document.getElementById('editGuarantorAddress').value,
          emergency_name: document.getElementById('editEmergencyName').value,
          emergency_relation: document.getElementById('editEmergencyRelation').value,
          emergency_phone: document.getElementById('editEmergencyPhone').value,
          emergency_email: document.getElementById('editEmergencyEmail').value,
          notes: document.getElementById('editNotes').value,
          last_modified: new Date().toISOString()
        };

        console.log('💾 Updating application in Supabase:', currentApplicationId);

        const { data, error } = await supabase
          .from('applications')
          .update(updateData)
          .eq('id', currentApplicationId);

        if (error) {
          throw error;
        }

        closeModal();
        showNotification('Application updated successfully!', 'success');

        // Update will be handled by real-time subscription
        
      } catch (error) {
        console.error('❌ Error updating application:', error);
        showNotification(`Error updating application: ${error.message}`, 'error');
      }
    }

    async function approveApplication() {
      if (!currentApplicationId) return;
      
      try {
        console.log('✅ Approving application:', currentApplicationId);

        const { data, error } = await supabase
          .from('applications')
          .update({
            status: 'approved',
            last_modified: new Date().toISOString()
          })
          .eq('id', currentApplicationId);

        if (error) {
          throw error;
        }

        closeModal();
        showNotification('Application approved!', 'success');
        
      } catch (error) {
        console.error('❌ Error approving application:', error);
        showNotification(`Error approving application: ${error.message}`, 'error');
      }
    }

    async function rejectApplication() {
      if (!currentApplicationId) return;
      
      if (!confirm('Are you sure you want to reject this application?')) return;
      
      try {
        console.log('❌ Rejecting application:', currentApplicationId);

        const { data, error } = await supabase
          .from('applications')
          .update({
            status: 'rejected',
            last_modified: new Date().toISOString()
          })
          .eq('id', currentApplicationId);

        if (error) {
          throw error;
        }

        closeModal();
        showNotification('Application rejected', 'info');
        
      } catch (error) {
        console.error('❌ Error rejecting application:', error);
        showNotification(`Error rejecting application: ${error.message}`, 'error');
      }
    }

    async function deleteApplication(applicationId) {
      if (!confirm('Are you sure you want to delete this application? This action cannot be undone.')) {
        return;
      }

      try {
        console.log('🗑️ Deleting application:', applicationId);

        const { data, error } = await supabase
          .from('applications')
          .delete()
          .eq('id', applicationId);

        if (error) {
          throw error;
        }

        showNotification('Application deleted', 'info');
        
      } catch (error) {
        console.error('❌ Error deleting application:', error);
        showNotification(`Error deleting application: ${error.message}`, 'error');
      }
    }

    async function archiveApplication(applicationId) {
      try {
        console.log('📦 Archiving application:', applicationId);

        const { data, error } = await supabase
          .from('applications')
          .update({
            status: 'archived',
            last_modified: new Date().toISOString()
          })
          .eq('id', applicationId);

        if (error) {
          throw error;
        }

        showNotification('Application archived', 'info');
        
      } catch (error) {
        console.error('❌ Error archiving application:', error);
        showNotification(`Error archiving application: ${error.message}`, 'error');
      }
    }

    async function exportApplications() {
      try {
        // Get fresh data from Supabase
        const { data, error } = await supabase
          .from('applications')
          .select('*')
          .order('submission_date', { ascending: false });

        if (error) {
          throw error;
        }

        const formattedData = data.map(formatApplicationFromDB);
        const csvContent = generateCompleteCSV(formattedData);
        downloadCSV(csvContent, `ilm-all-applications-${new Date().toISOString().split('T')[0]}.csv`);
        showNotification('All applications exported successfully!', 'success');
        
      } catch (error) {
        console.error('❌ Export error:', error);
        // Fallback to current data
        const csvContent = generateCompleteCSV(applications);
        downloadCSV(csvContent, `ilm-applications-export-${new Date().toISOString().split('T')[0]}.csv`);
        showNotification('Applications exported (cached data)', 'info');
      }
    }

    function formatApplicationFromDB(dbApp) {
      return {
        id: dbApp.id,
        firstName: dbApp.first_name || '',
        lastName: dbApp.last_name || '',
        email: dbApp.email || '',
        phone: dbApp.phone || '',
        dateOfBirth: dbApp.date_of_birth || '',
        gender: dbApp.gender || '',
        nationality: dbApp.nationality || '',
        university: dbApp.university || '',
        courseOfStudy: dbApp.course_of_study || '',
        yearOfStudy: dbApp.year_of_study || '',
        roomType: dbApp.room_type || '',
        checkInDate: dbApp.check_in_date || '',
        contractLength: dbApp.contract_length || '',
        status: dbApp.status || 'new',
        submissionDate: dbApp.submission_date || dbApp.created_at,
        homeAddress: dbApp.home_address || '',
        roomPreferences: dbApp.room_preferences || '',
        dietaryRequirements: dbApp.dietary_requirements || '',
        medicalConditions: dbApp.medical_conditions || '',
        referenceName: dbApp.reference_name || '',
        referenceEmail: dbApp.reference_email || '',
        referenceTelephone: dbApp.reference_telephone || '',
        guarantorName: dbApp.guarantor_name || '',
        guarantorEmail: dbApp.guarantor_email || '',
        guarantorTelephone: dbApp.guarantor_telephone || '',
        emergencyName: dbApp.emergency_name || '',
        emergencyPhone: dbApp.emergency_phone || '',
        emergencyEmail: dbApp.emergency_email || '',
        parkingRequired: dbApp.parking_required || false,
        additionalInfo: dbApp.additional_info || '',
        notes: dbApp.notes || '',
        lastModified: dbApp.last_modified || dbApp.created_at,
        createdAt: dbApp.created_at
      };
    }

    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function closeModal() {
      document.getElementById('applicationModal').style.display = 'none';
      currentApplicationId = null;
    }

    // Deposit Receipt Functions
    function openDepositReceiptModal() {
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('receiptDate').value = today;
      document.getElementById('signatureDate').value = today;
      
      // Generate receipt number
      const receiptNumber = 'DR-' + Date.now().toString().substr(-8);
      document.getElementById('receiptNumber').value = receiptNumber;
      
      // Set default property address
      document.getElementById('propertyAddress').value = 'iLm Halal Student Halls\n16-18 Constitution Terrace\nDundee, DD3 6JE\nScotland, United Kingdom';
      
      // Show modal
      document.getElementById('depositReceiptModal').style.display = 'flex';
      
      // FORCE immediate canvas initialization
      console.log('🚀 Forcing signature canvas initialization...');
      
      // Try multiple times to ensure canvas is ready
      setTimeout(() => {
        console.log('📋 First canvas init attempt...');
        initializeSignatureCanvas();
      }, 50);
      
      setTimeout(() => {
        console.log('📋 Second canvas init attempt...');
        initializeSignatureCanvas();
        
        // Add event listener for name input
        const nameInput = document.getElementById('eSignatureName');
        if (nameInput) {
          nameInput.addEventListener('input', updateSignatureStatus);
          nameInput.addEventListener('blur', updateSignatureStatus);
        }
        
        // Initial status update
        updateSignatureStatus();
      }, 200);
      
      setTimeout(() => {
        console.log('📋 Final canvas init attempt...');
        initializeSignatureCanvas();
      }, 500);
      
      // Initialize signature canvas after modal is shown
      setTimeout(() => {
        initializeSignatureCanvas();
      }, 100);
    }

    function closeDepositReceiptModal() {
      document.getElementById('depositReceiptModal').style.display = 'none';
      document.getElementById('depositReceiptForm').reset();
    }

    // Function to wait for jsPDF to load with retries
    async function waitForJsPDF(maxRetries = 10, delay = 500) {
      for (let i = 0; i < maxRetries; i++) {
        if (window.jspdf && window.jspdf.jsPDF) {
          console.log(`✅ jsPDF loaded successfully after ${i + 1} attempts`);
          return true;
        }
        
        if (window.jsPDFLoadError) {
          throw new Error('PDF library failed to load from all CDN sources. Please check your internet connection and try again.');
        }
        
        console.log(`⏳ Waiting for jsPDF to load... attempt ${i + 1}/${maxRetries}`);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
      
      // Last resort: try to manually download and execute jsPDF
      try {
        console.log('🔄 Attempting manual jsPDF download as last resort...');
        const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js');
        const jsCode = await response.text();
        
        // Create a script element and execute the code
        const script = document.createElement('script');
        script.text = jsCode;
        document.head.appendChild(script);
        
        // Wait a bit for execution
        await new Promise(resolve => setTimeout(resolve, 500));
        
        if (window.jspdf && window.jspdf.jsPDF) {
          console.log('✅ Manual jsPDF download successful');
          return true;
        }
      } catch (manualError) {
        console.error('Manual jsPDF download failed:', manualError);
      }
      
      throw new Error('PDF library loading failed completely. Please check your internet connection and refresh the page.');
    }

    async function generateDepositReceipt() {
      console.log('🚀 generateDepositReceipt() called');
      
      // Get form data
      const tenantName = document.getElementById('tenantName').value.trim();
      const tenantEmail = document.getElementById('tenantEmail').value.trim();
      const depositAmount = document.getElementById('depositAmount').value;
      const receiptDate = document.getElementById('receiptDate').value;
      const propertyAddress = document.getElementById('propertyAddress').value.trim();
      const roomNumber = document.getElementById('roomNumber').value.trim();
      const paymentMethod = document.getElementById('paymentMethod').value;
      const receiptNumber = document.getElementById('receiptNumber').value.trim();
      const additionalNotes = document.getElementById('additionalNotes').value.trim();
      const depositSchemeInfo = document.getElementById('depositSchemeInfo').value.trim();
      const landlordName = document.getElementById('landlordName').value.trim();
      const addSignatureFields = document.getElementById('addSignatureFields').checked;
      const eSignatureName = document.getElementById('eSignatureName').value.trim();
      const signatureDate = document.getElementById('signatureDate').value;

      // Validate required fields
      if (!tenantName || !depositAmount || !receiptDate || !propertyAddress) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }

      try {
        // Disable button and show loading state
        const generateBtn = document.getElementById('generateReceiptBtn');
        generateBtn.disabled = true;
        generateBtn.textContent = 'Generating PDF...';
        
        showNotification('Generating deposit receipt...', 'info');

        // Wait for jsPDF to load with retry mechanism
        await waitForJsPDF();
        
        // Initialize jsPDF with error handling
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          throw new Error('jsPDF constructor not available. Please check your internet connection and refresh the page.');
        }
        
        const doc = new jsPDF();
        console.log('✅ jsPDF initialized successfully');
        
        // Color scheme - Using exact same blue as main site
        const primaryBlue = [47, 41, 112]; // #2F2970 - Main site primary color
        const accentBlue = [75, 41, 150]; // #4B2996 - Gradient accent
        const lightGray = [248, 249, 250];
        const darkGray = [108, 117, 125];

        // Add modern header background
        doc.setFillColor(...lightGray);
        doc.rect(0, 0, 210, 60, 'F');

        // Load logo from Supabase or use fallback
        await loadLogoAndGenerate();

        async function loadLogoAndGenerate() {
          // Validate signature before generating PDF
          console.log('🔍 Validating signature before PDF generation...');
          validateSignature();
          
          let logoDataUrl = null;
          
          // Try multiple logo file extensions and handle Supabase errors gracefully
          const logoFiles = ['logo/ilm-logo.png', 'logo/ilm-logo.jpg', 'logo/ilm-logo.jpeg', 'logo/ilm-logo.svg'];
          
          if (typeof supabase !== 'undefined' && supabase.storage) {
            for (const logoFile of logoFiles) {
              try {
                console.log(`🔍 Attempting to load ${logoFile} from Supabase...`);
                
                // Add timeout to prevent hanging
                const downloadPromise = supabase.storage
                  .from('assets')
                  .download(logoFile);
                  
                const timeoutPromise = new Promise((_, reject) => 
                  setTimeout(() => reject(new Error('Supabase download timeout')), 5000)
                );
                
                const { data, error } = await Promise.race([downloadPromise, timeoutPromise]);
                
                if (data && !error && data.size > 0) {
                  console.log(`✅ Logo found: ${logoFile}, size: ${data.size} bytes`);
                  
                  // Convert blob to data URL with validation
                  logoDataUrl = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                      const result = reader.result;
                      if (result && result.length > 100) { // Basic validation
                        resolve(result);
                      } else {
                        reject(new Error('Invalid logo data'));
                      }
                    };
                    reader.onerror = () => reject(new Error('FileReader error'));
                    reader.readAsDataURL(data);
                  });
                  
                  console.log('✅ Logo converted successfully');
                  break; // Found valid logo, stop searching
                }
              } catch (error) {
                console.log(`⚠️ Failed to load ${logoFile}:`, error.message);
                // Continue to next logo file or fallback
              }
            }
          } else {
            console.log('⚠️ Supabase not available, using fallback logo');
          }
          
          // If no logo from Supabase, create a professional text logo
          if (!logoDataUrl) {
            console.log('🎨 Creating fallback text logo...');
            try {
              logoDataUrl = createTextLogo();
              console.log('✅ Fallback text logo created');
            } catch (logoError) {
              console.log('⚠️ Failed to create text logo:', logoError);
              logoDataUrl = null; // Will generate PDF without logo
            }
          }
          
          console.log('📄 Starting PDF content generation...');
          generatePDFContent(logoDataUrl);
        }

        function createTextLogo() {
          try {
            // Create a professional text-based logo
            const canvas = document.createElement('canvas');
            if (!canvas || !canvas.getContext) {
              throw new Error('Canvas not supported');
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
              throw new Error('Canvas 2D context not available');
            }
            
            canvas.width = 120;
            canvas.height = 60;
            
            // Background with gradient
            const gradient = ctx.createLinearGradient(0, 0, 120, 60);
            gradient.addColorStop(0, '#2c3e50');
            gradient.addColorStop(1, '#3498db');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 120, 60);
            
            // Add border
            ctx.strokeStyle = '#ecf0f1';
            ctx.lineWidth = 2;
            ctx.strokeRect(1, 1, 118, 58);
            
            // Main text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 18px Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('iLm', 60, 25);
            
            // Subtitle
            ctx.font = 'bold 8px Arial, sans-serif';
            ctx.fillText('HALAL STUDENT HALLS', 60, 42);
            
            // Add small decorative element
            ctx.fillStyle = '#f39c12';
            ctx.beginPath();
            ctx.arc(60, 52, 2, 0, 2 * Math.PI);
            ctx.fill();
            
            const dataUrl = canvas.toDataURL('image/png');
            if (!dataUrl || !dataUrl.startsWith('data:image')) {
              throw new Error('Failed to generate valid logo data URL');
            }
            
            return dataUrl;
          } catch (error) {
            console.error('Error creating text logo:', error);
            throw error;
          }
        }

        function generatePDFContent(logoDataUrl = null) {
          try {
            console.log('🖼️ Adding logo to PDF...');
            // Add logo if available
            if (logoDataUrl) {
              try {
                // Validate logo data before adding
                if (typeof logoDataUrl === 'string' && logoDataUrl.startsWith('data:image')) {
                  doc.addImage(logoDataUrl, 'PNG', 15, 15, 35, 30);
                  console.log('✅ Logo added to PDF successfully');
                } else {
                  console.log('⚠️ Invalid logo data format, skipping logo');
                }
              } catch (logoError) {
                console.log('⚠️ Error adding logo to PDF:', logoError.message);
                // Continue without logo - don't fail the entire PDF generation
              }
            } else {
              console.log('⚠️ No logo available for PDF');
            }
          
          // Company information
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(24);
          doc.setTextColor(...primaryBlue);
          doc.text('iLm Halal Student Halls', 55, 25);
          
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(12);
          doc.setTextColor(...darkGray);
          doc.text('Premium Student Accommodation', 55, 33);
          doc.text('16-18 Constitution Terrace, Dundee DD3 6JE', 55, 40);
          doc.text('Email: RoseHouse.ilm@outlook.com', 55, 47);

          // Receipt title with modern styling
          doc.setFillColor(...accentBlue);
          doc.rect(15, 75, 180, 25, 'F');
          
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(18);
          doc.setTextColor(255, 255, 255);
          doc.text('DEPOSIT RECEIPT', 20, 92);
          
          // Receipt number and amount in header
          doc.setFontSize(12);
          doc.text(`Receipt #: ${receiptNumber}`, 140, 85);
          doc.text(`Amount: £${parseFloat(depositAmount).toFixed(2)}`, 140, 95);

          // Modern info boxes
          let currentY = 115;

          // Tenant Information Box
          doc.setFillColor(255, 255, 255);
          doc.setDrawColor(...primaryBlue);
          doc.setLineWidth(0.5);
          doc.rect(15, currentY, 85, 50, 'FD');
          
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(12);
          doc.setTextColor(...primaryBlue);
          doc.text('TENANT DETAILS', 20, currentY + 10);
          
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(10);
          doc.setTextColor(0, 0, 0);
          doc.text('Name:', 20, currentY + 20);
          doc.text(tenantName, 20, currentY + 27);
          
          if (tenantEmail) {
            doc.text('Email:', 20, currentY + 35);
            doc.text(tenantEmail, 20, currentY + 42);
          }

          // Property Information Box
          doc.setFillColor(255, 255, 255);
          doc.rect(110, currentY, 85, 50, 'FD');
          
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(12);
          doc.setTextColor(...primaryBlue);
          doc.text('PROPERTY DETAILS', 115, currentY + 10);
          
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9);
          doc.setTextColor(0, 0, 0);
          
          const addressLines = propertyAddress.split('\n');
          let addressY = currentY + 20;
          addressLines.forEach(line => {
            if (addressY < currentY + 45) {
              doc.text(line, 115, addressY);
              addressY += 6;
            }
          });
          
          if (roomNumber) {
            doc.text(`Bedroom ${roomNumber}`, 115, addressY + 2);
          }

          currentY += 65;

          // Payment Details Box
          doc.setFillColor(...lightGray);
          doc.rect(15, currentY, 180, 30, 'F');
          
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(12);
          doc.setTextColor(...primaryBlue);
          doc.text('PAYMENT INFORMATION', 20, currentY + 12);
          
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(10);
          doc.setTextColor(0, 0, 0);
          doc.text(`Deposit Amount: £${parseFloat(depositAmount).toFixed(2)}`, 20, currentY + 22);
          doc.text(`Date Received: ${new Date(receiptDate).toLocaleDateString('en-GB')}`, 110, currentY + 22);
          
          if (paymentMethod) {
            doc.text(`Payment Method: ${paymentMethod}`, 20, currentY + 28);
          }

          currentY += 45;

          // Deposit Protection Information
          if (depositSchemeInfo) {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            const schemeInfo = doc.splitTextToSize(depositSchemeInfo, 170);
            
            // Calculate dynamic box height based on text content
            const titleHeight = 15; // Space for title
            const textHeight = schemeInfo.length * 5; // 5 units per line
            const padding = 10; // Extra padding
            const boxHeight = titleHeight + textHeight + padding;
            
            // Draw background box with calculated height
            doc.setFillColor(240, 248, 255); // Light blue background
            doc.setDrawColor(52, 144, 220);
            doc.setLineWidth(1);
            doc.rect(15, currentY, 180, boxHeight, 'FD');
            
            // Add title
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(...primaryBlue);
            doc.text('DEPOSIT PROTECTION', 20, currentY + 10);
            
            // Add text content
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(schemeInfo, 20, currentY + 20);
            
            currentY += boxHeight + 5;
          }

          // Additional Notes
          if (additionalNotes) {
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(...primaryBlue);
            doc.text('ADDITIONAL NOTES', 20, currentY);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            const notes = doc.splitTextToSize(additionalNotes, 170);
            doc.text(notes, 20, currentY + 10);
            currentY += 10 + (notes.length * 5) + 10;
          }

          // Page 1 ends here - all confirmation and signature content moved to Page 2

          // FORCE PAGE 2 - Start with DEPOSIT CONFIRMATION, then signature and everything else
          console.log('📄 Starting Page 2 - Confirmation and Signature Section');
          doc.addPage();
          currentY = 20;
          
          // DEPOSIT CONFIRMATION SECTION - First thing on Page 2
          if (addSignatureFields) {
            console.log('📋 === DEPOSIT CONFIRMATION SECTION START ===');
            
            // Confirmation section
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.setTextColor(...primaryBlue);
            doc.text('DEPOSIT CONFIRMATION', 20, currentY);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`This confirms that ${tenantName} has paid a deposit of £${parseFloat(depositAmount).toFixed(2)}`, 20, currentY + 12);
            doc.text(`for accommodation at the above property on ${new Date(receiptDate).toLocaleDateString('en-GB')}.`, 20, currentY + 20);
            
            currentY += 35;
            console.log('📋 === DEPOSIT CONFIRMATION SECTION END ===');
          }
          
          // SIGNATURE SECTION - First thing on Page 2
          console.log('🖋️ === SIGNATURE SECTION START ===');
          
          // Signature headers and boxes
          const signatureBoxWidth = 80;
          const spacing = 15;
          const boxHeight = 25;
          
          // Add headers for signature and date
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(11);
          doc.setTextColor(...primaryBlue);
          doc.text('LANDLORD SIGNATURE & DATE', 20, currentY);
          
          // Draw signature and date boxes
          doc.setDrawColor(...primaryBlue);
          doc.setLineWidth(1);
          doc.rect(22, currentY + 5, signatureBoxWidth, boxHeight, 'S');
          doc.rect(22 + signatureBoxWidth + spacing, currentY + 5, 60, boxHeight, 'S');
          
          // Add labels inside boxes
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9);
          doc.setTextColor(60, 60, 60);
          doc.text('SIGNATURE:', 25, currentY + 10);
          doc.text('DATE:', 25 + signatureBoxWidth + spacing, currentY + 10);
          
          // ADD ACTUAL SIGNATURE
          let signatureAdded = false;
          const canvas = document.getElementById('signatureCanvas');
          
          if (canvas) {
            try {
              console.log('📋 Canvas found, checking for signature...');
              const canvasData = canvas.toDataURL('image/png');
              const blankCanvas = document.createElement('canvas');
              blankCanvas.width = canvas.width;
              blankCanvas.height = canvas.height;
              const blankData = blankCanvas.toDataURL('image/png');
              const hasSignature = canvasData !== blankData;
              
              console.log('✍️ Canvas has signature:', hasSignature);
              
              if (hasSignature) {
                console.log('🎯 Adding canvas signature to PDF...');
                const sigX = 25;
                const sigY = currentY + 12;
                const sigWidth = 75;
                const sigHeight = 18;
                
                try {
                  doc.addImage(canvasData, 'PNG', sigX, sigY, sigWidth, sigHeight);
                  signatureAdded = true;
                  console.log('✅ SUCCESS: Signature added to PDF');
                } catch (imgError) {
                  console.warn('⚠️ Image add failed, trying text signature');
                }
              }
            } catch (canvasError) {
              console.error('❌ Canvas processing error:', canvasError);
            }
          }
          
          // Add text signature if canvas failed
          if (!signatureAdded && eSignatureName && eSignatureName.trim() !== '') {
            console.log('📝 Adding text signature:', eSignatureName);
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(14);
            doc.setTextColor(...primaryBlue);
            doc.text(eSignatureName, 25, currentY + 20);
            signatureAdded = true;
          }
          
          // Add placeholder if no signature
          if (!signatureAdded) {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text('(Signature Required)', 25, currentY + 20);
          }
          
          // Add signature date
          const displayDate = signatureDate ? new Date(signatureDate).toLocaleDateString('en-GB') : new Date().toLocaleDateString('en-GB');
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(12);
          doc.setTextColor(0, 0, 0);
          doc.text(displayDate, 25 + signatureBoxWidth + spacing, currentY + 20);
          
          // Add signer name below
          currentY += boxHeight + 10;
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(10);
          doc.setTextColor(60, 60, 60);
          const signerName = landlordName || 'iLm Halal Student Halls Management';
          doc.text('Authorized Signatory: ' + signerName, 22, currentY);
          
          currentY += 20;
          console.log('🖋️ === SIGNATURE SECTION END ===');
          
          // Important Information Section - Fixed formatting
          const infoY = currentY;
          doc.setFillColor(255, 248, 225); // Light yellow background
          doc.setDrawColor(243, 156, 18);
          doc.setLineWidth(1);
          doc.rect(15, infoY, 180, 25, 'FD');
          
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(11);
          doc.setTextColor(138, 109, 59);
          doc.text('IMPORTANT INFORMATION', 20, infoY + 10);
          
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9);
          doc.setTextColor(138, 109, 59);
          doc.text('• Please retain this receipt as proof of payment', 20, infoY + 17);
          doc.text('• Your deposit is protected under UK tenancy laws', 20, infoY + 22);
          
          currentY = infoY + 35;

          // Terms and conditions - Already on Page 2, position after important info
          const termsY = currentY;
          
          const termsHeight = 55; // Compact for Page 2
          doc.setFillColor(...lightGray);
          doc.setDrawColor(...primaryBlue);
          doc.setLineWidth(0.5);
          doc.rect(15, termsY, 180, termsHeight, 'FD');
          
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(12);
          doc.setTextColor(...primaryBlue);
          doc.text('TERMS & CONDITIONS', 20, termsY + 12);
          
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          doc.setTextColor(60, 60, 60);
          
          const terms = [
            '• This deposit is held as security against damages and unpaid rent.',
            '• Deductions may be made for cleaning, damages, or unpaid charges beyond normal wear.',
            '• This receipt serves as proof of deposit payment and should be retained by the tenant.',
            '• All disputes will be handled in accordance with UK tenancy law and deposit protection schemes.',
            '• Data Protection: Your personal information is processed in accordance with UK GDPR requirements.',
            '• For our full privacy policy, visit www.ilm-studenthalls.com/policies',
            '• For queries or concerns, contact us at RoseHouse.ilm@outlook.com or call during business hours.'
          ];
          
          terms.forEach((term, index) => {
            doc.text(term, 20, termsY + 22 + (index * 5));
          });
          
          currentY = termsY + termsHeight + 10;

          // Simple Clean Footer
          const footerY = currentY;
          const footerHeight = 35; // Compact footer for Page 2
          
          // Footer background
          doc.setFillColor(...primaryBlue);
          doc.rect(0, footerY, 210, footerHeight, 'F');
          
          // Top border
          doc.setDrawColor(255, 255, 255);
          doc.setLineWidth(0.5);
          doc.line(0, footerY, 210, footerY);
          
          // Company name
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(12);
          doc.setTextColor(255, 255, 255);
          doc.text('iLm Halal Student Halls', 20, footerY + 12);
          
          // Contact details
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9);
          doc.setTextColor(220, 220, 220);
          doc.text('Email: RoseHouse.ilm@outlook.com  |  Phone: +44 7395 202486', 20, footerY + 20);
          doc.text('Address: 16-18 Constitution Terrace, Dundee DD3 6JE  |  Web: www.ilm-studenthalls.com', 20, footerY + 27);
          
          // Footer complete - clean and simple

          // Save the PDF
          console.log('💾 Saving PDF...');
          const fileName = `Deposit_Receipt_${tenantName.replace(/\s+/g, '_')}_${receiptNumber}.pdf`;
          
          // Verify the document is valid before saving
          if (!doc || typeof doc.save !== 'function') {
            throw new Error('PDF document is invalid or corrupted');
          }
          
          doc.save(fileName);
          console.log('✅ PDF saved successfully:', fileName);

          showNotification('Professional deposit receipt generated successfully!', 'success');
          closeDepositReceiptModal();
          
          } catch (pdfError) {
            console.error('❌ Error generating PDF content:', pdfError);
            throw new Error(`PDF generation failed: ${pdfError.message}`);
          }
        }

      } catch (error) {
        console.error('Error generating deposit receipt:', error);
        showNotification(`Error generating deposit receipt: ${error.message}`, 'error');
      } finally {
        // Reset button state
        const generateBtn = document.getElementById('generateReceiptBtn');
        if (generateBtn) {
          generateBtn.disabled = false;
          generateBtn.textContent = 'Generate Receipt PDF';
        }
      }
    }

    // E-signature functionality
    let isDrawing = false;
    let canvas, ctx;

    function initializeSignatureCanvas() {
      canvas = document.getElementById('signatureCanvas');
      if (!canvas) {
        console.error('❌ Signature canvas not found!');
        return;
      }
      
      ctx = canvas.getContext('2d');
      console.log('✅ Signature canvas initialized');
      
      // Set canvas size explicitly
      canvas.width = 400;
      canvas.height = 150;
      
      // Set up drawing
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      // Clear any existing content
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Touch events for mobile
      canvas.addEventListener('touchstart', startDrawingTouch);
      canvas.addEventListener('touchmove', drawTouch);
      canvas.addEventListener('touchend', stopDrawing);
      
      console.log('✅ Signature canvas events attached');
    }

    function startDrawing(e) {
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      ctx.beginPath();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function draw(e) {
      if (!isDrawing) return;
      const rect = canvas.getBoundingClientRect();
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
      
      // Update status
      updateSignatureStatus();
    }

    function startDrawingTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      startDrawing(touch);
    }

    function drawTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      draw(touch);
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function clearSignature() {
      if (ctx && canvas) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        console.log('✅ Signature canvas cleared');
      }
      document.getElementById('eSignatureName').value = '';
      // Reset signature date to today
      document.getElementById('signatureDate').value = new Date().toISOString().split('T')[0];
      // Update status
      updateSignatureStatus();
    }
    
         function testSignature() {
       if (!ctx || !canvas) {
         console.error('❌ Canvas not initialized');
         showNotification('Signature canvas not ready. Please try again.', 'error');
         return;
       }
       
       // Draw a test signature
       ctx.clearRect(0, 0, canvas.width, canvas.height);
       ctx.beginPath();
       ctx.moveTo(50, 75);
       ctx.lineTo(150, 50);
       ctx.lineTo(250, 100);
       ctx.lineTo(350, 75);
       ctx.stroke();
       
       // Add some flourish
       ctx.beginPath();
       ctx.arc(200, 75, 20, 0, Math.PI);
       ctx.stroke();
       
       console.log('✅ Test signature drawn');
       console.log('📊 Canvas data URL length:', canvas.toDataURL().length);
       showNotification('Test signature added! You can clear it and draw your own.', 'success');
            }
       
       function debugSignature() {
         console.log('🔍 === SIGNATURE DEBUG START ===');
         
         const canvas = document.getElementById('signatureCanvas');
         const nameInput = document.getElementById('eSignatureName');
         
         console.log('📋 Canvas element:', canvas);
         console.log('📝 Name input:', nameInput ? nameInput.value : 'not found');
         
         if (canvas) {
           console.log('📐 Canvas dimensions:', canvas.width, 'x', canvas.height);
           console.log('📊 Canvas context:', ctx);
           
           const dataURL = canvas.toDataURL();
           console.log('🖼️ Canvas data URL length:', dataURL.length);
           console.log('🖼️ Canvas data URL preview:', dataURL.substring(0, 100) + '...');
           
           // Create blank canvas for comparison
           const blank = document.createElement('canvas');
           blank.width = canvas.width;
           blank.height = canvas.height;
           const blankData = blank.toDataURL();
           
           const isEmpty = dataURL === blankData;
           console.log('❓ Canvas is empty:', isEmpty);
           
           if (!isEmpty) {
             // Try to download the signature as a file to verify it works
             const link = document.createElement('a');
             link.download = 'debug-signature.png';
             link.href = dataURL;
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             console.log('💾 Signature downloaded as debug-signature.png');
           }
         }
         
         console.log('🔍 === SIGNATURE DEBUG END ===');
         showNotification('Debug info logged to console. Check F12 → Console tab.', 'info');
       }
      
      function validateSignature() {
        const canvas = document.getElementById('signatureCanvas');
        const name = document.getElementById('eSignatureName').value.trim();
        
        if (!canvas) {
          console.error('❌ Canvas not found');
          return false;
        }
        
        const isEmpty = isCanvasEmpty(canvas);
        console.log('🔍 Signature validation:');
        console.log('  - Canvas empty:', isEmpty);
        console.log('  - Name provided:', name);
        console.log('  - Canvas data length:', canvas.toDataURL().length);
        
        if (!isEmpty || name) {
          console.log('✅ Valid signature found');
          return true;
        }
        
        console.log('⚠️ No signature found');
        return false;
      }
      
      function updateSignatureStatus() {
        const statusDiv = document.getElementById('signatureStatus');
        const canvas = document.getElementById('signatureCanvas');
        const name = document.getElementById('eSignatureName').value.trim();
        
        if (!statusDiv) return;
        
        if (canvas && !isCanvasEmpty(canvas)) {
          statusDiv.innerHTML = '✅ <span style="color: green;">Signature drawn and ready</span>';
        } else if (name) {
          statusDiv.innerHTML = '✅ <span style="color: green;">Text signature: ' + name + '</span>';
        } else {
          statusDiv.innerHTML = '⚠️ <span style="color: orange;">No signature provided</span>';
        }
      }

    function isCanvasEmpty(canvas) {
      if (!canvas) {
        console.warn('⚠️ Canvas not provided to isCanvasEmpty');
        return true;
      }
      
      try {
        const blank = document.createElement('canvas');
        blank.width = canvas.width;
        blank.height = canvas.height;
        
        const canvasData = canvas.toDataURL();
        const blankData = blank.toDataURL();
        
        const isEmpty = canvasData === blankData;
        console.log('🎨 Canvas empty check:', isEmpty);
        
        return isEmpty;
      } catch (error) {
        console.warn('⚠️ Error checking if canvas is empty:', error);
        return true;
      }
    }

    // Logo Upload Functions
    function openLogoUploadModal() {
      document.getElementById('logoUploadModal').style.display = 'flex';
      setupLogoFileInput();
    }

    function closeLogoUploadModal() {
      document.getElementById('logoUploadModal').style.display = 'none';
      document.getElementById('logoFileInput').value = '';
      document.getElementById('logoPreview').style.display = 'none';
      document.getElementById('uploadLogoBtn').disabled = true;
    }

    function setupLogoFileInput() {
      const fileInput = document.getElementById('logoFileInput');
      const preview = document.getElementById('logoPreview');
      const previewImg = document.getElementById('logoPreviewImg');
      const uploadBtn = document.getElementById('uploadLogoBtn');

      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
            uploadBtn.disabled = false;
          };
          reader.readAsDataURL(file);
        } else {
          preview.style.display = 'none';
          uploadBtn.disabled = true;
        }
      });
    }

    async function uploadLogo() {
      const fileInput = document.getElementById('logoFileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        showNotification('Please select a file first', 'error');
        return;
      }

      try {
        showNotification('Uploading logo...', 'info');
        
        // Create assets bucket if it doesn't exist
        const { data: buckets } = await supabase.storage.listBuckets();
        const assetsBucket = buckets.find(bucket => bucket.name === 'assets');
        
        if (!assetsBucket) {
          await supabase.storage.createBucket('assets', {
            public: true,
            allowedMimeTypes: ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml']
          });
        }

        // Upload file
        const fileName = `logo/ilm-logo.${file.name.split('.').pop()}`;
        const { data, error } = await supabase.storage
          .from('assets')
          .upload(fileName, file, {
            upsert: true
          });

        if (error) throw error;

        showNotification('Logo uploaded successfully!', 'success');
        closeLogoUploadModal();
        
      } catch (error) {
        console.error('Error uploading logo:', error);
        showNotification(`Error uploading logo: ${error.message}`, 'error');
      }
    }

    // Initialize signature canvas when modal opens
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 DOM loaded, setting up signature canvas initialization');
      
      // Try to initialize immediately
      setTimeout(initializeSignatureCanvas, 500);
      
      // Also initialize whenever the modal is opened
      const modal = document.getElementById('depositReceiptModal');
      if (modal) {
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
              if (modal.style.display === 'flex') {
                console.log('📋 Deposit receipt modal opened, initializing signature canvas');
                setTimeout(initializeSignatureCanvas, 200);
              }
            }
          });
        });
        observer.observe(modal, { attributes: true });
      }
    });

    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    function showLoading() {
      const tbody = document.getElementById('applicationsTableBody');
      tbody.innerHTML = `
        <tr>
          <td colspan="9" class="loading">
            Loading applications...
          </td>
        </tr>
      `;
    }

    function openBookingForm() {
      window.open('booking.html', '_blank');
    }

    function updateRecentActivity() {
      // This would fetch real activity data in a production app
      const activityList = document.getElementById('recentActivityList');
      
      const recentApps = applications
        .sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate))
        .slice(0, 5);

      activityList.innerHTML = recentApps.map(app => `
        <div class="activity-item">
          <div class="activity-icon activity-new">📝</div>
          <div class="activity-text">New application from ${app.firstName} ${app.lastName}</div>
          <div class="activity-time">${getTimeAgo(app.submissionDate)}</div>
        </div>
      `).join('');
    }

    function setupRealTimeUpdates() {
      console.log('📡 Setting up real-time updates...');
      
      // Subscribe to applications table changes
      realtimeSubscription = supabase
        .channel('applications_channel')
        .on('postgres_changes', 
          { 
            event: '*', 
            schema: 'public', 
            table: 'applications' 
          }, 
          async (payload) => {
            console.log('🔄 Real-time update received:', payload);
            
            switch (payload.eventType) {
              case 'INSERT':
                await handleNewApplication(payload.new);
                break;
              case 'UPDATE':
                await handleApplicationUpdate(payload.new);
                break;
              case 'DELETE':
                await handleApplicationDelete(payload.old);
                break;
            }
          }
        )
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log('✅ Real-time subscription active');
            showNotification('Real-time updates enabled', 'success');
          } else if (status === 'CHANNEL_ERROR') {
            console.warn('⚠️ Real-time subscription error, continuing without real-time updates');
            // Don't show error notification as it's not critical for basic functionality
          }
        });
    }

    // Enhanced Mobile Notifications
    async function initializeNotifications() {
      try {
        // Check if notifications are supported
        if ('Notification' in window) {
          console.log('🔔 Browser notifications supported');
          
          // Check current permission status
          if (Notification.permission === 'default') {
            // Request permission on mobile
            if (isMobileDevice()) {
              const permission = await Notification.requestPermission();
              console.log('📱 Mobile notification permission:', permission);
              
              if (permission === 'granted') {
                showNotification('Mobile notifications enabled! You\'ll receive alerts for new applications.', 'success');
                
                // Show a test notification
                setTimeout(() => {
                  if (Notification.permission === 'granted') {
                    new Notification('iLm Admin Dashboard', {
                      body: 'Mobile notifications are now active',
                      icon: 'https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189942/web-app-manifest-192x192_wr5wdr.png',
                      badge: 'https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189942/web-app-manifest-192x192_wr5wdr.png',
                      tag: 'admin-test',
                      requireInteraction: false
                    });
                  }
                }, 2000);
              }
            }
          } else if (Notification.permission === 'granted') {
            console.log('✅ Notification permission already granted');
          }
        }
        
        // Register service worker for background notifications
        if ('serviceWorker' in navigator) {
          console.log('🔧 Registering service worker for background notifications...');
          await registerServiceWorker();
        }
        
      } catch (error) {
        console.error('❌ Notification initialization error:', error);
      }
    }

    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1) ||
             window.innerWidth <= 768;
    }

    async function registerServiceWorker() {
      try {
        // Skip service worker registration for now due to blob URL restrictions
        // Use simpler notification approach without service worker
        console.log('⚠️ Service Worker registration skipped (blob URLs not supported)');
        console.log('✅ Using browser-based notifications instead');
        return null;
        
      } catch (error) {
        console.error('❌ Service Worker registration failed:', error);
        return null;
      }
    }

    // Enhanced notification for new applications
    async function handleNewApplication(newApp) {
      console.log('📝 New application received:', newApp.id);
      
      // Convert and add to local array
      const formattedApp = formatApplicationFromDB(newApp);
      applications.unshift(formattedApp);
      
      // Update display
      filteredApplications = [...applications];
      updateStats();
      renderApplicationsTable();
      renderPagination();
      updateRecentActivity();
      
      // Enhanced notifications
      const message = `New application from ${formattedApp.firstName} ${formattedApp.lastName}`;
      showNotification(message, 'success');
      
      // Browser notification with enhanced mobile support
      if ('Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification('New Student Application', {
          body: `${formattedApp.firstName} ${formattedApp.lastName} has submitted an application\nUniversity: ${getUniversityName(formattedApp.university)}\nRoom: ${getRoomTypeName(formattedApp.roomType)}`,
          icon: 'https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189942/web-app-manifest-192x192_wr5wdr.png',
          badge: 'https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189942/web-app-manifest-192x192_wr5wdr.png',
          tag: `application-${formattedApp.id}`,
          requireInteraction: isMobileDevice(), // Keep open longer on mobile
          actions: isMobileDevice() ? [] : [
            { action: 'view', title: 'View Application' },
            { action: 'approve', title: 'Quick Approve' }
          ]
        });
        
        // Handle notification clicks
        notification.onclick = function() {
          window.focus();
          viewApplication(formattedApp.id);
          notification.close();
        };
        
        // Auto-close after delay on desktop
        if (!isMobileDevice()) {
          setTimeout(() => notification.close(), 10000);
        }
      }
      
      // Add sound notification on mobile
      if (isMobileDevice()) {
        try {
          // Create a subtle notification sound
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
          oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.3);
        } catch (error) {
          console.log('Audio notification not available');
        }
      }
      
      // Vibration on mobile devices
      if ('vibrate' in navigator && isMobileDevice()) {
        navigator.vibrate([200, 100, 200]);
      }
    }

    async function handleApplicationUpdate(updatedApp) {
      console.log('✏️ Application updated:', updatedApp.id);
      
      // Find and update in local array
      const index = applications.findIndex(app => app.id === updatedApp.id);
      if (index !== -1) {
        applications[index] = formatApplicationFromDB(updatedApp);
        
        // Update display
        filteredApplications = [...applications];
        updateStats();
        renderApplicationsTable();
        updateRecentActivity();
      }
    }

    async function handleApplicationDelete(deletedApp) {
      console.log('🗑️ Application deleted:', deletedApp.id);
      
      // Remove from local array
      applications = applications.filter(app => app.id !== deletedApp.id);
      
      // Update display
      filteredApplications = [...applications];
      updateStats();
      renderApplicationsTable();
      renderPagination();
      updateRecentActivity();
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('en-GB');
    }

    function getTimeAgo(dateString) {
      const now = new Date();
      const date = new Date(dateString);
      const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
      
      if (diffInHours < 1) return 'Just now';
      if (diffInHours < 24) return `${diffInHours}h ago`;
      const diffInDays = Math.floor(diffInHours / 24);
      return `${diffInDays}d ago`;
    }

    async function logout() {
      try {
        console.log('🚪 Signing out...');
        
        // Sign out from Supabase
        const { error } = await supabase.auth.signOut();
        
        if (error) {
          console.error('❌ Logout error:', error);
          showNotification('Error signing out', 'error');
        }
        
        // Clear localStorage
        localStorage.removeItem('admin_authenticated');
        localStorage.removeItem('admin_email');
        
        // Cleanup real-time subscription
        if (realtimeSubscription) {
          supabase.removeChannel(realtimeSubscription);
        }
        
        // Redirect to login
        window.location.href = 'admin.html';
        
      } catch (error) {
        console.error('❌ Logout failed:', error);
        // Force redirect even if logout fails
        window.location.href = 'admin.html';
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const applicationModal = document.getElementById('applicationModal');
      const settingsModal = document.getElementById('settingsModal');
      const bulkModal = document.getElementById('bulkModal');
      const depositReceiptModal = document.getElementById('depositReceiptModal');
      const logoUploadModal = document.getElementById('logoUploadModal');
      
      if (event.target === applicationModal) {
        closeModal();
      } else if (event.target === settingsModal) {
        closeSettingsModal();
      } else if (event.target === bulkModal) {
        closeBulkModal();
      } else if (event.target === depositReceiptModal) {
        closeDepositReceiptModal();
      } else if (event.target === logoUploadModal) {
        closeLogoUploadModal();
      }
    }

    // Cleanup real-time subscription on page unload
    window.addEventListener('beforeunload', () => {
      if (realtimeSubscription) {
        supabase.removeChannel(realtimeSubscription);
      }
    });

    // Utility functions
    function getUniversityName(code) {
      const universities = {
        'abertay': 'Abertay University',
        'dundee': 'University of Dundee',
        'al-makhtoum': 'Al Makhtoum Institute',
        'st-andrews': 'St Andrews University',
        'dundee-angus-college': 'Dundee & Angus College',
        'other': 'Other'
      };
      return universities[code] || code;
    }

    function getRoomTypeName(code) {
      const roomTypes = {
        'single-no-wc': 'Single – no WC (£160/week)',
        'single-with-wc': 'Single – with WC (£165/week)',
        'single-en-suite': 'Single – en-suite (£190/week)',
        'double-with-wc': 'Double – with WC (£190/week)'
      };
      return roomTypes[code] || code;
    }

    function getStatusName(code) {
      const statuses = {
        'new': 'New',
        'review': 'Under Review',
        'approved': 'Approved',
        'rejected': 'Rejected',
        'archived': 'Archived'
      };
      return statuses[code] || code;
    }

    function generateCompleteCSV(data) {
      const headers = [
        'Application ID', 'Status', 'Submission Date',
        'First Name', 'Middle Name', 'Last Name', 'Date of Birth', 'Gender', 'Nationality', 'Passport/ID Number',
        'Email', 'Phone', 'Home Address',
        'University', 'Course of Study', 'Student ID', 'Year of Study',
        'Room Type', 'Check-in Date', 'Contract Length', 'Parking Required', 'Bike Storage Required', 'Room Preferences',
        'Dietary Requirements', 'Medical Conditions', 'Additional Information',
        'Reference Name', 'Reference Relationship', 'Reference Email', 'Reference Phone',
        'Guarantor Name', 'Guarantor Relationship', 'Guarantor Email', 'Guarantor Phone', 'Guarantor Address',
        'Emergency Name', 'Emergency Relationship', 'Emergency Phone', 'Emergency Email',
        'Admin Notes', 'Last Modified'
      ];
      
      const csvData = data.map(app => [
        app.id || '',
        getStatusName(app.status) || '',
        formatDate(app.submissionDate) || '',
        app.firstName || '',
        app.middleName || '',
        app.lastName || '',
        app.dateOfBirth || '',
        app.gender || '',
        app.nationality || '',
        app.passportNumber || '',
        app.email || '',
        app.phone || '',
        app.homeAddress || '',
        getUniversityName(app.university) || '',
        app.courseOfStudy || '',
        app.studentId || '',
        app.yearOfStudy || '',
        getRoomTypeName(app.roomType) || '',
        app.checkInDate || '',
        app.contractLength || '',
        app.parkingRequired ? 'Yes' : 'No',
        app.bikeStorageRequired ? 'Yes' : 'No',
        app.roomPreferences || '',
        app.dietaryRequirements || '',
        app.medicalConditions || '',
        app.additionalInfo || '',
        app.referenceName || '',
        app.referenceRelationship || '',
        app.referenceEmail || '',
        app.referenceTelephone || '',
        app.guarantorName || '',
        app.guarantorRelationship || '',
        app.guarantorEmail || '',
        app.guarantorTelephone || '',
        app.guarantorAddress || '',
        app.emergencyName || '',
        app.emergencyRelation || '',
        app.emergencyPhone || '',
        app.emergencyEmail || '',
        app.notes || '',
        formatDate(app.lastModified) || ''
      ]);

      return [headers, ...csvData].map(row => 
        row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
    }

    // Bulk Actions Functions
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.select-checkbox');
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
      });
      
      updateBulkActions();
    }

    function updateBulkActions() {
      const checkboxes = document.querySelectorAll('.select-checkbox:checked');
      const bulkBar = document.getElementById('bulkActionsBar');
      const selectedCount = document.getElementById('selectedCount');
      
      if (checkboxes.length > 0) {
        bulkBar.classList.add('show');
        selectedCount.textContent = `${checkboxes.length} selected`;
      } else {
        bulkBar.classList.remove('show');
      }
      
      // Update select all checkbox state
      const allCheckboxes = document.querySelectorAll('.select-checkbox');
      const selectAllCheckbox = document.getElementById('selectAll');
      selectAllCheckbox.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
      selectAllCheckbox.checked = checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0;
    }

    function getSelectedApplicationIds() {
      const checkboxes = document.querySelectorAll('.select-checkbox:checked');
      return Array.from(checkboxes).map(cb => cb.dataset.id);
    }

    async function bulkApprove() {
      const selectedIds = getSelectedApplicationIds();
      if (selectedIds.length === 0) {
        showNotification('No applications selected', 'error');
        return;
      }
      
      if (!confirm(`Approve ${selectedIds.length} selected applications?`)) return;
      
      try {
        for (const id of selectedIds) {
          await supabase
            .from('applications')
            .update({ status: 'approved', last_modified: new Date().toISOString() })
            .eq('id', id);
        }
        
        showNotification(`${selectedIds.length} applications approved`, 'success');
        clearSelection();
      } catch (error) {
        console.error('Bulk approve error:', error);
        showNotification('Error approving applications', 'error');
      }
    }

    async function bulkReject() {
      const selectedIds = getSelectedApplicationIds();
      if (selectedIds.length === 0) {
        showNotification('No applications selected', 'error');
        return;
      }
      
      if (!confirm(`Reject ${selectedIds.length} selected applications?`)) return;
      
      try {
        for (const id of selectedIds) {
          await supabase
            .from('applications')
            .update({ status: 'rejected', last_modified: new Date().toISOString() })
            .eq('id', id);
        }
        
        showNotification(`${selectedIds.length} applications rejected`, 'info');
        clearSelection();
      } catch (error) {
        console.error('Bulk reject error:', error);
        showNotification('Error rejecting applications', 'error');
      }
    }

    async function bulkArchive() {
      const selectedIds = getSelectedApplicationIds();
      if (selectedIds.length === 0) {
        showNotification('No applications selected', 'error');
        return;
      }
      
      if (!confirm(`Archive ${selectedIds.length} selected applications?`)) return;
      
      try {
        for (const id of selectedIds) {
          await supabase
            .from('applications')
            .update({ status: 'archived', last_modified: new Date().toISOString() })
            .eq('id', id);
        }
        
        showNotification(`${selectedIds.length} applications archived`, 'info');
        clearSelection();
      } catch (error) {
        console.error('Bulk archive error:', error);
        showNotification('Error archiving applications', 'error');
      }
    }

    async function bulkDelete() {
      const selectedIds = getSelectedApplicationIds();
      if (selectedIds.length === 0) {
        showNotification('No applications selected', 'error');
        return;
      }
      
      if (!confirm(`Permanently delete ${selectedIds.length} selected applications? This cannot be undone.`)) return;
      
      try {
        for (const id of selectedIds) {
          await supabase
            .from('applications')
            .delete()
            .eq('id', id);
        }
        
        showNotification(`${selectedIds.length} applications deleted`, 'info');
        clearSelection();
      } catch (error) {
        console.error('Bulk delete error:', error);
        showNotification('Error deleting applications', 'error');
      }
    }

    function bulkExport() {
      const selectedIds = getSelectedApplicationIds();
      if (selectedIds.length === 0) {
        showNotification('No applications selected', 'error');
        return;
      }
      
      const selectedApps = applications.filter(app => selectedIds.includes(app.id));
      const csvContent = generateCompleteCSV(selectedApps);
      downloadCSV(csvContent, `ilm-selected-applications-${new Date().toISOString().split('T')[0]}.csv`);
      showNotification(`${selectedIds.length} applications exported`, 'success');
    }

    function clearSelection() {
      document.querySelectorAll('.select-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('selectAll').checked = false;
      updateBulkActions();
    }

    // Settings Functions
    function showSettings() {
      document.getElementById('settingsModal').style.display = 'block';
      loadSettings();
    }

    function closeSettingsModal() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    function loadSettings() {
      const settings = JSON.parse(localStorage.getItem('admin_settings') || '{}');
      
      // Load toggle switches
      document.querySelectorAll('.toggle-switch').forEach(toggle => {
        const settingName = toggle.onclick.toString().match(/'([^']+)'/)[1];
        if (settings[settingName]) {
          toggle.classList.add('active');
        }
      });
      
      // Load select values
      if (settings.itemsPerPage) {
        document.getElementById('itemsPerPageSetting').value = settings.itemsPerPage;
      }
      if (settings.exportFormat) {
        document.getElementById('exportFormatSetting').value = settings.exportFormat;
      }
    }

    function toggleSetting(element, settingName) {
      element.classList.toggle('active');
    }

    function updateItemsPerPage() {
      const newValue = parseInt(document.getElementById('itemsPerPageSetting').value);
      itemsPerPage = newValue;
      currentPage = 1;
      renderApplicationsTable();
      renderPagination();
    }

    function saveSettings() {
      const settings = {};
      
      // Save toggle switches
      document.querySelectorAll('.toggle-switch').forEach(toggle => {
        const settingName = toggle.onclick.toString().match(/'([^']+)'/)[1];
        settings[settingName] = toggle.classList.contains('active');
      });
      
      // Save select values
      settings.itemsPerPage = document.getElementById('itemsPerPageSetting').value;
      settings.exportFormat = document.getElementById('exportFormatSetting').value;
      
      localStorage.setItem('admin_settings', JSON.stringify(settings));
      
      // Sync test data button visibility with booking form
      if (settings.showTestDataButton !== undefined) {
        localStorage.setItem('showTestDataBtn', settings.showTestDataButton);
        // Post message to booking form if it's open in another tab
        broadcastSettingUpdate('showTestDataButton', settings.showTestDataButton);
      }
      
      // Apply settings
      if (settings.itemsPerPage) {
        itemsPerPage = parseInt(settings.itemsPerPage);
        currentPage = 1;
        renderApplicationsTable();
        renderPagination();
      }
      
      showNotification('Settings saved successfully', 'success');
      closeSettingsModal();
    }

    // Function to broadcast setting updates to other tabs/windows
    function broadcastSettingUpdate(settingName, value) {
      // Use localStorage event to communicate between tabs
      localStorage.setItem('admin_setting_update', JSON.stringify({
        setting: settingName,
        value: value,
        timestamp: Date.now()
      }));
      
      // Clean up the broadcast message
      setTimeout(() => {
        localStorage.removeItem('admin_setting_update');
      }, 1000);
    }

    function showBulkActions() {
      document.getElementById('bulkModal').style.display = 'block';
    }

    function closeBulkModal() {
      document.getElementById('bulkModal').style.display = 'none';
    }

    // Enhanced View Application with All Fields
    function viewApplication(applicationId) {
      const app = applications.find(a => a.id === applicationId);
      if (!app) return;

      currentApplicationId = applicationId;
      document.getElementById('modalTitle').textContent = `Application Details - ${app.id}`;
      
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <div class="form-grid">
          <!-- Personal Information Section -->
          <div class="form-section form-grid-full">
            <h4>Personal Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Application ID</label>
                <input type="text" value="${app.id}" readonly>
              </div>
              <div class="form-group">
                <label>Status</label>
                <select id="editStatus">
                  <option value="new" ${app.status === 'new' ? 'selected' : ''}>New</option>
                  <option value="review" ${app.status === 'review' ? 'selected' : ''}>Under Review</option>
                  <option value="approved" ${app.status === 'approved' ? 'selected' : ''}>Approved</option>
                  <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                  <option value="archived" ${app.status === 'archived' ? 'selected' : ''}>Archived</option>
                </select>
              </div>
              <div class="form-group">
                <label>First Name</label>
                <input type="text" id="editFirstName" value="${app.firstName || ''}">
              </div>
              <div class="form-group">
                <label>Middle Name</label>
                <input type="text" id="editMiddleName" value="${app.middleName || ''}">
              </div>
              <div class="form-group">
                <label>Last Name</label>
                <input type="text" id="editLastName" value="${app.lastName || ''}">
              </div>
              <div class="form-group">
                <label>Date of Birth</label>
                <input type="date" id="editDateOfBirth" value="${app.dateOfBirth || ''}">
              </div>
              <div class="form-group">
                <label>Gender</label>
                <select id="editGender">
                  <option value="">Select Gender</option>
                  <option value="male" ${app.gender === 'male' ? 'selected' : ''}>Male</option>
                  <option value="female" ${app.gender === 'female' ? 'selected' : ''}>Female</option>
                </select>
              </div>
              <div class="form-group">
                <label>Nationality</label>
                <input type="text" id="editNationality" value="${app.nationality || ''}">
              </div>
              <div class="form-group">
                <label>Passport/ID Number</label>
                <input type="text" id="editPassportNumber" value="${app.passportNumber || ''}">
              </div>
            </div>
          </div>

          <!-- Contact Information Section -->
          <div class="form-section form-grid-full">
            <h4>Contact Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="editEmail" value="${app.email || ''}">
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="editPhone" value="${app.phone || ''}">
              </div>
              <div class="form-group form-grid-full">
                <label>Home Address</label>
                <textarea id="editHomeAddress">${app.homeAddress || ''}</textarea>
              </div>
            </div>
          </div>

          <!-- Academic Information Section -->
          <div class="form-section form-grid-full">
            <h4>Academic Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>University</label>
                <select id="editUniversity">
                  <option value="abertay" ${app.university === 'abertay' ? 'selected' : ''}>Abertay University</option>
                  <option value="dundee" ${app.university === 'dundee' ? 'selected' : ''}>University of Dundee</option>
                  <option value="al-makhtoum" ${app.university === 'al-makhtoum' ? 'selected' : ''}>Al Makhtoum Institute</option>
                  <option value="st-andrews" ${app.university === 'st-andrews' ? 'selected' : ''}>St Andrews University</option>
                  <option value="dundee-angus-college" ${app.university === 'dundee-angus-college' ? 'selected' : ''}>Dundee & Angus College</option>
                  <option value="other" ${app.university === 'other' ? 'selected' : ''}>Other</option>
                </select>
              </div>
              <div class="form-group">
                <label>Course of Study</label>
                <input type="text" id="editCourse" value="${app.courseOfStudy || ''}">
              </div>
              <div class="form-group">
                <label>Student ID</label>
                <input type="text" id="editStudentId" value="${app.studentId || ''}">
              </div>
              <div class="form-group">
                <label>Year of Study</label>
                <select id="editYearOfStudy">
                  <option value="">Select Year</option>
                  <option value="1" ${app.yearOfStudy === '1' ? 'selected' : ''}>1st Year</option>
                  <option value="2" ${app.yearOfStudy === '2' ? 'selected' : ''}>2nd Year</option>
                  <option value="3" ${app.yearOfStudy === '3' ? 'selected' : ''}>3rd Year</option>
                  <option value="4" ${app.yearOfStudy === '4' ? 'selected' : ''}>4th Year</option>
                  <option value="5" ${app.yearOfStudy === '5' ? 'selected' : ''}>5th Year</option>
                  <option value="postgraduate" ${app.yearOfStudy === 'postgraduate' ? 'selected' : ''}>Postgraduate</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Accommodation Information Section -->
          <div class="form-section form-grid-full">
            <h4>Accommodation Preferences</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Room Type</label>
                <select id="editRoomType">
                  <option value="single-no-wc" ${app.roomType === 'single-no-wc' ? 'selected' : ''}>Single Room – no WC (£160/week)</option>
                  <option value="single-with-wc" ${app.roomType === 'single-with-wc' ? 'selected' : ''}>Single Room – with WC (£165/week)</option>
                  <option value="single-en-suite" ${app.roomType === 'single-en-suite' ? 'selected' : ''}>Single Room – with en-suite (£190/week)</option>
                  <option value="double-with-wc" ${app.roomType === 'double-with-wc' ? 'selected' : ''}>Double Room – with WC (£190/week)</option>
                </select>
              </div>
              <div class="form-group">
                <label>Check-in Date</label>
                <input type="date" id="editCheckInDate" value="${app.checkInDate || ''}">
              </div>
              <div class="form-group">
                <label>Contract Length</label>
                <input type="text" id="editContractLength" value="${app.contractLength || ''}">
              </div>
              <div class="form-group">
                <label>Parking Required</label>
                <select id="editParkingRequired">
                  <option value="false" ${!app.parkingRequired ? 'selected' : ''}>No</option>
                  <option value="true" ${app.parkingRequired ? 'selected' : ''}>Yes (+£20/week)</option>
                </select>
              </div>
              <div class="form-group">
                <label>Bike Storage Required</label>
                <select id="editBikeStorage">
                  <option value="false" ${!app.bikeStorageRequired ? 'selected' : ''}>No</option>
                  <option value="true" ${app.bikeStorageRequired ? 'selected' : ''}>Yes</option>
                </select>
              </div>
              <div class="form-group form-grid-full">
                <label>Room Preferences</label>
                <textarea id="editRoomPreferences">${app.roomPreferences || ''}</textarea>
              </div>
            </div>
          </div>

          <!-- Lifestyle Information Section -->
          <div class="form-section form-grid-full">
            <h4>Lifestyle & Dietary Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Dietary Requirements</label>
                <input type="text" id="editDietaryRequirements" value="${app.dietaryRequirements || ''}">
              </div>
              <div class="form-group">
                <label>Medical Conditions</label>
                <input type="text" id="editMedicalConditions" value="${app.medicalConditions || ''}">
              </div>
              <div class="form-group form-grid-full">
                <label>Additional Information</label>
                <textarea id="editAdditionalInfo">${app.additionalInfo || ''}</textarea>
              </div>
            </div>
          </div>

          <!-- Reference Information Section -->
          <div class="form-section form-grid-full">
            <h4>Reference Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Reference Name</label>
                <input type="text" id="editReferenceName" value="${app.referenceName || ''}">
              </div>
              <div class="form-group">
                <label>Reference Relationship</label>
                <input type="text" id="editReferenceRelationship" value="${app.referenceRelationship || ''}">
              </div>
              <div class="form-group">
                <label>Reference Email</label>
                <input type="email" id="editReferenceEmail" value="${app.referenceEmail || ''}">
              </div>
              <div class="form-group">
                <label>Reference Phone</label>
                <input type="tel" id="editReferenceTelephone" value="${app.referenceTelephone || ''}">
              </div>
            </div>
          </div>

          <!-- Guarantor Information Section -->
          <div class="form-section form-grid-full">
            <h4>Guarantor Information</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Guarantor Name</label>
                <input type="text" id="editGuarantorName" value="${app.guarantorName || ''}">
              </div>
              <div class="form-group">
                <label>Guarantor Relationship</label>
                <input type="text" id="editGuarantorRelationship" value="${app.guarantorRelationship || ''}">
              </div>
              <div class="form-group">
                <label>Guarantor Email</label>
                <input type="email" id="editGuarantorEmail" value="${app.guarantorEmail || ''}">
              </div>
              <div class="form-group">
                <label>Guarantor Phone</label>
                <input type="tel" id="editGuarantorTelephone" value="${app.guarantorTelephone || ''}">
              </div>
              <div class="form-group form-grid-full">
                <label>Guarantor Address</label>
                <textarea id="editGuarantorAddress">${app.guarantorAddress || ''}</textarea>
              </div>
            </div>
          </div>

          <!-- Emergency Contact Section -->
          <div class="form-section form-grid-full">
            <h4>Emergency Contact</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Emergency Contact Name</label>
                <input type="text" id="editEmergencyName" value="${app.emergencyName || ''}">
              </div>
              <div class="form-group">
                <label>Emergency Relationship</label>
                <input type="text" id="editEmergencyRelation" value="${app.emergencyRelation || ''}">
              </div>
              <div class="form-group">
                <label>Emergency Phone</label>
                <input type="tel" id="editEmergencyPhone" value="${app.emergencyPhone || ''}">
              </div>
              <div class="form-group">
                <label>Emergency Email</label>
                <input type="email" id="editEmergencyEmail" value="${app.emergencyEmail || ''}">
              </div>
            </div>
          </div>

          <!-- Admin Notes Section -->
          <div class="form-section form-grid-full">
            <h4>Admin Notes</h4>
            <div class="form-group">
              <label>Notes</label>
              <textarea id="editNotes">${app.notes || ''}</textarea>
            </div>
          </div>
        </div>
      `;

      document.getElementById('applicationModal').style.display = 'block';
    }

    // Enhanced Save Application with All Fields
    async function saveApplication() {
      if (!currentApplicationId) return;

      try {
        const updateData = {
          status: document.getElementById('editStatus').value,
          first_name: document.getElementById('editFirstName').value,
          middle_name: document.getElementById('editMiddleName').value,
          last_name: document.getElementById('editLastName').value,
          date_of_birth: document.getElementById('editDateOfBirth').value || null,
          gender: document.getElementById('editGender').value,
          nationality: document.getElementById('editNationality').value,
          passport_number: document.getElementById('editPassportNumber').value,
          email: document.getElementById('editEmail').value,
          phone: document.getElementById('editPhone').value,
          home_address: document.getElementById('editHomeAddress').value,
          university: document.getElementById('editUniversity').value,
          course_of_study: document.getElementById('editCourse').value,
          student_id: document.getElementById('editStudentId').value,
          year_of_study: document.getElementById('editYearOfStudy').value,
          room_type: document.getElementById('editRoomType').value,
          check_in_date: document.getElementById('editCheckInDate').value || null,
          contract_length: document.getElementById('editContractLength').value,
          parking_required: document.getElementById('editParkingRequired').value === 'true',
          bike_storage_required: document.getElementById('editBikeStorage').value === 'true',
          room_preferences: document.getElementById('editRoomPreferences').value,
          dietary_requirements: document.getElementById('editDietaryRequirements').value,
          medical_conditions: document.getElementById('editMedicalConditions').value,
          additional_info: document.getElementById('editAdditionalInfo').value,
          reference_name: document.getElementById('editReferenceName').value,
          reference_relationship: document.getElementById('editReferenceRelationship').value,
          reference_email: document.getElementById('editReferenceEmail').value,
          reference_telephone: document.getElementById('editReferenceTelephone').value,
          guarantor_name: document.getElementById('editGuarantorName').value,
          guarantor_relationship: document.getElementById('editGuarantorRelationship').value,
          guarantor_email: document.getElementById('editGuarantorEmail').value,
          guarantor_telephone: document.getElementById('editGuarantorTelephone').value,
          guarantor_address: document.getElementById('editGuarantorAddress').value,
          emergency_name: document.getElementById('editEmergencyName').value,
          emergency_relation: document.getElementById('editEmergencyRelation').value,
          emergency_phone: document.getElementById('editEmergencyPhone').value,
          emergency_email: document.getElementById('editEmergencyEmail').value,
          notes: document.getElementById('editNotes').value,
          last_modified: new Date().toISOString()
        };

        console.log('💾 Updating application in Supabase:', currentApplicationId);

        const { data, error } = await supabase
          .from('applications')
          .update(updateData)
          .eq('id', currentApplicationId);

        if (error) {
          throw error;
        }

        closeModal();
        showNotification('Application updated successfully!', 'success');

        // Update will be handled by real-time subscription
        
      } catch (error) {
        console.error('❌ Error updating application:', error);
        showNotification(`Error updating application: ${error.message}`, 'error');
      }
    }

    // Complete CSV Export with All Fields
    function generateCompleteCSV(data) {
      const headers = [
        'Application ID', 'Status', 'Submission Date',
        'First Name', 'Middle Name', 'Last Name', 'Date of Birth', 'Gender', 'Nationality', 'Passport/ID Number',
        'Email', 'Phone', 'Home Address',
        'University', 'Course of Study', 'Student ID', 'Year of Study',
        'Room Type', 'Check-in Date', 'Contract Length', 'Parking Required', 'Bike Storage Required', 'Room Preferences',
        'Dietary Requirements', 'Medical Conditions', 'Additional Information',
        'Reference Name', 'Reference Relationship', 'Reference Email', 'Reference Phone',
        'Guarantor Name', 'Guarantor Relationship', 'Guarantor Email', 'Guarantor Phone', 'Guarantor Address',
        'Emergency Name', 'Emergency Relationship', 'Emergency Phone', 'Emergency Email',
        'Admin Notes', 'Last Modified'
      ];
      
      const csvData = data.map(app => [
        app.id || '',
        getStatusName(app.status) || '',
        formatDate(app.submissionDate) || '',
        app.firstName || '',
        app.middleName || '',
        app.lastName || '',
        app.dateOfBirth || '',
        app.gender || '',
        app.nationality || '',
        app.passportNumber || '',
        app.email || '',
        app.phone || '',
        app.homeAddress || '',
        getUniversityName(app.university) || '',
        app.courseOfStudy || '',
        app.studentId || '',
        app.yearOfStudy || '',
        getRoomTypeName(app.roomType) || '',
        app.checkInDate || '',
        app.contractLength || '',
        app.parkingRequired ? 'Yes' : 'No',
        app.bikeStorageRequired ? 'Yes' : 'No',
        app.roomPreferences || '',
        app.dietaryRequirements || '',
        app.medicalConditions || '',
        app.additionalInfo || '',
        app.referenceName || '',
        app.referenceRelationship || '',
        app.referenceEmail || '',
        app.referenceTelephone || '',
        app.guarantorName || '',
        app.guarantorRelationship || '',
        app.guarantorEmail || '',
        app.guarantorTelephone || '',
        app.guarantorAddress || '',
        app.emergencyName || '',
        app.emergencyRelation || '',
        app.emergencyPhone || '',
        app.emergencyEmail || '',
        app.notes || '',
        formatDate(app.lastModified) || ''
      ]);

      return [headers, ...csvData].map(row => 
        row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
    }

    // PDF Generation Functions
    function downloadApplicationPDF(applicationId) {
      const app = applications.find(a => a.id === applicationId);
      if (!app) {
        showNotification('Application not found', 'error');
        return;
      }
      
      generateApplicationPDF(app);
    }

    function downloadPDF() {
      if (!currentApplicationId) return;
      downloadApplicationPDF(currentApplicationId);
    }

    function generateApplicationPDF(app) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Set up the document with proper header
        doc.setFontSize(22);
        doc.setFont(undefined, 'bold');
        doc.text('iLm Halal Student Halls', 105, 25, { align: 'center' });
        
        doc.setFontSize(16);
        doc.setFont(undefined, 'normal');
        doc.text('Student Accommodation Application', 105, 35, { align: 'center' });
        
        // Application header info
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`Application ID: ${app.id}`, 20, 50);
        doc.text(`Status: ${getStatusName(app.status)}`, 120, 50);
        doc.text(`Submitted: ${formatDate(app.submissionDate)}`, 20, 60);
        
        // Draw a line separator
        doc.setLineWidth(0.5);
        doc.line(20, 65, 190, 65);
        
        let yPos = 75;
        const lineHeight = 6;
        const sectionSpacing = 12;
        const fieldSpacing = 4;
        
        // Helper function to add section header
        function addSectionHeader(title) {
          if (yPos > 260) {
            doc.addPage();
            yPos = 20;
          }
          doc.setFontSize(14);
          doc.setFont(undefined, 'bold');
          doc.text(title, 20, yPos);
          yPos += sectionSpacing;
        }
        
        // Helper function to add two fields in a row
        function addFieldRow(label1, value1, label2 = '', value2 = '') {
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
          
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          doc.text(`${label1}:`, 20, yPos);
          doc.setFont(undefined, 'normal');
          doc.text(value1 || 'N/A', 20, yPos + 4);
          
          if (label2) {
            doc.setFont(undefined, 'bold');
            doc.text(`${label2}:`, 110, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(value2 || 'N/A', 110, yPos + 4);
          }
          
          yPos += lineHeight + fieldSpacing;
        }
        
        // Helper function for full-width field
        function addFullWidthField(label, value) {
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
          
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          doc.text(`${label}:`, 20, yPos);
          doc.setFont(undefined, 'normal');
          
          // Handle long text by wrapping
          const textLines = doc.splitTextToSize(value || 'N/A', 170);
          doc.text(textLines, 20, yPos + 4);
          
          yPos += lineHeight + (textLines.length - 1) * 4 + fieldSpacing;
        }
        
        // 1. Personal Information
        addSectionHeader('Personal Information');
        addFieldRow('First Name', app.firstName, 'Middle Name', app.middleName);
        addFieldRow('Last Name', app.lastName, 'Date of Birth', app.dateOfBirth);
        addFieldRow('Gender', app.gender, 'Nationality', app.nationality);
        addFullWidthField('Passport/ID Number', app.passportNumber);
        
        yPos += 6;
        
        // 2. Contact Information
        addSectionHeader('Contact Information');
        addFieldRow('Email Address', app.email, 'Phone Number', app.phone);
        addFullWidthField('Home Address', app.homeAddress);
        
        yPos += 6;
        
        // 3. Academic Information
        addSectionHeader('Academic Information');
        addFieldRow('University/Institution', getUniversityName(app.university), 'Course of Study', app.courseOfStudy);
        addFieldRow('Student ID', app.studentId, 'Year of Study', app.yearOfStudy);
        
        yPos += 6;
        
        // 4. Accommodation Preferences
        addSectionHeader('Accommodation Preferences');
        addFieldRow('Room Type', getRoomTypeName(app.roomType), 'Check-in Date', app.checkInDate);
        addFieldRow('Contract Length', app.contractLength, '', '');
        
        // Additional Services
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('Additional Services:', 20, yPos);
        yPos += 4;
        doc.setFont(undefined, 'normal');
        doc.text(`• Parking Required: ${app.parkingRequired ? 'Yes (+£20/week)' : 'No'}`, 25, yPos);
        yPos += 4;
        doc.text(`• Bike Storage Required: ${app.bikeStorageRequired ? 'Yes' : 'No'}`, 25, yPos);
        yPos += fieldSpacing + 4;
        
        addFullWidthField('Room Preferences/Special Requirements', app.roomPreferences);
        
        yPos += 6;
        
        // 5. Lifestyle & Dietary Information
        addSectionHeader('Lifestyle & Dietary Information');
        addFieldRow('Dietary Requirements', app.dietaryRequirements, 'Medical Conditions/Allergies', app.medicalConditions);
        addFullWidthField('Additional Information', app.additionalInfo);
        
        yPos += 6;
        
        // 6. Reference Information
        addSectionHeader('Reference Information');
        addFieldRow('Reference Name', app.referenceName, 'Relationship to Applicant', app.referenceRelationship);
        addFieldRow('Reference Email', app.referenceEmail, 'Reference Telephone', app.referenceTelephone);
        
        yPos += 6;
        
        // 7. Guarantor Information
        addSectionHeader('Guarantor Information');
        addFieldRow('Guarantor Name', app.guarantorName, 'Relationship to Applicant', app.guarantorRelationship);
        addFieldRow('Guarantor Email', app.guarantorEmail, 'Guarantor Telephone', app.guarantorTelephone);
        addFullWidthField('Guarantor Address', app.guarantorAddress);
        
        yPos += 6;
        
        // 8. Emergency Contact
        addSectionHeader('Emergency Contact');
        addFieldRow('Emergency Contact Name', app.emergencyName, 'Relationship', app.emergencyRelation);
        addFieldRow('Emergency Phone', app.emergencyPhone, 'Emergency Email', app.emergencyEmail);
        
        yPos += 6;
        
        // 9. Admin Notes (if any)
        if (app.notes && app.notes.trim()) {
          addSectionHeader('Admin Notes');
          addFullWidthField('Notes', app.notes);
        }
        
        // Add footer with generation info
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setFont(undefined, 'normal');
          doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
          doc.text(`Generated on ${new Date().toLocaleDateString('en-GB')} by iLm Halal Student Halls Admin System`, 20, 285);
        }
        
        // Save the PDF with clean filename
        const fileName = `${app.id}-${app.firstName}-${app.lastName}-Application.pdf`;
        doc.save(fileName);
        showNotification('PDF downloaded successfully', 'success');
        
      } catch (error) {
        console.error('PDF generation error:', error);
        showNotification('Error generating PDF', 'error');
      }
    }

    // Additional Bulk Action Functions
    function bulkChangeStatus() {
      const selectedIds = getSelectedApplicationIds();
      if (selectedIds.length === 0) {
        showNotification('No applications selected', 'error');
        return;
      }

      const newStatus = prompt('Enter new status (new, review, approved, rejected, archived):');
      if (!newStatus || !['new', 'review', 'approved', 'rejected', 'archived'].includes(newStatus)) {
        showNotification('Invalid status selected', 'error');
        return;
      }

      if (!confirm(`Change status of ${selectedIds.length} applications to "${getStatusName(newStatus)}"?`)) return;

      Promise.all(selectedIds.map(async (id) => {
        try {
          await supabase
            .from('applications')
            .update({ status: newStatus, last_modified: new Date().toISOString() })
            .eq('id', id);
        } catch (error) {
          console.error(`Error updating ${id}:`, error);
        }
      })).then(() => {
        showNotification(`${selectedIds.length} applications updated to ${getStatusName(newStatus)}`, 'success');
        clearSelection();
        closeBulkModal();
      }).catch(() => {
        showNotification('Some applications failed to update', 'error');
      });
    }

    // Update format application function to handle all the new fields
    function formatApplicationFromDB(dbApp) {
      return {
        id: dbApp.id,
        firstName: dbApp.first_name || '',
        middleName: dbApp.middle_name || '',
        lastName: dbApp.last_name || '',
        email: dbApp.email || '',
        phone: dbApp.phone || '',
        dateOfBirth: dbApp.date_of_birth || '',
        gender: dbApp.gender || '',
        nationality: dbApp.nationality || '',
        passportNumber: dbApp.passport_number || '',
        university: dbApp.university || '',
        otherUniversity: dbApp.other_university || '',
        courseOfStudy: dbApp.course_of_study || '',
        studentId: dbApp.student_id || '',
        yearOfStudy: dbApp.year_of_study || '',
        roomType: dbApp.room_type || '',
        checkInDate: dbApp.check_in_date || '',
        contractLength: dbApp.contract_length || '',
        status: dbApp.status || 'new',
        submissionDate: dbApp.submission_date || dbApp.created_at,
        homeAddress: dbApp.home_address || '',
        roomPreferences: dbApp.room_preferences || '',
        dietaryRequirements: dbApp.dietary_requirements || '',
        medicalConditions: dbApp.medical_conditions || '',
        additionalInfo: dbApp.additional_info || '',
        referenceName: dbApp.reference_name || '',
        referenceRelationship: dbApp.reference_relationship || '',
        referenceEmail: dbApp.reference_email || '',
        referenceTelephone: dbApp.reference_telephone || '',
        guarantorName: dbApp.guarantor_name || '',
        guarantorRelationship: dbApp.guarantor_relationship || '',
        guarantorEmail: dbApp.guarantor_email || '',
        guarantorTelephone: dbApp.guarantor_telephone || '',
        guarantorAddress: dbApp.guarantor_address || '',
        emergencyName: dbApp.emergency_name || '',
        emergencyRelation: dbApp.emergency_relation || '',
        emergencyPhone: dbApp.emergency_phone || '',
        emergencyEmail: dbApp.emergency_email || '',
        parkingRequired: dbApp.parking_required || false,
        bikeStorageRequired: dbApp.bike_storage_required || false,
        notes: dbApp.notes || '',
        lastModified: dbApp.last_modified || dbApp.created_at,
        createdAt: dbApp.created_at
      };
    }

    // Analytics Functions
    async function loadAnalyticsData() {
      try {
        console.log('📊 Loading privacy-compliant analytics...');
        
        // Load anonymized analytics data
        const analyticsData = JSON.parse(localStorage.getItem('ilm_analytics') || '{}');
        
        // Process and display analytics
        updateAnalyticsOverview(analyticsData);
        updatePerformanceMetrics(analyticsData);
        updateUserJourneyData(analyticsData);
        updateAccessibilityInsights(analyticsData);
        
        console.log('✅ Analytics loaded successfully');
        
      } catch (error) {
        console.error('❌ Error loading analytics:', error);
        showNotification('Error loading analytics data', 'error');
      }
    }

    function updateAnalyticsOverview(data) {
      // Active Sessions (last 24 hours)
      const engagementData = data.engagement || [];
      const last24h = Date.now() - (24 * 60 * 60 * 1000);
      const recentSessions = engagementData.filter(session => session.timestamp > last24h);
      document.getElementById('activeVisitors').textContent = recentSessions.length;
      
      // Average Page Time
      if (recentSessions.length > 0) {
        const avgTime = recentSessions.reduce((sum, session) => sum + (session.interactions?.timeOnPage || 0), 0) / recentSessions.length;
        document.getElementById('avgPageTime').textContent = formatTime(avgTime);
      }
      
      // Booking Conversion Rate
      const journeyData = data.user_journey || [];
      const totalSessions = journeyData.length;
      const bookingCompletions = journeyData.filter(journey => journey.goals?.completedBooking).length;
      const conversionRate = totalSessions > 0 ? Math.round((bookingCompletions / totalSessions) * 100) : 0;
      document.getElementById('conversionRate').textContent = `${conversionRate}%`;
      
      // Privacy Consent Rate
      const consentStats = JSON.parse(localStorage.getItem('ilm_consent_stats') || '{}');
      const totalChoices = Object.values(consentStats).reduce((sum, count) => {
        return sum + (typeof count === 'number' ? count : 0);
      }, 0);
      const analyticsConsent = (consentStats.FAM || 0) + (consentStats.FAm || 0) + (consentStats.fAM || 0) + (consentStats.fAm || 0);
      const consentRate = totalChoices > 0 ? Math.round((analyticsConsent / totalChoices) * 100) : 0;
      document.getElementById('privacyConsent').textContent = `${consentRate}%`;
      
      // Popular Features
      updatePopularFeatures(data.features || []);
    }

    function updatePopularFeatures(featuresData) {
      const featuresList = document.getElementById('popularFeatures');
      
      // Aggregate feature usage
      const featureUsage = {};
      featuresData.forEach(session => {
        Object.entries(session.features || {}).forEach(([feature, count]) => {
          featureUsage[feature] = (featureUsage[feature] || 0) + count;
        });
      });
      
      // Sort by usage
      const sortedFeatures = Object.entries(featureUsage)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5);
      
      featuresList.innerHTML = sortedFeatures.length > 0 
        ? sortedFeatures.map(([feature, usage]) => `
          <div class="feature-item">
            <span class="feature-name">${formatFeatureName(feature)}</span>
            <span class="feature-usage">${usage} uses</span>
          </div>
        `).join('')
        : '<div class="feature-item"><span class="feature-name">No feature data available</span><span class="feature-usage">--</span></div>';
    }

    function updatePerformanceMetrics(data) {
      const performanceData = data.performance || [];
      
      if (performanceData.length > 0) {
        // Calculate averages for the last 10 sessions
        const recentSessions = performanceData.slice(-10);
        
        const avgFirstPaint = recentSessions.reduce((sum, session) => 
          sum + (session.metrics?.firstPaint || 0), 0) / recentSessions.length;
        const avgLCP = recentSessions.reduce((sum, session) => 
          sum + (session.metrics?.largestContentfulPaint || 0), 0) / recentSessions.length;
        const avgCLS = recentSessions.reduce((sum, session) => 
          sum + (session.metrics?.cumulativeLayoutShift || 0), 0) / recentSessions.length;
        
        // Update display
        document.getElementById('firstPaint').textContent = `${Math.round(avgFirstPaint)}ms`;
        document.getElementById('largestContentfulPaint').textContent = `${Math.round(avgLCP)}ms`;
        document.getElementById('cumulativeLayoutShift').textContent = avgCLS.toFixed(3);
        
        // Update status indicators
        document.getElementById('firstPaintStatus').textContent = avgFirstPaint < 1000 ? 'Good' : avgFirstPaint < 3000 ? 'Needs Improvement' : 'Poor';
        document.getElementById('lcpStatus').textContent = avgLCP < 2500 ? 'Good' : avgLCP < 4000 ? 'Needs Improvement' : 'Poor';
        document.getElementById('clsStatus').textContent = avgCLS < 0.1 ? 'Good' : avgCLS < 0.25 ? 'Needs Improvement' : 'Poor';
      }
      
      // Performance Issues
      const performanceIssues = data.performance_issues || [];
      updatePerformanceIssues(performanceIssues);
    }

    function updatePerformanceIssues(issuesData) {
      const issuesList = document.getElementById('performanceIssues');
      
      // Aggregate issues from last 24 hours
      const last24h = Date.now() - (24 * 60 * 60 * 1000);
      const recentIssues = issuesData.filter(session => session.timestamp > last24h);
      
      const issueTypes = {};
      recentIssues.forEach(session => {
        session.issues?.forEach(issue => {
          issueTypes[issue.type] = (issueTypes[issue.type] || 0) + 1;
        });
      });
      
      const sortedIssues = Object.entries(issueTypes).sort(([,a], [,b]) => b - a);
      
      issuesList.innerHTML = sortedIssues.length > 0
        ? sortedIssues.map(([type, count]) => `
          <div class="issue-item">
            <span class="issue-type">${formatIssueType(type)}</span>
            <span class="issue-count">${count} occurrences</span>
          </div>
        `).join('')
        : '<div class="issue-item"><span class="issue-type">No issues detected</span></div>';
    }

    function updateUserJourneyData(data) {
      const journeyData = data.user_journey || [];
      
      if (journeyData.length > 0) {
        // Calculate journey step percentages
        const totalJourneys = journeyData.length;
        const galleryViews = journeyData.filter(j => j.goals?.viewedGallery).length;
        const bookingStarts = journeyData.filter(j => j.goals?.startedBooking).length;
        const bookingCompletions = journeyData.filter(j => j.goals?.completedBooking).length;
        
        // Update journey steps
        const steps = document.querySelectorAll('.journey-step');
        if (steps.length >= 3) {
          steps[1].querySelector('.step-percentage').textContent = `${Math.round((galleryViews / totalJourneys) * 100)}%`;
          steps[2].querySelector('.step-percentage').textContent = `${Math.round((bookingStarts / totalJourneys) * 100)}%`;
        }
        
        // Update goal completion
        updateGoalCompletion(journeyData);
      }
    }

    function updateGoalCompletion(journeyData) {
      const goalsList = document.getElementById('goalsList');
      const totalJourneys = journeyData.length;
      
      const goals = [
        { name: 'Gallery Viewed', key: 'viewedGallery', icon: '🖼️' },
        { name: 'Booking Started', key: 'startedBooking', icon: '📝' },
        { name: 'Booking Completed', key: 'completedBooking', icon: '✅' },
        { name: 'Contact Viewed', key: 'viewedContact', icon: '📞' },
        { name: 'FAQ Accessed', key: 'readFAQ', icon: '❓' },
        { name: 'Privacy Customized', key: 'customizedPrivacy', icon: '🔒' }
      ];
      
      goalsList.innerHTML = goals.map(goal => {
        const completions = journeyData.filter(journey => journey.goals?.[goal.key]).length;
        const percentage = totalJourneys > 0 ? Math.round((completions / totalJourneys) * 100) : 0;
        
        return `
          <div class="goal-item">
            <span class="goal-icon">${goal.icon}</span>
            <span class="goal-name">${goal.name}</span>
            <div class="goal-bar">
              <div class="goal-progress" style="width: ${percentage}%"></div>
            </div>
            <span class="goal-percentage">${percentage}%</span>
          </div>
        `;
      }).join('');
    }

    function updateAccessibilityInsights(data) {
      const a11yData = data.accessibility || [];
      
      if (a11yData.length > 0) {
        const totalSessions = a11yData.length;
        
        // Calculate percentages for each accessibility feature
        const keyboardNav = a11yData.filter(session => session.indicators?.keyboardNavigation).length;
        const screenReader = a11yData.filter(session => session.indicators?.screenReaderUsage).length;
        const highContrast = a11yData.filter(session => session.indicators?.highContrast).length;
        const reducedMotion = a11yData.filter(session => session.indicators?.reducedMotion).length;
        
        // Update display
        const a11yItems = document.querySelectorAll('.a11y-item .a11y-percentage');
        if (a11yItems.length >= 4) {
          a11yItems[0].textContent = `${Math.round((keyboardNav / totalSessions) * 100)}%`;
          a11yItems[1].textContent = `${Math.round((screenReader / totalSessions) * 100)}%`;
          a11yItems[2].textContent = `${Math.round((highContrast / totalSessions) * 100)}%`;
          a11yItems[3].textContent = `${Math.round((reducedMotion / totalSessions) * 100)}%`;
        }
      }
      
      // Form Analytics
      updateFormAnalytics(data);
    }

    function updateFormAnalytics(data) {
      const formCompletions = data.form_completion || [];
      const formAbandonments = data.form_abandonment || [];
      const formErrors = data.errors || [];
      
      const formStats = document.querySelectorAll('.form-stat .stat-value');
      
      if (formStats.length >= 3) {
        // Average completion time
        if (formCompletions.length > 0) {
          const avgTime = formCompletions.reduce((sum, form) => sum + (form.completionTime || 0), 0) / formCompletions.length;
          formStats[0].textContent = formatTime(avgTime);
        }
        
        // Abandonment rate
        const totalAttempts = formCompletions.length + formAbandonments.length;
        const abandonmentRate = totalAttempts > 0 ? Math.round((formAbandonments.length / totalAttempts) * 100) : 0;
        formStats[1].textContent = `${abandonmentRate}%`;
        
        // Most common errors
        const errorTypes = {};
        formErrors.forEach(session => {
          session.errors?.forEach(error => {
            if (error.type !== 'password') {
              errorTypes[error.field] = (errorTypes[error.field] || 0) + 1;
            }
          });
        });
        
        const mostCommonError = Object.entries(errorTypes).sort(([,a], [,b]) => b - a)[0];
        formStats[2].textContent = mostCommonError ? `${mostCommonError[0]} (${mostCommonError[1]} times)` : 'None detected';
      }
    }

    // Analytics Tab Management
    function showAnalyticsTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.analytics-tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.analytics-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(`analytics-${tabName}`).classList.add('active');
      
      // Add active class to clicked tab
      event.target.classList.add('active');
    }

    // Export Analytics Report
    function exportAnalytics() {
      try {
        const analyticsData = JSON.parse(localStorage.getItem('ilm_analytics') || '{}');
        const consentStats = JSON.parse(localStorage.getItem('ilm_consent_stats') || '{}');
        
        // Create comprehensive report
        const report = {
          generatedAt: new Date().toISOString(),
          reportType: 'Privacy-Compliant Analytics',
          summary: {
            totalSessions: (analyticsData.engagement || []).length,
            analyticsConsent: Object.values(consentStats).reduce((sum, count) => sum + (typeof count === 'number' ? count : 0), 0),
            dataTypes: Object.keys(analyticsData),
            privacyCompliant: true
          },
          metrics: generateAnalyticsReport(analyticsData),
          privacy: {
            dataAnonymized: true,
            consentRequired: true,
            userControlled: true,
            gdprCompliant: true
          }
        };
        
        // Export as JSON
        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `ilm-analytics-report-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showNotification('Analytics report exported successfully', 'success');
        
      } catch (error) {
        console.error('Export error:', error);
        showNotification('Error exporting analytics report', 'error');
      }
    }

    function generateAnalyticsReport(data) {
      return {
        performance: {
          sessions: (data.performance || []).length,
          avgLoadTime: calculateAverage(data.performance, 'metrics.windowLoaded'),
          issues: (data.performance_issues || []).length
        },
        userBehavior: {
          sessions: (data.engagement || []).length,
          avgSessionTime: calculateAverage(data.engagement, 'interactions.timeOnPage'),
          featureUsage: aggregateFeatureUsage(data.features || [])
        },
        userJourney: {
          totalJourneys: (data.user_journey || []).length,
          goalCompletions: calculateGoalCompletions(data.user_journey || [])
        },
        accessibility: {
          sessions: (data.accessibility || []).length,
          usage: calculateAccessibilityUsage(data.accessibility || [])
        },
        forms: {
          completions: (data.form_completion || []).length,
          abandonments: (data.form_abandonment || []).length,
          avgCompletionTime: calculateAverage(data.form_completion, 'completionTime')
        }
      };
    }

    // Utility Functions
    function formatTime(milliseconds) {
      if (!milliseconds) return '--';
      const seconds = Math.round(milliseconds / 1000);
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return minutes > 0 ? `${minutes}m ${remainingSeconds}s` : `${seconds}s`;
    }

    function formatFeatureName(feature) {
      return feature.replace(/([A-Z])/g, ' $1')
                   .replace(/^./, str => str.toUpperCase())
                   .replace(/_/g, ' ');
    }

    function formatIssueType(type) {
      return type.replace(/_/g, ' ')
                 .replace(/\b\w/g, l => l.toUpperCase());
    }

    function calculateAverage(dataArray, path) {
      if (!dataArray || dataArray.length === 0) return 0;
      
      const values = dataArray.map(item => {
        const keys = path.split('.');
        let value = item;
        for (const key of keys) {
          value = value?.[key];
        }
        return value || 0;
      });
      
      return values.reduce((sum, val) => sum + val, 0) / values.length;
    }

    function aggregateFeatureUsage(featuresData) {
      const usage = {};
      featuresData.forEach(session => {
        Object.entries(session.features || {}).forEach(([feature, count]) => {
          usage[feature] = (usage[feature] || 0) + count;
        });
      });
      return usage;
    }

    function calculateGoalCompletions(journeyData) {
      const goals = ['viewedGallery', 'startedBooking', 'completedBooking', 'viewedContact', 'readFAQ', 'customizedPrivacy'];
      const completions = {};
      
      goals.forEach(goal => {
        completions[goal] = journeyData.filter(journey => journey.goals?.[goal]).length;
      });
      
      return completions;
    }

    function calculateAccessibilityUsage(a11yData) {
      const indicators = ['keyboardNavigation', 'screenReaderUsage', 'highContrast', 'reducedMotion', 'focusVisible'];
      const usage = {};
      
      indicators.forEach(indicator => {
        usage[indicator] = a11yData.filter(session => session.indicators?.[indicator]).length;
      });
      
      return usage;
    }

    // Initialize analytics when dashboard loads
    document.addEventListener('DOMContentLoaded', function() {
      initializeDashboard();
      initializeNotifications();
      
      // Load analytics data after a short delay
      setTimeout(() => {
        loadAnalyticsData();
        
        // Refresh analytics every 5 minutes
        setInterval(loadAnalyticsData, 5 * 60 * 1000);
      }, 1000);
    });

    // Debug function to check specific images
    async function debugGalleryImage(imageTitle) {
      try {
        console.log(`🔍 Debugging gallery image: ${imageTitle}`);
        
        const { data, error } = await supabase
          .from('gallery_images')
          .select('*')
          .ilike('title', `%${imageTitle}%`);
          
        if (error) throw error;
        
        console.log('Found images:', data);
        
        if (data.length === 0) {
          console.log('❌ No images found with that title. Try searching by ID or URL fragment.');
          
          // Try broader search
          const { data: allImages, error: allError } = await supabase
            .from('gallery_images')
            .select('id, title, url, is_visible, display_order, category, created_at')
            .order('created_at', { ascending: false })
            .limit(10);
            
          if (!allError) {
            console.log('📋 Recent 10 images:');
            allImages.forEach((img, index) => {
              console.log(`${index + 1}. ID: ${img.id}, Title: "${img.title || 'Untitled'}", Visible: ${img.is_visible}, Order: ${img.display_order}`);
            });
          }
        } else {
          data.forEach(img => {
            console.log(`📸 Image "${img.title || 'Untitled'}":
              - ID: ${img.id}
              - Visible: ${img.is_visible}
              - Display Order: ${img.display_order}
              - Category: ${img.category}
              - URL: ${img.url}
              - Created: ${img.created_at}`);
              
            if (!img.is_visible) {
              console.log('⚠️ This image is hidden (is_visible = false)');
            }
          });
        }
        
        showNotification(`Debug results logged to console for "${imageTitle}"`, 'info');
        
      } catch (error) {
        console.error('❌ Debug error:', error);
        showNotification(`Debug error: ${error.message}`, 'error');
      }
    }

    // Function to toggle visibility of specific image
    async function toggleImageVisibility(imageId) {
      try {
        const image = galleryImages.find(img => img.id === imageId);
        if (!image) {
          showNotification('Image not found', 'error');
          return;
        }
        
        const { error } = await supabase
          .from('gallery_images')
          .update({ is_visible: !image.is_visible })
          .eq('id', imageId);
          
        if (error) throw error;
        
        showNotification(`Image visibility toggled to ${!image.is_visible ? 'visible' : 'hidden'}`, 'success');
        await loadGalleryImages();
        
      } catch (error) {
        console.error('❌ Toggle visibility error:', error);
        showNotification(`Error toggling visibility: ${error.message}`, 'error');
      }
    }

    // Debug Modal Functions
    function openDebugModal() {
      document.getElementById('debugModal').style.display = 'flex';
      document.getElementById('debugResults').textContent = 'Use the buttons above to debug gallery issues...';
    }

    function closeDebugModal() {
      document.getElementById('debugModal').style.display = 'none';
    }

    async function searchDebugImage() {
      const searchTerm = document.getElementById('debugSearchTerm').value.trim();
      const resultsDiv = document.getElementById('debugResults');
      
      if (!searchTerm) {
        resultsDiv.textContent = '❌ Please enter a search term';
        return;
      }
      
      resultsDiv.textContent = `🔍 Searching for: "${searchTerm}"\n\n`;
      
      try {
        // Search by title
        const { data: titleResults, error: titleError } = await supabase
          .from('gallery_images')
          .select('*')
          .ilike('title', `%${searchTerm}%`);
          
        // Search by URL
        const { data: urlResults, error: urlError } = await supabase
          .from('gallery_images')
          .select('*')
          .ilike('url', `%${searchTerm}%`);
          
        // Search by ID if it's a number
        let idResults = [];
        if (!isNaN(searchTerm)) {
          const { data, error } = await supabase
            .from('gallery_images')
            .select('*')
            .eq('id', parseInt(searchTerm));
          if (!error) idResults = data || [];
        }
        
        // Combine and deduplicate results
        const allResults = [...(titleResults || []), ...(urlResults || []), ...idResults];
        const uniqueResults = allResults.filter((item, index, self) => 
          index === self.findIndex(t => t.id === item.id)
        );
        
        if (uniqueResults.length === 0) {
          resultsDiv.textContent += '❌ No images found matching your search.\n\n';
          resultsDiv.textContent += '💡 Try searching for:\n- Part of the image title\n- Part of the image URL\n- Image ID number';
        } else {
          resultsDiv.textContent += `✅ Found ${uniqueResults.length} matching image(s):\n\n`;
          
          uniqueResults.forEach((img, index) => {
            resultsDiv.textContent += `${index + 1}. "${img.title || 'Untitled'}" (ID: ${img.id})\n`;
            resultsDiv.textContent += `   📸 Visible: ${img.is_visible ? '✅ YES' : '❌ NO (HIDDEN)'}\n`;
            resultsDiv.textContent += `   📊 Display Order: ${img.display_order}\n`;
            resultsDiv.textContent += `   📁 Category: ${img.category}\n`;
            resultsDiv.textContent += `   🔗 URL: ${img.url}\n`;
            resultsDiv.textContent += `   📅 Created: ${new Date(img.created_at).toLocaleString()}\n\n`;
          });
        }
        
      } catch (error) {
        resultsDiv.textContent += `❌ Error searching: ${error.message}`;
      }
    }

    async function listRecentImages() {
      const resultsDiv = document.getElementById('debugResults');
      resultsDiv.textContent = '📋 Loading recent images...\n\n';
      
      try {
        const { data, error } = await supabase
          .from('gallery_images')
          .select('id, title, url, is_visible, display_order, category, created_at')
          .order('created_at', { ascending: false })
          .limit(20);
          
        if (error) throw error;
        
        resultsDiv.textContent = `📋 Latest 20 images in database:\n\n`;
        
        data.forEach((img, index) => {
          resultsDiv.textContent += `${index + 1}. "${img.title || 'Untitled'}" (ID: ${img.id})\n`;
          resultsDiv.textContent += `   📸 Visible: ${img.is_visible ? '✅' : '❌ HIDDEN'}\n`;
          resultsDiv.textContent += `   📊 Order: ${img.display_order}\n`;
          resultsDiv.textContent += `   📁 Category: ${img.category}\n`;
          resultsDiv.textContent += `   📅 ${new Date(img.created_at).toLocaleDateString()}\n\n`;
        });
        
      } catch (error) {
        resultsDiv.textContent += `❌ Error: ${error.message}`;
      }
    }

    async function checkHiddenImages() {
      const resultsDiv = document.getElementById('debugResults');
      resultsDiv.textContent = '👁️ Checking for hidden images...\n\n';
      
      try {
        const { data, error } = await supabase
          .from('gallery_images')
          .select('id, title, url, display_order, category, created_at')
          .eq('is_visible', false)
          .order('created_at', { ascending: false });
          
        if (error) throw error;
        
        if (data.length === 0) {
          resultsDiv.textContent += '✅ No hidden images found - all images are visible!';
        } else {
          resultsDiv.textContent += `❌ Found ${data.length} hidden image(s):\n\n`;
          
          data.forEach((img, index) => {
            resultsDiv.textContent += `${index + 1}. "${img.title || 'Untitled'}" (ID: ${img.id})\n`;
            resultsDiv.textContent += `   📊 Order: ${img.display_order}\n`;
            resultsDiv.textContent += `   📁 Category: ${img.category}\n`;
            resultsDiv.textContent += `   📅 ${new Date(img.created_at).toLocaleDateString()}\n`;
            resultsDiv.textContent += `   🔧 To make visible: UPDATE gallery_images SET is_visible = true WHERE id = ${img.id};\n\n`;
          });
          
          resultsDiv.textContent += '\n💡 These images are in the database but won\'t show in the public gallery because is_visible = false';
        }
        
      } catch (error) {
        resultsDiv.textContent += `❌ Error: ${error.message}`;
      }
    }

    async function validateImageUrls() {
      const resultsDiv = document.getElementById('debugResults');
      resultsDiv.textContent = '🔗 Validating image URLs...\n\n';
      
      try {
        const { data, error } = await supabase
          .from('gallery_images')
          .select('id, title, url, is_visible')
          .eq('is_visible', true)
          .order('id');
          
        if (error) throw error;
        
        resultsDiv.textContent += `🔗 Checking ${data.length} visible images...\n\n`;
        
        let validCount = 0;
        let invalidCount = 0;
        
        for (const img of data) {
          try {
            const response = await fetch(img.url, { method: 'HEAD' });
            if (response.ok) {
              validCount++;
              resultsDiv.textContent += `✅ ${img.title || 'Untitled'} (ID: ${img.id})\n`;
            } else {
              invalidCount++;
              resultsDiv.textContent += `❌ ${img.title || 'Untitled'} (ID: ${img.id}) - Status: ${response.status}\n`;
            }
          } catch (urlError) {
            invalidCount++;
            resultsDiv.textContent += `❌ ${img.title || 'Untitled'} (ID: ${img.id}) - Error: ${urlError.message}\n`;
          }
        }
        
        resultsDiv.textContent += `\n📊 Summary: ${validCount} valid, ${invalidCount} invalid URLs`;
        
      } catch (error) {
        resultsDiv.textContent += `❌ Error: ${error.message}`;
      }
    }

    // Function to renumber all images sequentially
    async function renumberGalleryImages() {
      try {
        console.log('🔢 Renumbering gallery images...');
        
        // Store reorder mode state
        const wasInReorderMode = isReorderMode;
        
        // Show notification only if not called from reorder operations
        if (!wasInReorderMode) {
          showNotification('Renumbering images...', 'info');
        }
        
        // Get all images in current display order
        const { data: images, error } = await supabase
          .from('gallery_images')
          .select('id, display_order, title')
          .order('display_order', { nullsFirst: false })
          .order('created_at', { ascending: false });
          
        if (error) throw error;
        
        // Renumber sequentially starting from 1
        const updates = images.map((image, index) => {
          const newOrder = index + 1;
          return supabase
            .from('gallery_images')
            .update({ display_order: newOrder })
            .eq('id', image.id);
        });
        
        // Execute all updates
        await Promise.all(updates);
        
        console.log(`✅ Renumbered ${images.length} images sequentially`);
        
        // Show notification only if not called from reorder operations
        if (!wasInReorderMode) {
          showNotification(`Successfully renumbered ${images.length} images`, 'success');
        }
        
        // Reload gallery to show new order
        await loadGalleryImages();
        
        // Restore reorder mode if it was active
        if (wasInReorderMode) {
          setTimeout(() => {
            isReorderMode = true;
            enableReorderMode();
          }, 100);
        }
        
      } catch (error) {
        console.error('❌ Error renumbering images:', error);
        showNotification(`Error renumbering images: ${error.message}`, 'error');
      }
    }

    async function checkDisplayOrder() {
      const resultsDiv = document.getElementById('debugResults');
      resultsDiv.textContent = '🔢 Checking display order consistency...\n\n';
      
      try {
        const { data, error } = await supabase
          .from('gallery_images')
          .select('id, title, display_order, is_visible')
          .order('display_order', { nullsFirst: false })
          .order('created_at', { ascending: false });
          
        if (error) throw error;
        
        resultsDiv.textContent += `📊 Analyzing ${data.length} total images...\n\n`;
        
        // Check for null or zero display_order values
        const nullOrders = data.filter(img => !img.display_order || img.display_order === 0);
        if (nullOrders.length > 0) {
          resultsDiv.textContent += `⚠️ ${nullOrders.length} images with missing/zero display_order:\n`;
          nullOrders.forEach(img => {
            resultsDiv.textContent += `   - "${img.title || 'Untitled'}" (ID: ${img.id})\n`;
          });
          resultsDiv.textContent += '\n';
        }
        
        // Check for gaps in numbering
        const validOrders = data
          .filter(img => img.display_order && img.display_order > 0)
          .map(img => img.display_order)
          .sort((a, b) => a - b);
          
        if (validOrders.length > 0) {
          resultsDiv.textContent += `🔢 Valid display orders: ${validOrders.join(', ')}\n\n`;
          
          const gaps = [];
          for (let i = 1; i < validOrders[validOrders.length - 1]; i++) {
            if (!validOrders.includes(i)) {
              gaps.push(i);
            }
          }
          
          if (gaps.length > 0) {
            resultsDiv.textContent += `❌ Gaps found in numbering: ${gaps.join(', ')}\n`;
            resultsDiv.textContent += `💡 Consider running "Renumber Images" to fix gaps\n\n`;
          } else {
            resultsDiv.textContent += `✅ No gaps in numbering sequence\n\n`;
          }
        }
        
        // Check for duplicates
        const duplicates = {};
        data.forEach(img => {
          if (img.display_order && img.display_order > 0) {
            if (duplicates[img.display_order]) {
              duplicates[img.display_order].push(img);
            } else {
              duplicates[img.display_order] = [img];
            }
          }
        });
        
        const dupeOrders = Object.keys(duplicates).filter(order => duplicates[order].length > 1);
        if (dupeOrders.length > 0) {
          resultsDiv.textContent += `❌ Duplicate display orders found:\n`;
          dupeOrders.forEach(order => {
            resultsDiv.textContent += `   Order ${order}: ${duplicates[order].length} images\n`;
            duplicates[order].forEach(img => {
              resultsDiv.textContent += `     - "${img.title || 'Untitled'}" (ID: ${img.id})\n`;
            });
          });
          resultsDiv.textContent += `💡 Run "Renumber Images" to fix duplicates\n\n`;
        } else {
          resultsDiv.textContent += `✅ No duplicate display orders found\n\n`;
        }
        
        // Show current order vs expected order
        const visibleImages = data.filter(img => img.is_visible);
        resultsDiv.textContent += `📋 Current order of visible images:\n`;
        visibleImages.forEach((img, index) => {
          const expectedOrder = index + 1;
          const actualOrder = img.display_order || 'NULL';
          const status = actualOrder === expectedOrder ? '✅' : '❌';
          resultsDiv.textContent += `${status} ${expectedOrder}. "${img.title || 'Untitled'}" (Order: ${actualOrder}, ID: ${img.id})\n`;
        });
        
      } catch (error) {
        resultsDiv.textContent += `❌ Error: ${error.message}`;
      }
    }

    // Category Management Functions
    function openCategoryModal() {
      document.getElementById('categoryModal').style.display = 'flex';
      loadCategoryList();
    }

    function closeCategoryModal() {
      document.getElementById('categoryModal').style.display = 'none';
      document.getElementById('categoryForm').reset();
      document.getElementById('categoryId').value = '';
      document.getElementById('categorySaveBtn').textContent = 'Add Category';
    }

    async function loadCategoryList() {
      try {
        const { data, error } = await supabase
          .from('gallery_categories')
          .select('*')
          .order('display_order')
          .order('created_at');

        if (error) throw error;

        const listContainer = document.getElementById('categoryList');
        
        if (data.length === 0) {
          listContainer.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No categories found. Add your first category above.</p>';
          return;
        }

        const categoryHTML = data.map((category, index) => `
          <div class="category-item" data-category-id="${category.id}">
            <div class="category-info">
              <div class="category-names">
                <strong>${category.display_name}</strong>
                <span class="category-internal-name">(${category.name})</span>
              </div>
              <div class="category-meta">
                Order: ${category.display_order || 'N/A'} | 
                Status: ${category.is_active ? 'Active' : 'Inactive'} |
                Created: ${new Date(category.created_at).toLocaleDateString()}
              </div>
            </div>
            <div class="category-actions">
              <button class="btn-small btn-edit" onclick="editCategory('${category.id}')">Edit</button>
              <button class="btn-small ${category.is_active ? 'btn-archive' : 'btn-view'}" onclick="toggleCategoryStatus('${category.id}')">${category.is_active ? 'Deactivate' : 'Activate'}</button>
              <button class="btn-small btn-delete" onclick="deleteCategory('${category.id}')">Delete</button>
            </div>
          </div>
        `).join('');

        listContainer.innerHTML = categoryHTML;

      } catch (error) {
        console.error('Error loading categories:', error);
        showNotification(`Error loading categories: ${error.message}`, 'error');
      }
    }

    async function saveCategory(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const categoryId = formData.get('categoryId');
      const isEdit = !!categoryId;
      
      // Get next display order for new categories
      let displayOrder = 1;
      if (!isEdit) {
        try {
          const { data: maxOrderData, error: maxError } = await supabase
            .from('gallery_categories')
            .select('display_order')
            .order('display_order', { ascending: false, nullsFirst: false })
            .limit(1);
            
          if (!maxError && maxOrderData && maxOrderData.length > 0) {
            displayOrder = (maxOrderData[0].display_order || 0) + 1;
          }
        } catch (error) {
          console.warn('Could not determine next display order, using 1');
        }
      }
      
      const categoryData = {
        name: formData.get('categoryName').toLowerCase().trim(),
        display_name: formData.get('categoryDisplayName').trim(),
        is_active: true
      };
      
      if (!isEdit) {
        categoryData.display_order = displayOrder;
      }

      try {
        let result;
        
        if (isEdit) {
          result = await supabase
            .from('gallery_categories')
            .update(categoryData)
            .eq('id', categoryId);
        } else {
          result = await supabase
            .from('gallery_categories')
            .insert([categoryData]);
        }

        if (result.error) throw result.error;

        showNotification(`Category ${isEdit ? 'updated' : 'added'} successfully!`, 'success');
        document.getElementById('categoryForm').reset();
        document.getElementById('categoryId').value = '';
        document.getElementById('categorySaveBtn').textContent = 'Add Category';
        
        await loadCategoryList();
        await loadGalleryCategories(); // Refresh category dropdowns
        
      } catch (error) {
        console.error('Error saving category:', error);
        showNotification(`Error saving category: ${error.message}`, 'error');
      }
    }

    function editCategory(categoryId) {
      const category = galleryCategories.find(cat => cat.id == categoryId);
      if (!category) return;

      document.getElementById('categoryId').value = category.id;
      document.getElementById('categoryName').value = category.name;
      document.getElementById('categoryDisplayName').value = category.display_name;
      document.getElementById('categorySaveBtn').textContent = 'Update Category';
    }

    async function toggleCategoryStatus(categoryId) {
      try {
        const category = galleryCategories.find(cat => cat.id == categoryId);
        if (!category) return;

        const { error } = await supabase
          .from('gallery_categories')
          .update({ is_active: !category.is_active })
          .eq('id', categoryId);

        if (error) throw error;

        showNotification(`Category ${!category.is_active ? 'activated' : 'deactivated'} successfully!`, 'success');
        await loadCategoryList();
        await loadGalleryCategories();
        
      } catch (error) {
        console.error('Error toggling category status:', error);
        showNotification(`Error updating category: ${error.message}`, 'error');
      }
    }

    async function deleteCategory(categoryId) {
      try {
        // First check if any images use this category
        const { data: imagesInCategory, error: checkError } = await supabase
          .from('gallery_images')
          .select('id, title')
          .eq('category', galleryCategories.find(cat => cat.id == categoryId)?.name);

        if (checkError) throw checkError;

        if (imagesInCategory && imagesInCategory.length > 0) {
          const imageList = imagesInCategory.map(img => `"${img.title || 'Untitled'}"`).join(', ');
          showNotification(`Cannot delete category: ${imagesInCategory.length} images are using it: ${imageList}`, 'error');
          return;
        }

        if (!confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
          return;
        }

        const { error } = await supabase
          .from('gallery_categories')
          .delete()
          .eq('id', categoryId);

        if (error) throw error;

        showNotification('Category deleted successfully!', 'success');
        await loadCategoryList();
        await loadGalleryCategories();
        
      } catch (error) {
        console.error('Error deleting category:', error);
        showNotification(`Error deleting category: ${error.message}`, 'error');
      }
    }

    // ===================================
    // DOCUMENT MANAGEMENT FUNCTIONS
    // ===================================

    // Global variables for document management
    let currentDocuments = [];

    // Section switching functionality
    function showSection(sectionName) {
      // Hide all sections
      document.getElementById('applicationsSection').style.display = 'none';
      document.getElementById('documentsSection').style.display = 'none';
      document.getElementById('studentsSection').style.display = 'none';
      
      // Update tab states
      document.querySelectorAll('.dashboard-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected section and activate tab
      if (sectionName === 'applications') {
        document.getElementById('applicationsSection').style.display = 'block';
        document.querySelectorAll('.dashboard-tab')[0].classList.add('active');
      } else if (sectionName === 'documents') {
        document.getElementById('documentsSection').style.display = 'block';
        document.querySelectorAll('.dashboard-tab')[1].classList.add('active');
        loadDocuments(); // Load documents when switching to this section
      } else if (sectionName === 'students') {
        document.getElementById('studentsSection').style.display = 'block';
        document.querySelectorAll('.dashboard-tab')[2].classList.add('active');
        loadStudents(); // Load students when switching to this section
      }
    }

    // Document management functions
    async function initializeDocumentManagement() {
      // Set up form submission
      document.getElementById('documentUploadForm').addEventListener('submit', handleDocumentUpload);
      
      // Set up checkbox behavior
      document.getElementById('isSharedDocument').addEventListener('change', function() {
        const roomNumberGroup = document.getElementById('roomNumberGroup');
        const roomNumberInput = document.getElementById('roomNumber');
        
        if (this.checked) {
          roomNumberGroup.style.display = 'none';
          roomNumberInput.required = false;
          roomNumberInput.value = '';
        } else {
          roomNumberGroup.style.display = 'block';
          roomNumberInput.required = true;
        }
      });
      
      // Load initial documents
      await loadDocuments();
    }

    async function handleDocumentUpload(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const title = formData.get('title');
      const file = formData.get('file');
      const isShared = formData.get('isShared') === 'on';
      const roomNumber = formData.get('roomNumber');
      
      // Validation
      if (!title || !file) {
        showNotification('Please fill in all required fields.', 'error');
        return;
      }
      
      if (!isShared && !roomNumber) {
        showNotification('Room number is required for personal documents.', 'error');
        return;
      }
      
      const uploadBtn = document.getElementById('uploadDocumentBtn');
      const originalText = uploadBtn.textContent;
      uploadBtn.textContent = 'Uploading...';
      uploadBtn.disabled = true;
      
      try {
        console.log('📤 Uploading document:', title);
        
        // Generate unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
        
        // Upload file to Supabase Storage
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('documents')
          .upload(fileName, file);
          
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: { publicUrl } } = supabase.storage
          .from('documents')
          .getPublicUrl(fileName);
        
        // Save document metadata to database
        const documentData = {
          title: title,
          file_url: publicUrl,
          is_global: isShared,
          room_number: isShared ? null : roomNumber,
          file_size: file.size,
          file_type: file.type || 'application/octet-stream'
        };
        
        const { data: docData, error: docError } = await supabase
          .from('documents')
          .insert([documentData])
          .select();
          
        if (docError) throw docError;
        
        showNotification('Document uploaded successfully!', 'success');
        
        // Reset form
        document.getElementById('documentUploadForm').reset();
        document.getElementById('roomNumberGroup').style.display = 'block';
        document.getElementById('roomNumber').required = true;
        
        // Refresh documents list
        await loadDocuments();
        
      } catch (error) {
        console.error('❌ Error uploading document:', error);
        showNotification(`Error uploading document: ${error.message}`, 'error');
      } finally {
        uploadBtn.textContent = originalText;
        uploadBtn.disabled = false;
      }
    }

    async function loadDocuments() {
      try {
        console.log('📄 Loading documents...');
        
        const { data: documents, error } = await supabase
          .from('documents')
          .select('*')
          .order('created_at', { ascending: false });
          
        if (error) throw error;
        
        currentDocuments = documents || [];
        console.log('✅ Documents loaded:', currentDocuments.length);
        
        // Update statistics
        updateDocumentStatistics();
        
        // Update room filters
        updateRoomFilters();
        
        // Render based on current view
        const currentView = getCurrentDocumentView();
        if (currentView === 'grid') {
          renderDocumentsGrid(currentDocuments);
        } else {
          renderDocumentsTable(currentDocuments);
        }
        
      } catch (error) {
        console.error('❌ Error loading documents:', error);
        showDocumentError();
      }
    }

    function renderDocumentsTable(documents) {
      const tbody = document.getElementById('documentsTableBody');
      
      if (documents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">📄</div><p>No documents uploaded yet.</p></td></tr>';
        return;
      }
      
      const documentsHTML = documents.map(doc => {
        const fileSize = formatFileSize(doc.file_size);
        const uploadDate = new Date(doc.created_at).toLocaleDateString();
        const docType = doc.is_global ? 'Shared' : 'Personal';
        const roomDisplay = doc.room_number || '-';
        const category = getCategoryDisplay(doc.category);
        const description = doc.description || '';
        const fileExtension = getFileExtension(doc.file_url);
        
        return `
          <tr data-document-id="${doc.id}">
            <td>
              <input type="checkbox" class="document-checkbox" value="${doc.id}" onchange="updateDocumentSelection()">
            </td>
            <td>
              <span style="font-size: 24px;">${getDocumentIcon(doc.file_url)}</span>
            </td>
            <td>
              <div class="document-title">${escapeHtml(doc.title)}</div>
              ${description ? `<div class="document-description">${escapeHtml(description)}</div>` : ''}
            </td>
            <td>
              <span class="status-badge ${doc.is_global ? 'status-approved' : 'status-new'}">
                ${docType}
              </span>
              ${category ? `<div class="document-category">${category}</div>` : ''}
            </td>
            <td>${roomDisplay}</td>
            <td>
              <div class="file-info">
                <div class="file-size">${fileSize}</div>
                <div class="file-type">${fileExtension}</div>
              </div>
            </td>
            <td>${uploadDate}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-small btn-view" onclick="previewDocument('${doc.id}')" title="Preview">
                  👁️
                </button>
                <button class="btn-small btn-view" onclick="downloadDocument('${doc.id}')" title="Download">
                  📥
                </button>
                <button class="btn-small btn-edit" onclick="editDocument('${doc.id}')" title="Edit">
                  ✏️
                </button>
                <button class="btn-small btn-delete" onclick="deleteDocument('${doc.id}')" title="Delete">
                  🗑️
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = documentsHTML;
    }

    function getDocumentIcon(fileUrl) {
      const extension = fileUrl.split('.').pop().toLowerCase();
      const iconMap = {
        'pdf': '📄',
        'doc': '📝',
        'docx': '📝',
        'txt': '📃',
        'xls': '📊',
        'xlsx': '📊',
        'ppt': '📺',
        'pptx': '📺',
        'jpg': '🖼️',
        'jpeg': '🖼️',
        'png': '🖼️',
        'gif': '🖼️',
        'zip': '📦',
        'rar': '📦'
      };
      return iconMap[extension] || '📄';
    }

    function formatFileSize(bytes) {
      if (!bytes) return 'Unknown';
      
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }

    async function downloadDocument(documentId) {
      try {
        const document = currentDocuments.find(doc => doc.id === documentId);
        if (!document) {
          throw new Error('Document not found');
        }
        
        // Extract filename from URL
        const urlParts = document.file_url.split('/');
        const fileName = urlParts[urlParts.length - 1];
        
        // Create signed URL
        const { data: { signedUrl } } = await supabase.storage
          .from('documents')
          .createSignedUrl(fileName, 60);
          
        // Open signed URL in a new tab
        window.open(signedUrl, '_blank');
        
      } catch (error) {
        console.error('❌ Error downloading document:', error);
        showNotification(`Error downloading document: ${error.message}`, 'error');
      }
    }

    async function deleteDocument(documentId, skipConfirmation = false) {
      if (!skipConfirmation && !confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
        return;
      }
      
      try {
        console.log('🗑️ Deleting document:', documentId);
        
        // Find the document to get file path
        const document = currentDocuments.find(doc => doc.id === documentId);
        if (!document) {
          throw new Error('Document not found');
        }
        
        // Extract filename from URL
        const urlParts = document.file_url.split('/');
        const fileName = urlParts[urlParts.length - 1];
        
        // Delete from storage first
        const { error: storageError } = await supabase.storage
          .from('documents')
          .remove([fileName]);
          
        if (storageError) {
          console.warn('Storage deletion failed:', storageError);
          // Continue with database deletion even if storage fails
        }
        
        // Delete from database
        const { error: dbError } = await supabase
          .from('documents')
          .delete()
          .eq('id', documentId);
          
        if (dbError) throw dbError;
        
        showNotification('Document deleted successfully!', 'success');
        await loadDocuments();
        
      } catch (error) {
        console.error('❌ Error deleting document:', error);
        showNotification(`Error deleting document: ${error.message}`, 'error');
      }
    }

    function showDocumentError() {
      document.getElementById('documentsTableBody').innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">⚠️</div><p>Error loading documents. Please refresh the page.</p></td></tr>';
    }

    function refreshDocuments() {
      loadDocuments();
    }

    function filterDocuments() {
      const filteredDocuments = getFilteredDocuments();
      
      // Render based on current view
      if (currentDocumentView === 'grid') {
        renderDocumentsGrid(filteredDocuments);
      } else {
        renderDocumentsTable(filteredDocuments);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===============================
    // ENHANCED DOCUMENT FUNCTIONS
    // ===============================

    let selectedDocuments = new Set();
    let currentDocumentView = 'table';
    let availableRooms = []; // Store available rooms for filtering

    // Document Statistics
    function updateDocumentStatistics() {
      const totalDocs = currentDocuments.length;
      const sharedDocs = currentDocuments.filter(doc => doc.is_global).length;
      const personalDocs = currentDocuments.filter(doc => !doc.is_global).length;
      const totalSize = currentDocuments.reduce((sum, doc) => sum + (doc.file_size || 0), 0);
      const roomsWithDocs = new Set(currentDocuments.filter(doc => doc.room_number).map(doc => doc.room_number)).size;

      document.getElementById('totalDocumentsCount').textContent = totalDocs;
      document.getElementById('sharedDocumentsCount').textContent = sharedDocs;
      document.getElementById('personalDocumentsCount').textContent = personalDocs;
      document.getElementById('totalStorageUsed').textContent = formatFileSize(totalSize);
      document.getElementById('roomsWithDocuments').textContent = roomsWithDocs;
    }

    function showDocumentStats() {
      const statsContainer = document.getElementById('documentStatsCards');
      const isVisible = statsContainer.style.display !== 'none';
      statsContainer.style.display = isVisible ? 'none' : 'block';
    }

    // Room Management Functions
    function generateRoomNumbers(maxRooms = 25) {
      // Generate room numbers from 1 to 25 only
      const rooms = [];
      for (let i = 1; i <= maxRooms; i++) {
        rooms.push(i.toString());
      }
      
      return rooms.sort((a, b) => {
        // Simple numeric sort since all rooms are numbers
        return parseInt(a) - parseInt(b);
      });
    }

    function populateRoomDropdowns() {
      const allRooms = generateRoomNumbers();
      
      // Populate document upload form dropdown
      const uploadRoomSelect = document.getElementById('roomNumber');
      if (uploadRoomSelect) {
        // Clear existing options except the first one
        uploadRoomSelect.innerHTML = '<option value="">Select Room Number</option>';
        
        allRooms.forEach(room => {
          const option = document.createElement('option');
          option.value = room;
          option.textContent = `Room ${room}`;
          uploadRoomSelect.appendChild(option);
        });
      }
      
      // Populate student registration form dropdown
      const studentRoomSelect = document.getElementById('studentRoom');
      if (studentRoomSelect) {
        // Clear existing options except the first one
        studentRoomSelect.innerHTML = '<option value="">Select Room Number</option>';
        
        allRooms.forEach(room => {
          const option = document.createElement('option');
          option.value = room;
          option.textContent = `Room ${room}`;
          studentRoomSelect.appendChild(option);
        });
      }
    }

    function updateRoomFilters() {
      // Get unique room numbers from current documents
      const documentRooms = [...new Set(
        currentDocuments
          .filter(doc => doc.room_number)
          .map(doc => doc.room_number)
      )].sort((a, b) => {
        // Simple numeric sort for rooms 1-25
        return parseInt(a) - parseInt(b);
      });

      availableRooms = documentRooms;

      // Update room filter dropdown
      const roomFilterSelect = document.getElementById('documentRoomFilter');
      if (roomFilterSelect) {
        // Store current selection
        const currentSelection = roomFilterSelect.value;
        
        // Clear existing options except the first one
        roomFilterSelect.innerHTML = '<option value="">🏠 All Rooms</option>';
        
        documentRooms.forEach(room => {
          const option = document.createElement('option');
          option.value = room;
          const docCount = currentDocuments.filter(doc => doc.room_number === room).length;
          option.textContent = `🏠 Room ${room} (${docCount} doc${docCount !== 1 ? 's' : ''})`;
          roomFilterSelect.appendChild(option);
        });
        
        // Restore selection if it still exists
        if (currentSelection && documentRooms.includes(currentSelection)) {
          roomFilterSelect.value = currentSelection;
        }
      }
    }

    // Upload Form Functions
    function toggleUploadForm() {
      const container = document.getElementById('uploadFormContainer');
      const icon = document.getElementById('uploadToggleIcon');
      const isVisible = container.style.display !== 'none';
      
      container.style.display = isVisible ? 'none' : 'block';
      icon.textContent = isVisible ? '▶' : '▼';
    }

    function handleFileSelect(input) {
      const file = input.files[0];
      const nameDisplay = document.getElementById('fileNameDisplay');
      const sizeDisplay = document.getElementById('fileSizeDisplay');
      
      if (file) {
        nameDisplay.textContent = file.name;
        sizeDisplay.textContent = formatFileSize(file.size);
      } else {
        nameDisplay.textContent = 'No file selected';
        sizeDisplay.textContent = '';
      }
    }

    function clearUploadForm() {
      document.getElementById('documentUploadForm').reset();
      document.getElementById('fileNameDisplay').textContent = 'No file selected';
      document.getElementById('fileSizeDisplay').textContent = '';
      document.getElementById('roomNumberGroup').style.display = 'none';
    }

    // Document Type Selection and Room Initialization
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize room dropdowns
      populateRoomDropdowns();
      
      // Set up document type radio button handling
      const radioButtons = document.querySelectorAll('input[name="documentType"]');
      const roomNumberGroup = document.getElementById('roomNumberGroup');
      
      radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'personal') {
            roomNumberGroup.style.display = 'block';
          } else {
            roomNumberGroup.style.display = 'none';
          }
        });
      });
    });

    // View Functions
    function getCurrentDocumentView() {
      return currentDocumentView;
    }

    function setDocumentView(view) {
      currentDocumentView = view;
      
      // Update view buttons
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === view) {
          btn.classList.add('active');
        }
      });
      
      // Show/hide appropriate view
      const tableView = document.getElementById('documentTableView');
      const gridView = document.getElementById('documentGridView');
      
      if (view === 'grid') {
        tableView.style.display = 'none';
        gridView.style.display = 'block';
        renderDocumentsGrid(getFilteredDocuments());
      } else {
        tableView.style.display = 'block';
        gridView.style.display = 'none';
        renderDocumentsTable(getFilteredDocuments());
      }
    }

    // Grid View Rendering
    function renderDocumentsGrid(documents) {
      const gridBody = document.getElementById('documentsGridBody');
      
      if (documents.length === 0) {
        gridBody.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📄</div><p>No documents found.</p></div>';
        return;
      }
      
      const documentsHTML = documents.map(doc => {
        const fileSize = formatFileSize(doc.file_size);
        const uploadDate = new Date(doc.created_at).toLocaleDateString();
        const docType = doc.is_global ? 'Shared' : 'Personal';
        const category = getCategoryDisplay(doc.category);
        const description = doc.description || 'No description available';
        const isSelected = selectedDocuments.has(doc.id);
        
        return `
          <div class="document-grid-item ${isSelected ? 'selected' : ''}" data-document-id="${doc.id}">
            <div class="grid-item-header">
              <div class="grid-item-icon">${getDocumentIcon(doc.file_url)}</div>
              <div class="grid-item-title">${escapeHtml(doc.title)}</div>
              <input type="checkbox" class="document-checkbox" value="${doc.id}" 
                     ${isSelected ? 'checked' : ''} onchange="updateDocumentSelection()">
            </div>
            <div class="grid-item-meta">
              <div class="status-badge ${doc.is_global ? 'status-approved' : 'status-new'}">${docType}</div>
              ${category ? `<div class="document-category">${category}</div>` : ''}
              <div class="grid-item-description">${escapeHtml(description)}</div>
            </div>
            <div class="grid-item-footer">
              <div>
                <div style="font-size: 12px; color: #7f8c8d;">${fileSize} • ${uploadDate}</div>
                ${doc.room_number ? `<div style="font-size: 12px; color: #7f8c8d;">Room: ${doc.room_number}</div>` : ''}
              </div>
              <div class="action-buttons">
                <button class="btn-small btn-view" onclick="previewDocument('${doc.id}')" title="Preview">👁️</button>
                <button class="btn-small btn-view" onclick="downloadDocument('${doc.id}')" title="Download">📥</button>
                <button class="btn-small btn-delete" onclick="deleteDocument('${doc.id}')" title="Delete">🗑️</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      gridBody.innerHTML = documentsHTML;
    }

    // Helper Functions
    function getCategoryDisplay(category) {
      const categoryMap = {
        'contracts': '📄 Contracts',
        'policies': '📋 Policies',
        'forms': '📝 Forms',
        'notices': '📢 Notices',
        'receipts': '🧾 Receipts',
        'maintenance': '🔧 Maintenance',
        'other': '📂 Other'
      };
      return categoryMap[category] || '';
    }

    function getFileExtension(fileUrl) {
      return fileUrl.split('.').pop().toUpperCase();
    }

    // Enhanced Filtering
    function getFilteredDocuments() {
      const searchTerm = document.getElementById('documentSearchInput').value.toLowerCase();
      const typeFilter = document.getElementById('documentTypeFilter').value;
      const categoryFilter = document.getElementById('documentCategoryFilter').value;
      const roomFilter = document.getElementById('documentRoomFilter').value;
      const sortFilter = document.getElementById('documentSortFilter').value;
      
      let filteredDocuments = [...currentDocuments];
      
      // Apply search filter
      if (searchTerm) {
        filteredDocuments = filteredDocuments.filter(doc => 
          doc.title.toLowerCase().includes(searchTerm) ||
          (doc.description && doc.description.toLowerCase().includes(searchTerm)) ||
          (doc.room_number && doc.room_number.toLowerCase().includes(searchTerm))
        );
      }
      
      // Apply type filter
      if (typeFilter) {
        if (typeFilter === 'shared') {
          filteredDocuments = filteredDocuments.filter(doc => doc.is_global);
        } else if (typeFilter === 'personal') {
          filteredDocuments = filteredDocuments.filter(doc => !doc.is_global);
        }
      }
      
      // Apply category filter
      if (categoryFilter) {
        filteredDocuments = filteredDocuments.filter(doc => doc.category === categoryFilter);
      }
      
      // Apply room filter
      if (roomFilter) {
        filteredDocuments = filteredDocuments.filter(doc => doc.room_number === roomFilter);
      }
      
      // Apply sorting
      filteredDocuments.sort((a, b) => {
        switch (sortFilter) {
          case 'oldest':
            return new Date(a.created_at) - new Date(b.created_at);
          case 'title':
            return a.title.localeCompare(b.title);
          case 'size':
            return (b.file_size || 0) - (a.file_size || 0);
          default: // newest
            return new Date(b.created_at) - new Date(a.created_at);
        }
      });
      
      return filteredDocuments;
    }

    // Search Functions
    function clearDocumentSearch() {
      document.getElementById('documentSearchInput').value = '';
      document.querySelector('.search-clear-btn').style.display = 'none';
      filterDocuments();
    }

    // Update search clear button visibility
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('documentSearchInput');
      const clearBtn = document.querySelector('.search-clear-btn');
      
      if (searchInput && clearBtn) {
        searchInput.addEventListener('input', function() {
          clearBtn.style.display = this.value ? 'block' : 'none';
        });
      }
    });

    // Selection Functions
    function updateDocumentSelection() {
      const checkboxes = document.querySelectorAll('.document-checkbox');
      const checkedBoxes = document.querySelectorAll('.document-checkbox:checked');
      
      // Update selected documents set
      selectedDocuments.clear();
      checkedBoxes.forEach(cb => selectedDocuments.add(cb.value));
      
      // Update bulk actions bar
      const bulkBar = document.getElementById('bulkActionsBar');
      const countSpan = document.getElementById('selectedDocumentsCount');
      
      if (selectedDocuments.size > 0) {
        bulkBar.style.display = 'block';
        countSpan.textContent = `${selectedDocuments.size} document${selectedDocuments.size > 1 ? 's' : ''} selected`;
      } else {
        bulkBar.style.display = 'none';
      }
      
      // Update select all checkbox
      const selectAllCheckbox = document.getElementById('selectAllDocuments');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = checkedBoxes.length === checkboxes.length && checkboxes.length > 0;
        selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < checkboxes.length;
      }
    }

    function toggleAllDocumentSelection() {
      const selectAllCheckbox = document.getElementById('selectAllDocuments');
      const checkboxes = document.querySelectorAll('.document-checkbox');
      
      checkboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
      });
      
      updateDocumentSelection();
    }

    function clearDocumentSelection() {
      selectedDocuments.clear();
      document.querySelectorAll('.document-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('selectAllDocuments').checked = false;
      updateDocumentSelection();
    }

    function toggleDocumentSelection() {
      const checkboxes = document.querySelectorAll('.document-checkbox');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      
      checkboxes.forEach(cb => {
        cb.checked = !allChecked;
      });
      
      updateDocumentSelection();
    }

    // Document Actions
    function previewDocument(documentId) {
      // For now, just download - can be enhanced with modal preview
      downloadDocument(documentId);
    }

    function editDocument(documentId) {
      const document = currentDocuments.find(doc => doc.id === documentId);
      if (!document) return;
      
      // Pre-fill form with document data
      document.getElementById('documentTitle').value = document.title;
      document.getElementById('documentDescription').value = document.description || '';
      document.getElementById('documentCategory').value = document.category || '';
      
      if (document.is_global) {
        document.getElementById('sharedDocumentRadio').checked = true;
        document.getElementById('roomNumberGroup').style.display = 'none';
      } else {
        document.getElementById('personalDocumentRadio').checked = true;
        
        // Show room number group and set value
        document.getElementById('roomNumberGroup').style.display = 'block';
        const roomSelect = document.getElementById('roomNumber');
        if (roomSelect && document.room_number) {
          roomSelect.value = document.room_number;
        }
      }
      
      // Scroll to form
      document.getElementById('uploadFormContainer').scrollIntoView({ behavior: 'smooth' });
      
      showNotification('Document details loaded for editing. Update the form and upload to replace.', 'info');
    }

    // Bulk Actions
    function downloadSelectedDocuments() {
      if (selectedDocuments.size === 0) return;
      
      selectedDocuments.forEach(docId => {
        setTimeout(() => downloadDocument(docId), 100);
      });
    }

    function deleteSelectedDocuments() {
      if (selectedDocuments.size === 0) return;
      
      const count = selectedDocuments.size;
      if (!confirm(`Are you sure you want to delete ${count} selected document${count > 1 ? 's' : ''}? This action cannot be undone.`)) {
        return;
      }
      
      selectedDocuments.forEach(docId => {
        deleteDocument(docId, true); // true = skip individual confirmation
      });
      
      clearDocumentSelection();
    }

    function exportDocumentsList() {
      const filteredDocs = getFilteredDocuments();
      const csvContent = generateDocumentsCSV(filteredDocs);
      downloadCSV(csvContent, 'documents-list.csv');
    }

    function generateDocumentsCSV(documents) {
      const headers = ['Title', 'Description', 'Type', 'Category', 'Room Number', 'File Size', 'Upload Date'];
      const rows = documents.map(doc => [
        doc.title,
        doc.description || '',
        doc.is_global ? 'Shared' : 'Personal',
        doc.category || '',
        doc.room_number || '',
        formatFileSize(doc.file_size),
        new Date(doc.created_at).toLocaleDateString()
      ]);
      
      return [headers, ...rows].map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
      ).join('\n');
    }

    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // ===============================
    // STUDENT MANAGEMENT FUNCTIONS
    // ===============================

    async function registerStudent(event) {
      event.preventDefault();
      
      const name = document.getElementById('studentName').value.trim();
      const email = document.getElementById('studentEmail').value.trim();
      const roomNumber = document.getElementById('studentRoom').value.trim();
      const password = document.getElementById('tempPassword').value;
      
      if (!name || !email || !roomNumber || !password) {
        showNotification('Please fill in all required fields.', 'error');
        return;
      }
      
      if (password.length < 6) {
        showNotification('Password must be at least 6 characters long.', 'error');
        return;
      }
      
      const registerBtn = document.getElementById('registerStudentBtn');
      const originalText = registerBtn.textContent;
      registerBtn.textContent = 'Registering...';
      registerBtn.disabled = true;
      
      try {
        console.log('👤 Registering new student:', email);
        
        // Step 1: Create auth user in Supabase using regular signup
        const { data: authData, error: authError } = await supabase.auth.signUp({
          email: email,
          password: password,
          options: {
            data: {
              role: 'student',
              name: name,
              room_number: roomNumber
            }
          }
        });
        
        if (authError) throw authError;
        
        if (!authData.user) {
          throw new Error('Failed to create user account');
        }
        
        // Step 2: Insert student record in students table
        const { data: studentData, error: studentError } = await supabase
          .from('students')
          .insert([{
            id: authData.user.id,
            email: email,
            name: name,
            room_number: roomNumber,
            created_at: new Date().toISOString()
          }]);
          
        if (studentError) throw studentError;
        
        showNotification(`Student ${name} registered successfully! They can now log into the student portal.`, 'success');
        
        // Reset form
        document.getElementById('studentRegistrationForm').reset();
        
        // Refresh students list
        await loadStudents();
        
      } catch (error) {
        console.error('❌ Error registering student:', error);
        showNotification(`Error registering student: ${error.message}`, 'error');
      } finally {
        registerBtn.textContent = originalText;
        registerBtn.disabled = false;
      }
    }

    async function loadStudents() {
      try {
        console.log('👥 Loading students from database...');
        
        const { data: students, error } = await supabase
          .from('students')
          .select('*')
          .order('created_at', { ascending: false });
          
        if (error) throw error;
        
        console.log(`✅ Loaded ${students.length} students`);
        renderStudentsTable(students);
        populateRoomFilter(students);
        
        // Initialize count badge
        updateStudentCountBadge(students.length, students.length);
        
      } catch (error) {
        console.error('❌ Error loading students:', error);
        showStudentsError();
      }
    }

    function renderStudentsTable(students) {
      const container = document.getElementById('studentsTableContainer');
      
      if (students.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">👥</div>
            <p>No students registered yet.</p>
          </div>
        `;
        return;
      }
      
      const tableHTML = `
        <table class="applications-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Room Number</th>
              <th>Registered</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${students.map(student => `
              <tr data-student-name="${escapeHtml(student.name.toLowerCase())}" 
                  data-student-email="${escapeHtml(student.email.toLowerCase())}" 
                  data-student-room="${escapeHtml(student.room_number)}">
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="student-avatar" style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                      ${student.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                    </div>
                    <span>${escapeHtml(student.name)}</span>
                  </div>
                </td>
                <td>${escapeHtml(student.email)}</td>
                <td>
                  <span class="status-badge status-approved" style="background: #e8f5e8; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    ${escapeHtml(student.room_number)}
                  </span>
                </td>
                <td>${formatDate(student.created_at)}</td>
                <td>
                  <div class="action-buttons">
                    <button class="btn-small btn-edit" onclick="editStudent('${student.id}')" title="Edit Student">
                      ✏️
                    </button>
                    <button class="btn-small btn-warning" onclick="resetStudentPassword('${student.id}')" title="Reset Password">
                      🔑
                    </button>
                    <button class="btn-small btn-delete" onclick="deleteStudent('${student.id}')" title="Remove Student">
                      🗑️
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = tableHTML;
    }

    function generateRandomPassword() {
      const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
      let password = '';
      for (let i = 0; i < 8; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('tempPassword').value = password;
      
      // Show password temporarily
      const tempField = document.getElementById('tempPassword');
      tempField.type = 'text';
      setTimeout(() => {
        tempField.type = 'password';
      }, 3000);
      
      showNotification('Random password generated and will be hidden in 3 seconds.', 'info');
    }

    async function resetStudentPassword(studentId) {
      // Find the student's email
      const { data: student, error: studentError } = await supabase
        .from('students')
        .select('email, name')
        .eq('id', studentId)
        .single();
        
      if (studentError) {
        showNotification('Error finding student.', 'error');
        return;
      }
      
      if (!confirm(`Send password reset email to ${student.name} (${student.email})?`)) {
        return;
      }
      
      try {
        const { error } = await supabase.auth.resetPasswordForEmail(student.email, {
          redirectTo: `${window.location.origin}/student-portal.html`
        });
        
        if (error) throw error;
        
        showNotification(`Password reset email sent to ${student.email}`, 'success');
        
      } catch (error) {
        console.error('❌ Error sending reset email:', error);
        showNotification(`Error sending reset email: ${error.message}`, 'error');
      }
    }

    async function editStudent(studentId) {
      // Find the student
      const { data: student, error } = await supabase
        .from('students')
        .select('*')
        .eq('id', studentId)
        .single();
        
      if (error) {
        showNotification('Error loading student data.', 'error');
        return;
      }
      
      const newName = prompt('Enter new name:', student.name);
      if (!newName) return;
      
      // Create a simple room selection dialog
      const allRooms = generateRoomNumbers();
      const roomOptions = allRooms.map(room => 
        `<option value="${room}" ${room === student.room_number ? 'selected' : ''}>Room ${room}</option>`
      ).join('');
      
      const roomSelectHTML = `
        <div style="font-family: Arial, sans-serif; padding: 20px;">
          <p><strong>Select new room for ${student.name}:</strong></p>
          <select id="editRoomSelect" style="width: 200px; padding: 8px; font-size: 14px;">
            ${roomOptions}
          </select>
          <br><br>
          <button onclick="confirmRoomEdit('${studentId}', '${newName}')" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Update</button>
          <button onclick="closeRoomEditDialog()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 8px;">Cancel</button>
        </div>
      `;
      
      // Create and show dialog
      const dialog = document.createElement('div');
      dialog.id = 'roomEditDialog';
      dialog.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000;
      `;
      dialog.innerHTML = roomSelectHTML;
      
      const overlay = document.createElement('div');
      overlay.id = 'roomEditOverlay';
      overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 9999;
      `;
      
      document.body.appendChild(overlay);
      document.body.appendChild(dialog);
    }
    
    async function confirmRoomEdit(studentId, newName) {
      const newRoom = document.getElementById('editRoomSelect').value;
      
      try {
        const { error } = await supabase
          .from('students')
          .update({
            name: newName,
            room_number: newRoom
          })
          .eq('id', studentId);
          
        if (error) throw error;
        
        showNotification('Student updated successfully.', 'success');
        await loadStudents();
        closeRoomEditDialog();
        
      } catch (error) {
        console.error('❌ Error updating student:', error);
        showNotification(`Error updating student: ${error.message}`, 'error');
      }
    }
    
    function closeRoomEditDialog() {
      const dialog = document.getElementById('roomEditDialog');
      const overlay = document.getElementById('roomEditOverlay');
      if (dialog) dialog.remove();
      if (overlay) overlay.remove();
    }

    async function deleteStudent(studentId) {
      if (!confirm('Are you sure you want to remove this student? This action cannot be undone.')) {
        return;
      }
      
      try {
        console.log('🗑️ Deleting student using database function:', studentId);
        
        // Get current user to pass admin email for authorization
        const { data: { user } } = await supabase.auth.getUser();
        const adminEmail = user ? user.email : null;
        
        // Call the database function for complete student deletion
        const { data: result, error } = await supabase.rpc('delete_student_complete', {
          student_id: studentId,
          admin_email: adminEmail
        });
        
        if (error) {
          console.error('❌ Error calling delete function:', error);
          throw error;
        }
        
        // Check if the function returned an error
        if (!result.success) {
          console.error('❌ Database function returned error:', result.error);
          throw new Error(result.error);
        }
        
        console.log('✅ Student deletion completed:', result);
        
        // Show detailed success message
        const studentInfo = result.deleted_student;
        const actions = result.actions_completed;
        
        showNotification(
          `✅ ${studentInfo.name} successfully removed from all systems!\n` +
          `📧 Email: ${studentInfo.email}\n` +
          `🏠 Room: ${studentInfo.room_number}\n` +
          `🔧 Actions: ${actions.join(', ')}`, 
          'success'
        );
        
        // Refresh the students list
        await loadStudents();
        
      } catch (error) {
        console.error('❌ Error deleting student:', error);
        
        // Show user-friendly error message
        let errorMessage = 'Failed to remove student from system.';
        
        if (error.message.includes('UNAUTHORIZED')) {
          errorMessage = 'You are not authorized to delete students.';
        } else if (error.message.includes('STUDENT_NOT_FOUND')) {
          errorMessage = 'Student not found in database.';
        } else if (error.message.includes('DELETION_FAILED')) {
          errorMessage = 'Student deletion failed. Please try again or contact support.';
        } else {
          errorMessage = `Error removing student: ${error.message}`;
        }
        
        showNotification(errorMessage, 'error');
      }
    }

    // Function to test student deletion (for debugging)
    async function testStudentDeletion(studentId) {
      try {
        console.log('🔍 Testing student deletion plan for:', studentId);
        
        const { data: result, error } = await supabase.rpc('test_student_deletion', {
          student_id: studentId
        });
        
        if (error) {
          console.error('❌ Error testing deletion:', error);
          return;
        }
        
        console.log('📋 Deletion test result:', result);
        
        if (result.student_exists) {
          console.log('👤 Student Info:', result.student_info);
          console.log('📄 Room Documents:', result.room_documents_count);
          console.log('🔐 Auth User Exists:', result.auth_user_exists);
          console.log('📝 Deletion Plan:', result.deletion_plan);
        } else {
          console.log('❌ Student not found');
        }
        
        return result;
        
      } catch (error) {
        console.error('❌ Error testing student deletion:', error);
      }
    }

    function filterStudents() {
      const searchTerm = document.getElementById('studentSearchInput').value.toLowerCase();
      const roomFilter = document.getElementById('roomFilter').value;
      
      const rows = document.querySelectorAll('#studentsTableContainer tbody tr[data-student-name]');
      
      if (rows.length === 0) {
        console.log('No student rows found for filtering');
        return;
      }
      
      let shownCount = 0;
      
      rows.forEach(row => {
        // Use data attributes for reliable filtering
        const studentName = row.getAttribute('data-student-name') || '';
        const studentEmail = row.getAttribute('data-student-email') || '';
        const studentRoom = row.getAttribute('data-student-room') || '';
        
        const matchesSearch = !searchTerm || 
          studentName.includes(searchTerm) || 
          studentEmail.includes(searchTerm);
        
        const matchesRoom = !roomFilter || studentRoom === roomFilter;
        
        const shouldShow = matchesSearch && matchesRoom;
        row.style.display = shouldShow ? '' : 'none';
        
        if (shouldShow) shownCount++;
      });
      
      // Update count badge
      updateStudentCountBadge(shownCount, rows.length);
      
      console.log(`🔍 Student filter applied: Showing ${shownCount} of ${rows.length} students`);
    }

    function updateStudentCountBadge(shown, total) {
      const badge = document.getElementById('studentCountBadge');
      if (!badge) return;
      
      if (shown === total) {
        badge.style.display = 'none';
      } else {
        badge.textContent = `(${shown}/${total})`;
        badge.style.display = 'inline';
        badge.style.background = '#e3f2fd';
        badge.style.color = '#1976d2';
        badge.style.padding = '2px 8px';
        badge.style.borderRadius = '12px';
        badge.style.fontSize = '12px';
        badge.style.marginLeft = '8px';
      }
    }

    function clearStudentFilters() {
      document.getElementById('studentSearchInput').value = '';
      document.getElementById('roomFilter').value = '';
      filterStudents();
      showNotification('Student filters cleared', 'info');
    }

    function populateRoomFilter(students) {
      const roomFilter = document.getElementById('roomFilter');
      const rooms = [...new Set(students.map(s => s.room_number))]
        .sort((a, b) => {
          // Simple numeric sort for rooms 1-25
          return parseInt(a) - parseInt(b);
        });
      
      roomFilter.innerHTML = '<option value="">All Rooms</option>';
      rooms.forEach(room => {
        // Store just the room number as value, but display with "Room" prefix
        roomFilter.innerHTML += `<option value="${room}">Room ${room}</option>`;
      });
    }

    function refreshStudents() {
      loadStudents();
    }

    function showStudentsError() {
      document.getElementById('studentsTableContainer').innerHTML = `
        <div class="error-state">
          <div class="empty-state-icon">⚠️</div>
          <p>Error loading students. Please try again.</p>
          <button class="btn btn-outline" onclick="loadStudents()">Retry</button>
        </div>
      `;
    }

    // Initialize student management
    async function initializeStudentManagement() {
      // Set up form submission
      if (document.getElementById('studentRegistrationForm')) {
        document.getElementById('studentRegistrationForm').addEventListener('submit', registerStudent);
      }
    }

    // Initialize document management when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Add initialization after existing DOMContentLoaded code
      setTimeout(() => {
        initializeDocumentManagement();
        
        // Initialize student management
        initializeStudentManagement();
      }, 1000);
    });
  </script>
</body>
</html> 