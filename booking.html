<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Cache Control Meta Tags -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="cache-version" content="v2024-01-15">
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Secure your student accommodation in Dundee. Book premium halal student housing at iLm Student Halls near University of Dundee and Abertay University. Complete student accommodation booking form online for Rose House student rooms.">
  <meta name="keywords" content="book student accommodation Dundee, student housing booking Dundee, secure student room Dundee, iLm student halls booking, halal student accommodation booking, University of Dundee housing booking, Abertay University accommodation booking, student accommodation application form, Rose House booking, PBSA Dundee booking, purpose built student accommodation booking, Dundee student housing application, student accommodation near University of Dundee booking, book halal student housing, online student accommodation booking form, student room reservation Dundee, apply student housing Dundee, student accommodation online application, Dundee student halls booking, book university accommodation Dundee, student housing application form, reserve student room Dundee, student accommodation booking system, Dundee student housing reservation, book student flat Dundee, student accommodation enquiry form, university housing application Dundee, student halls application form, book accommodation near University of Dundee, student housing near Abertay booking, Dundee student accommodation booking, student room booking online, accommodation booking Dundee students, book student residence Dundee, student housing booking form, apply for student accommodation Dundee, student accommodation booking process, book student lodging Dundee, university student housing booking, student accommodation application online, book student housing near university, Dundee accommodation booking students, student housing reservation system, book accommodation University of Dundee, student halls booking form, accommodation application Dundee, book student rooms near Abertay, student housing booking online, Dundee student residence booking">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://ilm-studenthalls.com/booking.html">
  
  <!-- Additional SEO Meta Tags -->
  <meta name="subject" content="Student Accommodation Booking Dundee - University Housing Application Form">
  <meta name="topic" content="Book Student Housing Dundee - Student Accommodation Reservation">
  <meta name="summary" content="Complete online booking form for student accommodation Dundee. Secure your student housing near University of Dundee and Abertay University. Apply for halal student accommodation at Rose House with modern facilities and competitive rates.">
  <meta name="classification" content="Student Accommodation Booking, University Housing Application, Student Housing Reservation">
  <meta name="target" content="University Students, Student Accommodation Seekers, International Students">
  <meta name="audience" content="Students seeking accommodation booking in Dundee">
  <meta name="coverage" content="Dundee, Scotland, UK, University of Dundee, Abertay University">
  <meta name="distribution" content="Global">
  <meta name="rating" content="General">
  <meta name="revisit-after" content="7 days">
  <meta name="language" content="English">
  <meta name="content-language" content="en-GB">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Book Student Accommodation Dundee - iLm Halal Student Halls">
  <meta property="og:description" content="Secure your student accommodation in Dundee. Book premium halal student housing at iLm Student Halls near University of Dundee and Abertay University.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://ilm-studenthalls.com/booking.html">
  <meta property="og:image" content="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189839/473148050_10160452160655951_3047339032063400229_n_gnkdpz.jpg">
  <meta property="og:image:alt" content="iLm Halal Student Halls - Book Student Accommodation Dundee">
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Book Student Accommodation Dundee - iLm Halal Student Halls">
  <meta name="twitter:description" content="Secure your student accommodation in Dundee. Book premium halal student housing at iLm Student Halls near University of Dundee and Abertay University.">
  <meta name="twitter:image" content="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189839/473148050_10160452160655951_3047339032063400229_n_gnkdpz.jpg">
  
  <!-- Geographic and Local SEO Meta Tags -->
  <meta name="geo.region" content="GB-DND">
  <meta name="geo.placename" content="Dundee">
  <meta name="geo.position" content="56.462;-2.9707">
  <meta name="ICBM" content="56.462, -2.9707">
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://ilm-studenthalls.com/booking.html">
  
  <!-- hreflang attributes -->
  <link rel="alternate" hreflang="en-gb" href="https://ilm-studenthalls.com/booking.html">
  <link rel="alternate" hreflang="en" href="https://ilm-studenthalls.com/booking.html">
  
  <title>Book Your Room - iLm Halal Student Halls Dundee</title>
  
  <!-- Structured Data for Booking Page -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Student Accommodation Booking Form - iLm Halal Student Halls",
    "description": "Complete online booking form for student accommodation in Dundee. Secure your student housing near University of Dundee and Abertay University.",
    "url": "https://ilm-studenthalls.com/booking.html",
    "mainEntity": {
      "@type": "Service",
      "name": "Student Accommodation Booking Service",
      "description": "Online booking service for student accommodation in Dundee",
      "provider": {
        "@type": "Organization",
        "name": "iLm Halal Student Halls",
        "url": "https://ilm-studenthalls.com"
      },
      "serviceType": "Student Accommodation Booking",
      "areaServed": {
        "@type": "City",
        "name": "Dundee",
        "addressCountry": "GB"
      },
      "audience": {
        "@type": "Audience",
        "audienceType": "University Students"
      }
    },
    "breadcrumb": {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://ilm-studenthalls.com/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Booking Application",
          "item": "https://ilm-studenthalls.com/booking.html"
        }
      ]
    }
  }
  </script>
  
  <!-- Google reCAPTCHA v2 Invisible -->
  <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>
  
  <link rel="stylesheet" href="styles.css">
  <style>
    .form-help {
      display: block;
      font-size: 12px;
      color: #666;
      margin-top: 4px;
      font-style: italic;
      line-height: 1.3;
    }
  </style>
  <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189942/web-app-manifest-192x192_wr5wdr.png">
  <link rel="icon" type="image/png" sizes="192x192" href="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189942/web-app-manifest-192x192_wr5wdr.png">
  <link rel="apple-touch-icon" sizes="512x512" href="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189944/web-app-manifest-512x512_fpuiis.png">
  <link rel="shortcut icon" href="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189942/web-app-manifest-192x192_wr5wdr.png">
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container header-flex">
      <a href="/" class="logo">
        <span class="logo-icon">
          <img src="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189839/473148050_10160452160655951_3047339032063400229_n_gnkdpz.jpg" alt="iLm Halal Student Halls Logo">
        </span>
        <span class="logo-text">iLm Halal Student Halls</span>
      </a>
      <nav class="desktop-nav">
        <a href="/#about">About</a>
        <a href="/#gallery">Gallery</a>
        <a href="/#amenities">Amenities</a>
        <a href="/#location">Location</a>
        <a href="/#faq">FAQ</a>
        <a href="/#contact">Contact</a>
        <a href="/" class="btn btn-outline">← Back to Home</a>
      </nav>
      
      <!-- Mobile Menu -->
      <input type="checkbox" id="menu" class="menu">
      <nav id="mainNav" class="sidebar-nav">
        <a href="/" class="sidebar-header">
          <span class="logo-icon">
            <img src="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189839/473148050_10160452160655951_3047339032063400229_n_gnkdpz.jpg" alt="iLm Halal Student Halls Logo">
          </span>
          <span class="logo-text">iLm Halal Student Halls</span>
        </a>
        <a href="/#about">About</a>
        <a href="/#gallery">Gallery</a>
        <a href="/#amenities">Amenities</a>
        <a href="/#location">Location</a>
        <a href="/#faq">FAQ</a>
        <a href="/#contact">Contact</a>
        <a href="/" class="btn btn-outline">← Back to Home</a>
      </nav>
      <div id="sidebarOverlay"></div>
    </div>
  </header>

  <!-- Breadcrumb -->
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <div class="container">
      <ol class="breadcrumb-list">
        <li><a href="/">Home</a></li>
        <li class="current">Booking Application</li>
      </ol>
    </div>
  </nav>

  <!-- Booking Form Section -->
  <section class="booking-section">
    <div class="container">
      <div class="booking-header">
        <h1>Complete Your Booking</h1>
        <p>Fill out this comprehensive form to secure your room at iLm Halal Student Halls. All information is required to process your application.</p>
      </div>

      <div class="booking-form-container">
        <form id="bookingForm" action="https://nrnbfevlbakvdeaswbbd.supabase.co/functions/v1/booking-submission" method="POST">
          <!-- Application ID (generated automatically) -->
          <input type="hidden" id="applicationId" name="applicationId">
          <input type="hidden" id="submissionDate" name="submissionDate">
          
          <!-- reCAPTCHA v2 Invisible -->
          <div id="recaptcha-container" 
               class="g-recaptcha" 
               data-sitekey="6Le3cWwrAAAAAJnRkew5cCAM3gSxSMh5abD53t8S" 
               data-callback="onRecaptchaSuccess" 
               data-size="invisible">
          </div>

          <!-- Personal Information -->
          <div class="form-section">
            <h3>Personal Information</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name <span class="required">*</span></label>
                <input type="text" id="firstName" name="firstName" placeholder="Enter your first name" required>
              </div>
              <div class="form-group">
                <label for="middleName">Middle Name</label>
                <input type="text" id="middleName" name="middleName" placeholder="Enter your middle name (optional)">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="lastName">Last Name <span class="required">*</span></label>
                <input type="text" id="lastName" name="lastName" placeholder="Enter your last name" required>
              </div>
              <div class="form-group">
                <label for="dateOfBirth">Date of Birth <span class="required">*</span></label>
                <input type="date" id="dateOfBirth" name="dateOfBirth" placeholder="dd/mm/yyyy" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="gender">Gender <span class="required">*</span></label>
                <select id="gender" name="gender" required>
                  <option value="">Select Gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
              </div>
              <div class="form-group">
                <label for="nationality">Nationality <span class="required">*</span></label>
                <input type="text" id="nationality" name="nationality" placeholder="e.g., British, Pakistani, Nigerian" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="passportNumber">Passport/ID Number</label>
                <input type="text" id="passportNumber" name="passportNumber" placeholder="Enter passport or ID number">
              </div>
              <div class="form-group">
                <!-- Empty div to maintain row structure -->
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="form-section">
            <h3>Contact Information</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="email">Email Address <span class="required">*</span></label>
                <input type="email" id="email" name="email" placeholder="your.email@example.com" required>
              </div>
              <div class="form-group">
                <label for="phone">Phone Number <span class="required">*</span></label>
                <input type="tel" id="phone" name="phone" placeholder="e.g., 07722440395 or +447722440395" required>
                <small class="form-help">UK numbers: 07722440395 or +447722440395 | International: +1234567890</small>
              </div>
            </div>
            
            <div class="form-row">
            <div class="form-group">
                <label for="homeAddress">Home Address <span class="required">*</span></label>
                <textarea id="homeAddress" name="homeAddress" rows="4" placeholder="Enter your full home address including postcode/zip code" required></textarea>
              </div>
              <div class="form-group">
                <!-- Empty div to maintain row structure -->
              </div>
            </div>
          </div>

          <!-- Academic Information -->
          <div class="form-section">
            <h3>Academic Information</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="university">University/Institution *</label>
                <select id="university" name="university" required onchange="toggleOtherUniversity()">
                  <option value="">Select University</option>
                  <option value="abertay">Abertay University</option>
                  <option value="dundee">University of Dundee</option>
                  <option value="al-makhtoum">Al Makhtoum Institute</option>
                  <option value="st-andrews">St Andrews University</option>
                  <option value="dundee-angus-college">Dundee & Angus College</option>
                  <option value="other">Other (please specify)</option>
                </select>
              </div>
              <div class="form-group">
                <label for="otherUniversity" id="otherUniversityLabel" style="display: none;">Please specify university *</label>
                <input type="text" id="otherUniversity" name="otherUniversity" style="display: none;">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="courseOfStudy">Course of Study *</label>
                <input type="text" id="courseOfStudy" name="courseOfStudy" required>
              </div>
              <div class="form-group">
                <label for="studentId">Student ID (if available)</label>
                <input type="text" id="studentId" name="studentId">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="yearOfStudy">Year of Study *</label>
                <select id="yearOfStudy" name="yearOfStudy" required>
                  <option value="">Select Year</option>
                  <option value="1">1st Year</option>
                  <option value="2">2nd Year</option>
                  <option value="3">3rd Year</option>
                  <option value="4">4th Year</option>
                  <option value="5">5th Year</option>
                  <option value="postgraduate">Postgraduate</option>
                </select>
              </div>
              <div class="form-group"></div>
            </div>
          </div>

          <!-- Accommodation Preferences -->
          <div class="form-section">
            <h3>Accommodation Preferences</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="roomType">Room Type & Pricing *</label>
                <select id="roomType" name="roomType" required>
                  <option value="">Select Room Type</option>
                  <option value="single-no-wc">Single Room – no WC (£160/week)</option>
                  <option value="single-with-wc">Single Room – with WC (£165/week)</option>
                  <option value="single-en-suite">Single Room – with en-suite (£190/week)</option>
                  <option value="double-with-wc">Double Room – with WC (£190/week)</option>
                </select>
              </div>
              <div class="form-group">
                <label for="checkInDate">Preferred Check-in Date *</label>
                <input type="date" id="checkInDate" name="checkInDate" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="contractLength">Contract Length *</label>
                <select id="contractLength" name="contractLength" required>
                  <option value="">Select Duration</option>
                  <option value="full-year">Full year (50 weeks)</option>
                  <option value="semester">One Semester</option>
                  <option value="summer">Summer only</option>
                </select>
              </div>
              <div class="form-group"></div>
            </div>
            
            <div class="form-group">
              <label for="roomPreferences">Additional Room Preferences/Special Requirements</label>
              <textarea id="roomPreferences" name="roomPreferences" rows="3" placeholder="Please specify any additional preferences or requirements (e.g., ground floor, quiet area, accessibility needs)"></textarea>
            </div>
            
            <!-- Additional Services -->
            <div class="form-row">
              <div class="form-group">
                <label>Additional Services</label>
                <div class="checkbox-group">
                  <label class="checkbox-label">
                    <input type="checkbox" name="parkingRequired" value="yes">
                    <span class="checkmark"></span>
                    Parking Required (+£20 per week)
                  </label>
                </div>
                <div class="checkbox-group">
                  <label class="checkbox-label">
                    <input type="checkbox" name="bikeStorageRequired" value="yes">
                    <span class="checkmark"></span>
                    Bike Storage Required (included in price)
                  </label>
                </div>
              </div>
              <div class="form-group"></div>
            </div>
          </div>

          <!-- Dietary and Lifestyle Information -->
          <div class="form-section">
            <h3>Lifestyle & Dietary Information</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="dietaryRequirements">Dietary Requirements</label>
                <select id="dietaryRequirements" name="dietaryRequirements">
                  <option value="">Select if applicable</option>
                  <option value="halal">Halal</option>
                  <option value="vegetarian">Vegetarian</option>
                  <option value="vegan">Vegan</option>
                  <option value="gluten-free">Gluten-free</option>
                  <option value="other">Other (please specify in additional info)</option>
                </select>
              </div>
              <div class="form-group">
                <label for="medicalConditions">Medical Conditions/Allergies</label>
                <input type="text" id="medicalConditions" name="medicalConditions" placeholder="Please list any relevant conditions">
              </div>
            </div>
            
            <div class="form-group">
              <label for="additionalInfo">Additional Information</label>
              <textarea id="additionalInfo" name="additionalInfo" rows="4" placeholder="Please provide any additional information that would help us accommodate you better"></textarea>
            </div>
          </div>

          <!-- Reference Information -->
          <div class="form-section">
            <h3>Reference Information</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="referenceName">Reference Name *</label>
                <input type="text" id="referenceName" name="referenceName" required>
              </div>
              <div class="form-group">
                <label for="referenceRelationship">Relationship to Applicant *</label>
                <input type="text" id="referenceRelationship" name="referenceRelationship" placeholder="e.g., Teacher, Employer, Academic Supervisor" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="referenceEmail">Reference Email *</label>
                <input type="email" id="referenceEmail" name="referenceEmail" required>
              </div>
              <div class="form-group">
                <label for="referenceTelephone">Reference Telephone *</label>
                <input type="tel" id="referenceTelephone" name="referenceTelephone" placeholder="e.g., 07722440395 or +447722440395" required>
              </div>
            </div>
          </div>

          <!-- Guarantor Information -->
          <div class="form-section">
            <h3>Guarantor Information</h3>
            
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="provideGuarantorLater" name="provideGuarantorLater" onchange="toggleGuarantorFields()">
                <span class="checkmark"></span>
                I will provide guarantor information at a later date
              </label>
            </div>
            
            <div id="guarantorFields">
              <div class="form-row">
                <div class="form-group">
                  <label for="guarantorName">Guarantor Name *</label>
                  <input type="text" id="guarantorName" name="guarantorName" required>
                </div>
                <div class="form-group">
                  <label for="guarantorRelationship">Relationship to Applicant *</label>
                  <input type="text" id="guarantorRelationship" name="guarantorRelationship" placeholder="e.g., Parent, Guardian, Sponsor" required>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="guarantorEmail">Guarantor Email *</label>
                  <input type="email" id="guarantorEmail" name="guarantorEmail" required>
                </div>
                <div class="form-group">
                  <label for="guarantorTelephone">Guarantor Telephone *</label>
                  <input type="tel" id="guarantorTelephone" name="guarantorTelephone" placeholder="e.g., 07722440395 or +447722440395" required>
                </div>
              </div>
              
              <div class="form-group">
                <label for="guarantorAddress">Guarantor Address *</label>
                <textarea id="guarantorAddress" name="guarantorAddress" rows="3" required></textarea>
              </div>
            </div>
          </div>

          <!-- Emergency Contact -->
          <div class="form-section">
            <h3>Emergency Contact</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="emergencyName">Emergency Contact Name *</label>
                <input type="text" id="emergencyName" name="emergencyName" required>
              </div>
              <div class="form-group">
                <label for="emergencyRelation">Relationship *</label>
                <input type="text" id="emergencyRelation" name="emergencyRelation" placeholder="e.g., Parent, Guardian, Sibling" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="emergencyPhone">Emergency Contact Phone *</label>
                <input type="tel" id="emergencyPhone" name="emergencyPhone" placeholder="e.g., 07722440395 or +447722440395" required>
              </div>
              <div class="form-group">
                <label for="emergencyEmail">Emergency Contact Email</label>
                <input type="email" id="emergencyEmail" name="emergencyEmail">
              </div>
            </div>
          </div>

          <!-- Terms and Conditions -->
          <div class="form-section">
            <h3>Terms & Conditions</h3>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" name="agreeTerms" required>
                <span class="checkmark"></span>
                I agree to the <a href="/policies" target="_blank">Terms and Conditions</a> of iLm Halal Student Halls *
              </label>
            </div>
            
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" name="agreePrivacy" required>
                <span class="checkmark"></span>
                I agree to the <a href="/policies" target="_blank">Privacy Policy</a> and consent to data processing *
              </label>
            </div>
            
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" name="agreeHalalPolicy" required>
                <span class="checkmark"></span>
                I understand and agree to respect the halal environment and community guidelines *
              </label>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="form-submit">
            <!-- Admin Test Data Button (hidden by default) -->
            <button type="button" id="fillTestDataBtn" class="fill-test-data-btn" style="display: none;">
              🧪 Fill Test Data
            </button>
            
            <button type="submit" class="submit-booking-btn">
              <span class="btn-text">Submit Booking Application</span>
              <span class="btn-loading" style="display: none;">Processing...</span>
            </button>
            <p class="form-note">By submitting this form, you are applying for accommodation. We will review your application and contact you within 48 hours.</p>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="footer-main">
      <div class="container footer-grid">
        <div class="footer-col">
          <a href="/" class="logo">
            <span class="logo-icon">
              <img src="https://res.cloudinary.com/dq8l3fhb2/image/upload/v1748189839/473148050_10160452160655951_3047339032063400229_n_gnkdpz.jpg" alt="iLm Halal Student Halls Logo">
            </span>
            <span class="logo-text">iLm Halal Student Halls</span>
          </a>
          <p class="footer-desc">A premium student accommodation offering a safe, inclusive halal environment for living and learning.</p>
        </div>
        
        <div class="footer-col">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="index.html#about">About Us</a></li>
            <li><a href="index.html#contact">Contact Us</a></li>
            <li><a href="/policies">Data Protection & Policies</a></li>
            <li><a href="/sitemap">Site Map</a></li>
          </ul>
        </div>
        
        <div class="footer-col">
          <h4>Contact Info</h4>
          <div class="contact-info-simple">
            <div class="contact-info-item">
              <span class="contact-icon">📍</span>
              <span>Rose House, 16-18 Constitution Terrace, Dundee DD3 6JE</span>
            </div>
            <div class="contact-info-item">
              <span class="contact-icon">📧</span>
              <a href="mailto:RoseHouse.ilm@outlook.com">RoseHouse.ilm@outlook.com</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="footer-bottom">
      <div class="container">
        © 2025 iLm Halal Student Halls. All rights reserved.
      </div>
    </div>
  </footer>

  <script>
    // reCAPTCHA v2 Invisible Integration
    let recaptchaToken = null;
    let formSubmissionPending = false;
    let recaptchaWidgetId = null;
    
    // Initialize reCAPTCHA when page loads
    function onRecaptchaLoad() {
      try {
        recaptchaWidgetId = grecaptcha.render('recaptcha-container', {
          'sitekey': '6Le3cWwrAAAAAJnRkew5cCAM3gSxSMh5abD53t8S',
          'callback': onRecaptchaSuccess,
          'size': 'invisible'
        });
        console.log('reCAPTCHA widget initialized');
      } catch (error) {
        console.error('reCAPTCHA initialization error:', error);
      }
    }
    
    // Callback when reCAPTCHA is successfully completed
    function onRecaptchaSuccess(token) {
      recaptchaToken = token;
      console.log('reCAPTCHA verified successfully');
      
      // If form submission was pending, proceed with it
      if (formSubmissionPending) {
        formSubmissionPending = false;
        proceedWithFormSubmission();
      }
    }
    
    // Enhanced form submission with reCAPTCHA
    function proceedWithFormSubmission() {
      const form = document.getElementById('bookingForm');
      const submitBtn = form.querySelector('.submit-booking-btn');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnLoading = submitBtn.querySelector('.btn-loading');
      
      if (!recaptchaToken) {
        showFormError('reCAPTCHA verification failed. Please try again.');
        resetSubmitButton();
        return;
      }
      
      // Add reCAPTCHA token to form data
      const recaptchaInput = document.createElement('input');
      recaptchaInput.type = 'hidden';
      recaptchaInput.name = 'recaptchaToken';
      recaptchaInput.value = recaptchaToken;
      form.appendChild(recaptchaInput);
      
      // Continue with normal form submission
      submitBookingFormWithRecaptcha(form, resetSubmitButton);
    }
    
    function resetSubmitButton() {
      const form = document.getElementById('bookingForm');
      const submitBtn = form.querySelector('.submit-booking-btn');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnLoading = submitBtn.querySelector('.btn-loading');
      
      if (submitBtn && btnText && btnLoading) {
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
      }
    }
    
    async function submitBookingFormWithRecaptcha(form, resetButton) {
      try {
        const formData = new FormData(form);
        
        // Convert FormData to regular object for JSON submission
        const data = {};
        for (let [key, value] of formData.entries()) {
          // Handle checkboxes specially
          if (value === 'on') {
            data[key] = 'yes';
          } else {
            data[key] = value;
          }
        }
        
        // Include reCAPTCHA token
        data.recaptchaToken = recaptchaToken;
        
        // Check if form has action URL
        if (!form.action) {
          throw new Error('Form action URL not specified');
        }
        
        // Submit to Supabase Edge Function with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        // Get Supabase anon key for authentication
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ybmJmZXZsYmFrdmRlYXN3YmJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MTIzODgsImV4cCI6MjA2NDM4ODM4OH0.3V7rTYNwxSsKA0etRgNgxvUgoULmqvppVtmSY9Hzr3M';
        
        const response = await fetch(form.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': supabaseAnonKey,
            'Authorization': `Bearer ${supabaseAnonKey}`
          },
          body: JSON.stringify(data),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const responseData = await response.json();
        
        if (response.ok && responseData.applicationId) {
          // Store the application ID for the success page
          sessionStorage.setItem('lastApplicationId', responseData.applicationId);
          
          // Reset reCAPTCHA for next use
          if (recaptchaWidgetId !== null) {
            try {
              grecaptcha.reset(recaptchaWidgetId);
              recaptchaToken = null;
            } catch (error) {
              console.log('reCAPTCHA reset failed:', error);
            }
          }
          
          // Redirect to success page
          window.location.href = `/booking-success.html?id=${responseData.applicationId}`;
        } else {
          throw new Error(responseData.error || 'Submission failed. Please check your details and try again.');
        }
        
      } catch (error) {
        console.error('Submission error:', error);
        resetButton();
        
        // Reset reCAPTCHA on error
        if (recaptchaWidgetId !== null) {
          try {
            grecaptcha.reset(recaptchaWidgetId);
            recaptchaToken = null;
          } catch (resetError) {
            console.log('reCAPTCHA reset failed:', resetError);
          }
        }
        
        if (error.name === 'AbortError') {
          showFormError('Request timed out. Please check your connection and try again.');
        } else {
          const errorMessage = error.message || 'An error occurred while submitting your application';
          window.location.href = `/error?error=${encodeURIComponent(errorMessage)}`;
        }
      }
    }
    
    function showFormError(message) {
      // Remove existing error
      const existingError = document.querySelector('.form-error-message');
      if (existingError) {
        existingError.remove();
      }
      
      // Create new error message
      const errorDiv = document.createElement('div');
      errorDiv.className = 'form-error-message';
      errorDiv.innerHTML = `
        <div class="error-content">
          <span class="error-icon">⚠️</span>
          <span>${message}</span>
        </div>
      `;
      
      // Insert before submit button
      const submitSection = document.querySelector('.form-submit');
      submitSection.parentNode.insertBefore(errorDiv, submitSection);
      
      // Scroll to error
      errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.remove();
        }
      }, 5000);
    }
    
    // Override the existing form submission to use reCAPTCHA
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('bookingForm');
      if (form) {
        // Remove existing event listeners and add new one
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        
        newForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const submitBtn = newForm.querySelector('.submit-booking-btn');
          const btnText = submitBtn.querySelector('.btn-text');
          const btnLoading = submitBtn.querySelector('.btn-loading');
          
          if (!submitBtn || !btnText || !btnLoading) {
            console.error('Submit button elements not found');
            return;
          }
          
          // Prevent double submission
          if (submitBtn.disabled) {
            return;
          }
          
          submitBtn.disabled = true;
          btnText.style.display = 'none';
          btnLoading.style.display = 'inline';
          
          // Basic spam detection (honeypot)
          const website = newForm.querySelector('input[name="website"]');
          if (website && website.value.trim() !== '') {
            resetSubmitButton();
            showFormError('Security check failed. Please try again or contact us directly.');
            return;
          }
          
          // Validate required fields
          const missingFields = validateBookingForm(newForm);
          if (missingFields.length > 0) {
            resetSubmitButton();
            showFormError('Please fill in all required fields: ' + missingFields.join(', '));
            return;
          }
          
          // Check if reCAPTCHA is already verified
          if (recaptchaToken) {
            proceedWithFormSubmission();
          } else {
            // Trigger reCAPTCHA verification
            formSubmissionPending = true;
            try {
              if (recaptchaWidgetId !== null) {
                grecaptcha.execute(recaptchaWidgetId);
              } else {
                throw new Error('reCAPTCHA widget not initialized');
              }
            } catch (error) {
              console.error('reCAPTCHA error:', error);
              resetSubmitButton();
              showFormError('reCAPTCHA verification failed. Please refresh the page and try again.');
            }
          }
        });
      }
    });
    
    function validateBookingForm(form) {
      const missingFields = [];
      
      // Check all required fields
      const requiredFields = form.querySelectorAll('[required]');
      requiredFields.forEach(field => {
        if (!field.value.trim()) {
          const label = form.querySelector(`label[for="${field.id}"]`);
          const fieldName = label ? label.textContent.replace('*', '').trim() : field.name;
          missingFields.push(fieldName);
        }
      });
      
      return missingFields;
    }
  </script>
  
  <script src="app.js"></script>
</body>
</html> 